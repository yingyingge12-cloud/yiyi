<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>koko小手机</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap');

        :root {
            --theme-primary: #81c784;
            --theme-primary-hover: #66bb6a;
            --theme-secondary: #aed581;
            --sent-message-bg: #e6f5c9;
            --background-start: #f1f8e9;
            --background-end: #ffffff;
            --text-on-primary: #ffffff;
            --text-dark: #424242;
            --text-gray: #757575;
            --soft-red: #ff8a80;
            --border-color: #e8e8e8;
            --shadow-color: rgba(129, 199, 132, 0.12);
            --soft-radius: 16px;
            --card-background: rgba(255, 255, 255, 0.7);
        }
        
       /* --- 您新增的叙事模式美化样式 --- */
.narrative-speech {
    background-color: #e6f5c9; /* 清新的青苹果色背景 (来自您已有的 --sent-message-bg 变量) */
    padding: 2px 8px;
    border-radius: 8px;
    display: inline-block;
    margin: 1px 0;
}

.narrative-psychology {
    text-decoration: none; /* 去掉下划线 */
    background-color: #e6f5c9; /* 浅绿色背景 (复用已有变量 --sent-message-bg) */
    color: #66bb6a; /* 青苹果绿字体 (复用已有变量 --theme-primary-hover) */
    padding: 2px 6px; /* 增加一点内边距，让背景更好看 */
    border-radius: 6px; /* 增加圆角 */
    font-style: normal; /* 也可以加一点斜体来区分 */
}

.narrative-action {
    font-style: normal;
    color: #517655; /* 深一点的青苹果色 (来自您已有的 --theme-primary-hover 变量) */
} 
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    /* ↓↓↓ 就是修改这一行 ↓↓↓ */
    font-family: var(--main-font, 'Nunito', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif);
}
        
        body {
            background-image: linear-gradient(to bottom, var(--background-start), var(--background-end));
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        #app-container, #screen {
            width: 100%;
            height: 100%;
            background-color: transparent;
        }
        
        #screen {
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 5px 25px var(--shadow-color);
        }
        
        .chat-header {
            background-color: rgba(129, 199, 132, 0.75);
            backdrop-filter: blur(12px);
            color: var(--text-on-primary);
            padding: 8px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
            flex-shrink: 0;
        }

        .chat-header .back-btn,
        .chat-header .action-btn {
            color: var(--text-on-primary);
            margin-left: 5px;
        }

        .app-header, .world-book-header, .api-header, .moments-header, .discover-header, .contact-settings-header {
            background-color: rgba(220, 237, 200, 0.7);
            backdrop-filter: blur(12px);
            color: var(--text-dark);
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: none;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            z-index: 10;
            flex-shrink: 0;
        }
        
        .chat-input-area {
            background-color: #f8f9fa;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
            position: relative;
        }
        
        #message-input {
            flex-grow: 1;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 15px;
            outline: none;
            resize: none;
            max-height: 100px;
            overflow-y: auto;
            align-self: flex-end;
            min-height: 38px;
        }

        .input-action-btn {
            border: none;
            border-radius: 50%;
            width: 38px;
            height: 38px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-left: 8px;
            cursor: pointer;
            font-size: 18px;
            flex-shrink: 0;
            transition: transform 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            align-self: flex-end;
        }
        .input-action-btn:hover {
            transform: scale(1.1);
        }

        #send-btn {
            background-color: var(--theme-primary);
            color: var(--text-on-primary);
            width: auto;
            padding: 0 18px;
            border-radius: 22px;
        }
        #send-btn .fa-paper-plane {
            font-size: 18px;
        }

        #request-reply-btn {
            background-color: var(--theme-secondary);
            color: var(--text-on-primary);
        }
        
        #chat-screen {
            background-image: url('https://i.postimg.cc/SQ3DH79X/MEITU-20250811-151831796.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
        }
        
        #main-screen { height: 100%; display: flex; flex-direction: column; }
        .app-title { font-size: 20px; font-weight: 700; }
        .contacts-container { flex-grow: 1; overflow-y: auto; padding: 10px 0; }
        .section-title { padding: 10px 15px; font-size: 14px; color: var(--text-gray); background-color: transparent; font-weight: 600; }
        .contact-item { display: flex; align-items: center; padding: 12px 15px; background-color: transparent; border-bottom: 1px solid var(--border-color); border-radius: var(--soft-radius); margin: 0 8px 4px; cursor: pointer; transition: background-color 0.2s; }
        .contact-item:hover { background-color: rgba(255, 255, 255, 0.7); }
        .contact-avatar { width: 50px; height: 50px; border-radius: 50%; background-color: #ddd; margin-right: 15px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: var(--text-gray); overflow: hidden; flex-shrink: 0; }
        .contact-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .contact-info { flex-grow: 1; min-width: 0; }
        .contact-name { font-weight: 600; margin-bottom: 3px; color: var(--text-dark); }
        .contact-last-message { font-size: 14px; color: var(--text-gray); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .contact-time { font-size: 12px; color: #999; margin-top: 5px; }
        .unread-count { background-color: var(--theme-primary); color: var(--text-on-primary); font-size: 12px; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-left: 10px; }
        .bottom-nav { display: flex; background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border-top: 1px solid var(--border-color); padding: 10px 0; flex-shrink: 0; }
        .nav-item { flex: 1; text-align: center; color: var(--text-gray); font-size: 14px; cursor: pointer; transition: color 0.2s, transform 0.2s; }
        .nav-item-content { position: relative; display: inline-block; }
        .nav-item.active { color: var(--theme-primary); transform: scale(1.1); }
        .nav-icon { font-size: 20px; margin-bottom: 5px; }
        .notification-dot { position: absolute; top: -2px; right: -8px; width: 8px; height: 8px; background-color: var(--soft-red); border-radius: 50%; border: 1px solid white; display: none; }
        .back-btn { font-size: 24px; cursor: pointer; margin-right: 15px; }
        .chat-info { flex-grow: 1; text-align: center; }
        .chat-name { font-weight: 700; font-size: 18px; }
        .chat-status { font-size: 13px; opacity: 0.8; }
        .chat-messages { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; }
        #load-more-messages { background-color: #e0e0e0; color: #555; border: none; padding: 8px 15px; border-radius: 15px; cursor: pointer; margin: 0 auto 15px; font-size: 13px; display: none; }
        #load-more-messages:hover { background-color: #d1d1d1; }
        .message-wrapper { display: flex; max-width: 85%; margin-bottom: 2px; position: relative; }
        .message-wrapper.received { align-self: flex-start; flex-direction: row; }
        .message-wrapper.sent { align-self: flex-end; flex-direction: row-reverse; }
        .message-avatar { width: 40px; height: 40px; border-radius: 6px; flex-shrink: 0; visibility: hidden; }
        .is-first-in-sequence .message-avatar { visibility: visible; margin-top: 10px; }
        .message-avatar img { width: 100%; height: 100%; border-radius: 6px; object-fit: cover; }
        .message-body { display: flex; flex-direction: column; margin: 0 10px; }
        .message-wrapper.sent .message-body { align-items: flex-end; }
        .message-wrapper.received .message-body { align-items: flex-start; }
        .message-author-name { font-size: 13px; color: #888; margin-bottom: 4px; display: none; }
        .is-first-in-sequence .message-author-name { display: block; margin-top: 10px;}
        .message { padding: 10px 18px; border-radius: 22px; position: relative; animation: fadeIn 0.3s ease; word-wrap: break-word; min-width: 50px; box-shadow: 0 2px 4px var(--shadow-color); font-size: 14px;}
        .message-timestamp { font-size: 11px; color: #aaa; margin-top: 4px; padding: 0 5px; }
        .message-wrapper.selected .message, .message-wrapper.selected .message.red-packet, .message-wrapper.selected .message.voice, .message-wrapper.selected .message.picture-description { background-color: #bde0fe !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.received { background-color: white; border-top-left-radius: 4px; }
        .message.sent { background-color: var(--sent-message-bg); border-top-right-radius: 4px; }
        .message-image-container { padding: 5px; background-color: inherit; border-radius: inherit; }
        .message-image { max-width: 150px; max-height: 150px; border-radius: 12px; display: block; cursor: default; }
        .message-image-container.sent { border-top-right-radius: 4px; }
        .message-image-container.received { border-top-left-radius: 4px; }
        .message.image-message { padding: 0; background-color: transparent; box-shadow: none; }
        .emoji-btn, .attachment-btn { font-size: 22px; margin-right: 10px; cursor: pointer; color: var(--text-gray); align-self: flex-end; margin-bottom: 10px; }
        .attachment-btn { background: none; border: none; padding: 0; }
        #edit-mode-bar, #moments-edit-mode-bar { display: none; padding: 10px 15px; background-color: #f0f0f0; border-top: 1px solid #ddd; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .edit-action-btn { padding: 8px 16px; border-radius: 20px; border: none; font-size: 14px; cursor: pointer; }
        #delete-selected-btn, #delete-selected-moments-btn { background-color: var(--soft-red); color: white; }
        #cancel-edit-btn, #cancel-moments-edit-btn { background-color: #bdc3c7; color: #333; }
        #profile-screen, #char-profile-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: transparent; display: none; flex-direction: column; }
        
        .profile-header {
            background-image: linear-gradient(135deg, var(--sent-message-bg), #dcedc8);
            padding: 30px 20px 15px;
            text-align: center;
            color: var(--text-dark);
            position: relative;
            flex-shrink: 0;
        }
        .avatar-container {
            position: relative;
            margin: 0 auto 15px;
            width: 100px;
            height: 100px;
        }
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .change-avatar-btn {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: rgba(255, 255, 255, 0.7);
            color: var(--text-dark);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .profile-name { font-size: 22px; font-weight: 700; margin-bottom: 5px; }
        .profile-status { font-size: 16px; opacity: 0.9; }
        .profile-actions { display: flex; justify-content: center; gap: 20px; padding: 10px 0; background-color: white; border-bottom: 1px solid #eee; flex-shrink: 0; }
        .action-item { text-align: center; cursor: pointer; }
        .action-icon { width: 50px; height: 50px; border-radius: 50%; background-color: #f0f2f5; display: flex; align-items: center; justify-content: center; font-size: 24px; color: var(--theme-primary); margin: 0 auto 10px; transition: all 0.3s; }
        .action-icon:hover { background-color: #e0f2f1; transform: scale(1.05); }
        .action-label { font-size: 14px; color: var(--text-gray); }
        .profile-details { flex-grow: 1; overflow-y: auto; padding: 10px; background-color: #f0f2f5; }
        .detail-item { padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background-color: white; }
        .detail-item:last-child { border-bottom: none; }
        .discover-section .detail-item { border-radius: 0; margin-bottom: 0; }
        .discover-section .detail-item:first-child { border-top-left-radius: var(--soft-radius); border-top-right-radius: var(--soft-radius); }
        .discover-section .detail-item:last-child { border-bottom-left-radius: var(--soft-radius); border-bottom-right-radius: var(--soft-radius); border-bottom: none; }
        .detail-label { font-size: 16px; color: #333; font-weight: 600; }
        .detail-value { font-size: 16px; color: var(--text-gray); max-width: 60%; text-align: right; overflow: hidden; text-overflow: ellipsis; }
        .edit-btn { color: var(--theme-primary); font-size: 18px; cursor: pointer; padding: 5px; }
        #discover-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: transparent; display: none; flex-direction: column; }
        .discover-title { font-size: 20px; font-weight: 700; flex-grow: 1; text-align: center; margin-left: 0; }
        .discover-content { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .discover-section { background-color: var(--card-background); border-radius: var(--soft-radius); box-shadow: 0 4px 12px var(--shadow-color); border: 1px solid white; margin-bottom: 20px;}
        .discover-item { padding: 15px; display: flex; align-items: center; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s; background-color: transparent; }
        .discover-item:last-child { border-bottom: none; }
        .discover-item:hover { background-color: rgba(255,255,255,0.5); }
        .discover-icon { width: 40px; height: 40px; border-radius: 8px; background-color: #f0f2f5; display: flex; align-items: center; justify-content: center; font-size: 20px; color: var(--theme-primary); margin-right: 15px; }
        .discover-info { flex-grow: 1; }
        .discover-name { font-weight: 600; margin-bottom: 3px; }
        .discover-desc { font-size: 14px; color: var(--text-gray); }
        .discover-arrow { color: #999; font-size: 18px; }
        #world-book-screen, #api-settings-screen, #contact-settings-screen, #moments-screen, #diary-screen, #emoticon-library-screen, .preset-management-screen, #post-detail-screen, #trending-topic-screen, #square-api-settings-screen, #memory-album-screen, #music-library-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: transparent; display: none; flex-direction: column; }
        .world-book-content, .api-content, .contact-settings-content, .emoticon-library-content { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .world-book-list { display: flex; flex-direction: column; gap: 15px; }
        .world-book-item { background-color: white; border-radius: var(--soft-radius); box-shadow: 0 4px 12px var(--shadow-color); border: 1px solid white; margin-bottom: 20px; padding: 15px; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease;}
        .world-book-item:hover { transform: translateY(-3px); box-shadow: 0 6px 12px var(--shadow-color); }
        .book-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #f0f0f0; }
        .book-name { font-weight: 600; font-size: 18px; }
        .book-content { color: var(--text-gray); line-height: 1.5; white-space: pre-wrap; word-break: break-all; }
        .api-title { font-size: 20px; font-weight: 600; margin-left: 15px; }
        .form-group { background-color: white; border-radius: var(--soft-radius); box-shadow: 0 4px 12px var(--shadow-color); border: 1px solid white; margin-bottom: 20px; padding: 15px;}
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-gray); }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .form-input:focus { outline: none; border-color: var(--theme-primary); }
        .form-button { width: 100%; padding: 15px; background-color: var(--theme-primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .form-group-inline { display: flex; align-items: center; gap: 10px; }
        .form-group-inline .form-input { flex-grow: 1; }
        #fetch-models-btn, #fetch-square-models-btn { padding: 10px 15px; background-color: var(--theme-primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; flex-shrink: 0; }
        #add-world-book-modal, #post-moment-modal, #user-persona-preset-modal, #thought-preset-modal, #add-emoticon-modal, #automation-modal, #send-red-packet-modal, #send-transfer-modal, #send-voice-modal, #send-picture-modal, #add-music-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background-color: white; width: 90%; max-width: 400px; border-radius: var(--soft-radius); overflow: hidden; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); animation: modalIn 0.3s ease; }
        @keyframes modalIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { background-color: var(--theme-primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 18px; font-weight: 600; }
        .close-btn { font-size: 24px; cursor: pointer; }
        .modal-body { padding: 20px; }
        .form-textarea { width: 100%; height: 150px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical; }
        .form-textarea:focus { outline: none; border-color: var(--theme-primary); }
        .form-button:hover { background-color: var(--theme-primary-hover); }
        #add-contact-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 100; }
        .contact-form-group { margin-bottom: 20px; }
        .contact-form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-gray); }
        .contact-form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .contact-form-input:focus { outline: none; border-color: var(--theme-primary); }
        .contact-form-textarea { width: 100%; height: 100px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical; }
        .contact-form-textarea:focus { outline: none; border-color: var(--theme-primary); }
        .contact-form-select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; background-color: white; }
        .contact-form-select:focus { outline: none; border-color: var(--theme-primary); }
        .mask-editor, .world-book-selector { background-color: white; border-radius: var(--soft-radius); box-shadow: 0 4px 12px var(--shadow-color); border: 1px solid white; margin-bottom: 20px; padding: 15px;}
        .mask-editor-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: var(--theme-primary); }
        .mask-editor-group { margin-bottom: 15px; }
        .mask-editor-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-gray); }
        .mask-editor-textarea { width: 100%; height: 150px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical; }
        .mask-editor-textarea:focus { outline: none; border-color: var(--theme-primary); }
        .world-book-selector-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: var(--theme-primary); }
        .world-book-selector .world-book-list { max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 10px; }
        #world-book-selector-list .world-book-item { padding: 10px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; }
        .world-book-checkbox { margin-right: 10px; }
        .world-book-name { font-weight: 500; }
        .save-settings-btn { width: 100%; padding: 15px; background-color: var(--theme-primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .user-mask-editor { background-color: white; border-radius: var(--soft-radius); box-shadow: 0 4px 12px var(--shadow-color); border: 1px solid white; margin-bottom: 20px; padding: 15px;}
        .user-mask-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: var(--theme-primary); }
        .user-mask-textarea { width: 100%; height: 150px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical; }
        .user-mask-textarea:focus { outline: none; border-color: var(--theme-primary); }
        
        /* --- V7.0 新增: 一起听歌卡片样式 --- */
.message.music-share-card {
    background-color: #f3f4f6;
    color: #333;
    width: 260px;
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: default;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.message.sent.music-share-card { background-color: var(--sent-message-bg); }
.music-card-cover {
    width: 60px;
    height: 60px;
    background-color: #555;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 28px;
    flex-shrink: 0;
    position: relative;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    animation: spin 8s linear infinite;
    animation-play-state: paused; /* 默认暂停 */
}
.music-card-cover.playing {
    animation-play-state: running; /* 播放时旋转 */
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
.music-card-play-btn {
    position: absolute;
    color: rgba(255, 255, 255, 0.8);
    font-size: 20px;
    cursor: pointer;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}
.music-card-info {
    flex-grow: 1;
    min-width: 0;
}
.music-card-title {
    font-weight: 600;
    font-size: 15px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.music-card-artist {
    font-size: 13px;
    color: var(--text-gray);
    margin-top: 2px;
}
.music-card-progress-bar {
    width: 100%;
    height: 3px;
    background-color: #ddd;
    border-radius: 3px;
    margin-top: 8px;
    overflow: hidden;
}
.music-card-progress {
    width: 0%;
    height: 100%;
    background-color: var(--theme-primary);
}
.music-card-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: #999;
    margin-top: 5px;
}
.music-card-loop-btn {
    cursor: pointer;
    font-size: 14px;
}
/* --- V7.0 新增: 小窝相册新样式 --- */
.album-section {
    background-color: white;
    border-radius: 12px;
    padding: 15px 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px var(--shadow-color);
}
.album-section-title {
    font-size: 18px;
    font-weight: bold;
    color: var(--theme-primary);
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #f0f0f0;
}
.album-milestone-item, .album-stat-item {
    display: flex;
    align-items: center;
    padding: 10px 0;
    font-size: 16px;
}
.album-item-icon {
    width: 30px;
    text-align: center;
    margin-right: 15px;
    color: var(--text-gray);
}
.album-item-label { color: #333; }
.album-item-value {
    margin-left: auto;
    font-weight: 600;
    color: var(--text-dark);
}
.album-memory-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 10px;
}
.album-memory-item {
    background-color: #f9f9f9;
    border-radius: 8px;
    padding: 10px;
    font-size: 14px;
    line-height: 1.5;
    border: 1px solid #eee;
    cursor: pointer;
}
.album-memory-item .fas {
    margin-right: 5px;
    color: var(--theme-secondary);
}
        
        /* ---论坛/微博 样式--- */
        .moments-header .back-btn { font-size: 24px; cursor: pointer; position: relative; z-index: 1; }
        .moments-header .action-btn { font-size: 20px; }
        .header-actions { display: flex; gap: 20px; position: relative; z-index: 1; }
        .moments-content { flex-grow: 1; overflow-y: auto; background-color: #f0f2f5; }
        .mention {
    color: var(--theme-primary);
    font-weight: 600;
    cursor: pointer;
}
.mention:hover {
    text-decoration: underline;
}
        .feed-tabs { display: flex; justify-content: space-around; padding: 0 10px; background-color: #e8f5e9; flex-shrink: 0; }
        .feed-tab-btn { flex: 1; padding: 12px 0; font-size: 16px; font-weight: 600; color: var(--text-gray); border: none; background: none; cursor: pointer; position: relative; transition: color 0.3s; }
        .feed-tab-btn.active { color: var(--theme-primary); }
        .feed-tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 10%; right: 10%; height: 3px; background-color: var(--theme-primary); border-radius: 3px; }

        .feed-sub-tabs { display: flex; justify-content: center; gap: 15px; padding: 8px 10px; background-color: #fafafa; flex-shrink: 0; border-bottom: 1px solid #eee; }
        .feed-sub-tab-btn { padding: 6px 14px; font-size: 14px; font-weight: 500; color: var(--text-gray); border: 1px solid #ddd; background-color: white; border-radius: 18px; cursor: pointer; transition: all 0.3s; }
        .feed-sub-tab-btn.active { color: white; background-color: var(--theme-primary); border-color: var(--theme-primary); }

        .posts-list { padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .post-item { position: relative; display: flex; padding: 15px; gap: 12px; background-color: white; border-radius: var(--soft-radius); box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer;}
        .post-delete-btn { position: absolute; top: 10px; right: 10px; width: 28px; height: 28px; background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(5px); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--text-gray); font-size: 14px; cursor: pointer; z-index: 2; transition: all 0.2s; }
        .post-delete-btn:hover { background-color: var(--soft-red); color: white; }

        .post-item-avatar img { width: 45px; height: 45px; border-radius: 50%; flex-shrink: 0; }
        .post-content-area { flex-grow: 1; display: flex; flex-direction: column; gap: 8px; min-width: 0; }
        .post-author-name { font-weight: 700; color: var(--text-dark); }
        .post-author-handle { font-size: 14px; color: var(--text-gray); margin-left: 8px; }
        .post-text { line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; font-size: 15px; }
        .post-meta { color: #999; font-size: 13px; }
        .post-actions { display: flex; justify-content: space-between; align-items: center; color: var(--text-gray); font-size: 14px; margin-top: 12px; padding-top: 8px; border-top: 1px solid #f0f0f0; }
        .post-action-btn { cursor: pointer; display: flex; align-items: center; gap: 6px; transition: color 0.2s; }
        .post-action-btn:hover, .post-action-btn.liked { color: var(--theme-primary); }
        .post-action-btn.liked .fa-heart { font-weight: 900; }
        .post-action-btn i { font-size: 16px; }

        .post-comments { background-color: #f7f9f9; border-radius: 10px; padding: 10px; font-size: 14px; display: flex; flex-direction: column; gap: 8px; margin-top: 5px; }
        .post-comments:empty { display: none; }
        
        .comment-delete-btn { color: var(--text-gray); font-size: 12px; cursor: pointer; opacity: 0; transition: all 0.2s; }
        .comment-delete-btn:hover { color: var(--soft-red); }
        .post-comment-item:hover .comment-delete-btn { opacity: 1; }

        .post-comment-item { line-height: 1.5; padding: 8px 0; border-bottom: 1px solid #eee; }
        .post-comment-item:last-child { border-bottom: none; }
        .comment-author { font-weight: 600; color: var(--theme-primary); margin-right: 5px; cursor: pointer; }
        .comment-content { color: var(--text-dark); }
        .comment-meta { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--text-gray); margin-top: 4px; }
        .comment-reply-to { background-color: #e9e9e9; padding: 4px 8px; border-radius: 8px; font-size: 13px; margin-left: 5px; }
        /* --- 新增：用于在帖子中显示作者签名 --- */
.post-author-signature {
    font-size: 13px;
    color: var(--text-gray);
    margin-top: 4px; /* 与昵称拉开一点距离 */
    padding-bottom: 8px; /* 与帖子正文拉开一点距离 */
    white-space: pre-wrap; /* 允许签名中的换行 */
    word-break: break-word;
}


        /* 热搜榜样式 */
        .trending-list { list-style: none; padding: 10px; background-color: white;}
        .trending-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .trending-item:hover { background-color: #f9f9f9; }
        .trending-item:last-child { border-bottom: none; }
        .trending-rank { font-size: 18px; font-weight: bold; color: var(--text-gray); width: 40px; text-align: center; }
        .trending-rank.top-3 { color: var(--soft-red); }
        .trending-info { flex-grow: 1; }
        .trending-title { font-size: 16px; font-weight: 600; color: var(--text-dark); margin-bottom: 4px; }
        .trending-meta { font-size: 13px; color: var(--text-gray); }
        .trending-tag { background-color: #ffcdd2; color: #c62828; font-size: 11px; padding: 2px 6px; border-radius: 5px; margin-left: 8px; font-weight: bold; }
        
        #post-detail-screen { background-color: #f0f2f5; }
        .post-detail-content { flex-grow: 1; overflow-y: auto; }
        #post-detail-container { padding: 0; }
        #post-detail-container .post-item { cursor: default; }
        .comments-section { padding: 15px; background-color: #f0f2f5; }
        .comments-title { font-size: 16px; font-weight: 700; color: var(--text-dark); padding-bottom: 10px; border-bottom: 1px solid #ddd; margin-bottom: 10px; }
        .comment-input-area { display: flex; padding: 10px 15px; background-color: white; border-top: 1px solid #ddd; flex-shrink: 0; }
        #comment-input { flex-grow: 1; border: 1px solid #ddd; border-radius: 18px; padding: 8px 15px; font-size: 15px; resize: none; }
        #submit-comment-btn { background-color: var(--theme-primary); color: white; border: none; border-radius: 18px; padding: 8px 20px; margin-left: 10px; font-weight: 600; cursor: pointer; }
        
        .diary-entry {
            position: relative;
            background-color: white;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        
        .diary-content { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .diary-entry-meta { font-size: 12px; color: #999; margin-bottom: 10px; }
        .diary-entry-content { font-size: 16px; line-height: 1.6; color: #333; }
        .diary-delete-btn { position: absolute; top: 15px; right: 15px; font-size: 18px; color: #aaa; cursor: pointer; transition: color 0.2s ease; }
        .diary-delete-btn:hover { color: var(--soft-red); }
        .preset-list { display: flex; flex-direction: column; gap: 10px; padding: 15px 20px; }
        .preset-item { background-color: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); display: flex; justify-content: space-between; align-items: center; }
        .preset-info { flex-grow: 1; cursor: pointer; min-width: 0; margin-right: 10px; }
        .preset-name { font-weight: 500; font-size: 16px; color: #333; margin-bottom: 5px; }
        .preset-desc { font-size: 13px; color: var(--text-gray); overflow: hidden; text-overflow: ellipsis; white-space: pre-wrap; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }
        .preset-actions { display: flex; gap: 10px; flex-shrink: 0; }
        .preset-action-btn { font-size: 18px; color: #999; cursor: pointer; padding: 5px; }
        .preset-action-btn:hover { color: var(--theme-primary); }
        .preset-action-btn.delete:hover { color: var(--soft-red); }
        .emoticon-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; }
        .emoticon-item { background-color: #fff; border-radius: 8px; padding: 8px; box-shadow: 0 1px 3px var(--shadow-color); position: relative; display: flex; flex-direction: column; align-items: center; justify-content: space-between; }
        .emoticon-item img { max-width: 100%; height: 60px; object-fit: contain; margin-bottom: 5px; }
        .emoticon-name { font-size: 12px; color: #333; text-align: center; word-break: break-all; }
        .emoticon-delete-btn { position: absolute; top: -5px; right: -5px; background-color: var(--soft-red); color: white; width: 20px; height: 20px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; line-height: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        #emoticon-picker { position: absolute; bottom: 65px; left: 10px; right: 10px; background-color: #fff; border: 1px solid #ddd; border-radius: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); max-height: 250px; overflow-y: auto; padding: 10px; display: none; z-index: 50; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; }
        #emoticon-picker.active { display: grid; }
        #emoticon-picker .emoticon-item { cursor: pointer; transition: transform 0.2s; }
        #emoticon-picker .emoticon-item:hover { transform: scale(1.1); }
        #emoticon-picker .emoticon-delete-btn { display: none; }
        
        /* --- 音乐库新增样式 --- */
        #music-library-list { display: flex; flex-direction: column; gap: 10px; }
        .music-item { background-color: white; border-radius: 8px; padding: 12px 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 3px var(--shadow-color); }
        .music-info { flex-grow: 1; }
        .music-title { font-weight: 600; color: #333; }
        .music-artist { font-size: 14px; color: var(--text-gray); margin-top: 3px; }
        .music-delete-btn { background: none; border: none; font-size: 16px; color: #aaa; cursor: pointer; padding: 5px; }
        .music-delete-btn:hover { color: var(--soft-red); }
        #music-library-picker .picker-title { font-weight: 600; color: var(--text-gray); margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        #music-library-picker .picker-list { max-height: 120px; overflow-y: auto; }
        #music-library-picker .picker-item { padding: 8px 5px; cursor: pointer; border-radius: 4px; }
        #music-library-picker .picker-item:hover { background-color: #f0f0f0; }

        #feed-status-indicator {
            padding: 10px;
            text-align: center;
            background-color: #e8f5e9;
            color: var(--text-gray);
            font-size: 14px;
            display: none;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            order: 1; /* 确保它在header下面 */
        }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: var(--theme-primary); }
        input:focus + .slider { box-shadow: 0 0 1px var(--theme-primary); }
        input:checked + .slider:before { transform: translateX(22px); }
        .slider.round { border-radius: 28px; }
        .slider.round:before { border-radius: 50%; }
        #attachment-menu { position: absolute; bottom: 65px; left: 10px; right: 10px; background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 12px; box-shadow: 0 -4px 15px rgba(0,0,0,0.1); padding: 15px; display: none; grid-template-columns: repeat(4, 1fr); gap: 15px; z-index: 50; transition: opacity 0.2s ease, transform 0.2s ease; transform: translateY(10px); opacity: 0; }
        #attachment-menu.active { display: grid; transform: translateY(0); opacity: 1; }
        .attachment-menu-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; text-align: center; }
        .attachment-menu-item .icon-wrapper { width: 60px; height: 60px; background-color: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px; color: #555; margin-bottom: 8px; border: 1px solid #eee; }
        .attachment-menu-item .label { font-size: 13px; color: var(--text-gray); }
        .attachment-menu-item:hover .icon-wrapper { background-color: #f0f0f0; }
        .system-notification { align-self: center; background-color: #e1e1e1; color: var(--text-gray); font-size: 12px; padding: 5px 12px; border-radius: 15px; margin: 10px 0; text-align: center; }
        .message.picture-description { display: flex; align-items: center; cursor: pointer; }
        .message.sent.picture-description { background-color: var(--sent-message-bg); }
        .message.received.picture-description { background-color: #fff; }
        .message.picture-description i { font-size: 20px; color: var(--text-gray); margin-right: 10px; }
        .message.picture-description span { color: #333; }
        .message.voice { display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .message.voice .fa-wifi { font-size: 20px; transform: rotate(90deg); color: var(--text-gray); }
        .message.sent.voice { background-color: var(--sent-message-bg); }
        .message.received.voice { background-color: #fff; }
        .message.sent.voice .fa-wifi { order: 2; margin-left: 15px; }
        .message.received.voice .fa-wifi { margin-right: 15px; }
        .voice-duration { color: var(--text-gray); }
        .transcribed-text { background-color: #fff; border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-top: 5px; font-size: 14px; color: #333; max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.3s ease-out, opacity 0.3s ease-out, margin-top 0.3s ease-out; }
        .transcribed-text.visible { max-height: 200px; opacity: 1; }
        .message.red-packet { background-color: #FFCC80; color: #5D4037; width: 240px; padding: 0; overflow: hidden; cursor: pointer; transition: background-color 0.3s, box-shadow 0.3s; box-shadow: 0 2px 5px rgba(255, 152, 0, 0.2); }
        .message.red-packet.opened { background-color: #FFF3E0; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05); }
        .message.red-packet .red-packet-header { padding: 10px 15px; display: flex; align-items: center; }
        .message.red-packet .red-packet-icon { font-size: 24px; margin-right: 10px; color: #FFA726; }
        .message.red-packet .red-packet-blessing { font-size: 15px; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }
        .message.red-packet .red-packet-status { font-size: 13px; opacity: 0.9; }
        .message.red-packet.opened .red-packet-icon, .message.red-packet.opened .red-packet-blessing, .message.red-packet.opened .red-packet-status { color: #BCAAA4; }
        .message.red-packet .red-packet-footer { background-color: transparent; color: #A1887F; font-size: 12px; padding: 5px 15px; border-top: 1px solid rgba(161, 136, 127, 0.2); }
        .message.red-packet.opened .red-packet-footer { color: #cebeba; border-top: 1px solid rgba(161, 136, 127, 0.1); }
        .message.sent.red-packet { border-top-right-radius: 0; }
        .message.received.red-packet { border-top-left-radius: 0; }
        .message.transfer { background-color: var(--theme-primary); color: white; width: 240px; padding: 0; overflow: hidden; position: relative; box-shadow: 0 2px 5px var(--shadow-color); }
        .message.transfer.completed { background-color: #C8E6C9; }
        .message.transfer.completed .transfer-info .transfer-text, .message.transfer.completed .transfer-info .transfer-amount { color: #388E3C; }
        .message.transfer.completed .transfer-icon i { color: var(--theme-primary-hover); }
        .message.transfer.completed::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 18px; color: var(--theme-primary-hover); }
        .message.transfer .transfer-header { padding: 10px 15px; display: flex; align-items: center; }
        .message.transfer .transfer-icon { font-size: 24px; margin-right: 10px; }
        .message.transfer .transfer-info .transfer-text { font-size: 15px; font-weight: 500; }
        .message.transfer .transfer-info .transfer-amount { font-size: 18px; font-weight: bold; }
        .message.transfer .transfer-footer { background-color: transparent; color: white; font-size: 12px; padding: 5px 15px; border-top: 1px solid rgba(255,255,255,0.3); opacity: 0.9; }
        .message.transfer.completed .transfer-footer { color: var(--theme-primary-hover); border-top: 1px solid rgba(102, 187, 106, 0.2); }
        .message.sent.transfer { border-top-right-radius: 0; }
        .message.received.transfer { border-top-left-radius: 0; }

        /* --- Pet Game Styles --- */
        #pet-container {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }
        .pet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        #pet-name {
            color: var(--text-dark);
        }
        #pet-gold-display {
            font-size: 16px;
            color: #E6A23C;
        }
        .pet-visual-area {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            margin-bottom: 15px;
        }
        .pet-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }
        .stat-bar-container {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        .stat-bar-label {
            width: 60px;
            text-align: right;
        }
        .stat-bar {
            flex-grow: 1;
            height: 10px;
            background-color: #eee;
            border-radius: 5px;
            overflow: hidden;
        }
        .stat-bar-inner {
            height: 100%;
            width: 100%;
            border-radius: 5px;
            background-color: var(--theme-primary);
            transition: width 0.3s ease, background-color 0.3s ease;
        }
        .pet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .pet-action-btn {
            padding: 10px;
            font-size: 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: #f0f2f5;
            color: var(--text-dark);
        }
        .pet-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .pet-action-btn:disabled {
            background-color: #e9ecef;
            color: #adb5bd;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        #work-pet-btn {
            background-color: var(--theme-secondary);
            color: white;
        }
        
        .slime {
    width: 60px; /* 宽度设为55px */
    height: 40px; /* 高度设为40px，这样基础形状更稳定 */
    /* 背景色和半透明效果保持不变 */
    background-color: rgba(209, 233, 206, 0.8); 
    
    /* 核心修改：只设置左上角和右上角的圆角，让底部保持平坦 */
    /* 这四个值分别对应：左上、右上、右下、左下 */
    border-radius: 60px 60px 20px 20px; 

    position: relative;
    animation: slime-bob 2s infinite ease-in-out;
    transition: all 0.5s ease;
    
    /* 边框效果保持不变 */
    border: 2px solid rgba(76, 175, 80, 0.5);
    /* 新增：移除底部边框线，让它完美地“贴”在地面上 */
    border-bottom: none; 
    
    /* 内阴影果冻质感保持不变 */
    box-shadow: inset 0 -4px 8px rgba(0, 0, 0, 0.15), 
                inset 0 4px 6px rgba(255, 255, 255, 0.4);
}
        .slime.hungry { background-color: #ffb74d; }
        .slime.dirty { background-color: #bdbdbd; }
        .slime::before {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background-color: #212121;
            border-radius: 50%;
            top: 15px;
            left: 15px;
            transition: all 0.5s ease;
        }
        .slime::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background-color: #212121;
            border-radius: 50%;
            top: 15px;
            right: 15px;
            transition: all 0.5s ease;
        }
        .slime-shadow {
            width: 50px;
            height: 8px;
            background-color: rgba(0,0,0,0.1);
            border-radius: 50%;
            margin-top: 5px;
            animation: slime-shadow-squish 2s infinite ease-in-out;
            transition: all 0.5s ease;
        }
        @keyframes slime-bob {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes slime-shadow-squish {
             0%, 100% { transform: scaleX(1); }
            50% { transform: scaleX(0.8); }
        }

        /* --- V6.0 新增：宠物进化形态 --- */
        /* 初始宝宝期形态 */
        .slime.baby-form { }

        /* 幼年期 */
        .slime.toddler-form {
            transform: scale(1.15); /* 长大一点 */
            background-color: #a5d6a7; /* 颜色变嫩一点 */
        }
        .slime.toddler-form::before, 
        .slime.toddler-form::after {
            width: 7px; /* 眼睛变大一点 */
            height: 7px;
            box-shadow: 0 0 2px rgba(255, 255, 255, 0.6); /* 眼睛里有光 */
        }

        /* 少年期，眼睛变成 > < 的样子*/
        .slime.teenager-form {
            transform: scale(1.25);
            animation-duration: 1.5s; /* 变得更活泼，跳得快一点 */
        }
        .slime.teenager-form::before { /* 左眼 */
            content: '>';
            font-weight: bold;
            color: white;
            background: none;
            font-size: 12px;
            line-height: 1;
            transform: rotate(-15deg);
            top: 18px;
            left: 18px;
        }
        .slime.teenager-form::after { /* 右眼 */
            content: '<';
            font-weight: bold;
            color: white;
            background: none;
            font-size: 12px;
            line-height: 1;
            transform: rotate(15deg);
            top: 18px;
            right: 18px;
        }
        /* --- 新增：史莱姆互动动画 --- */
        .slime.happy-jiggle {
            animation: happy-jiggle 0.5s ease-in-out;
        }
        @keyframes happy-jiggle {
            0%, 100% { transform: scale(1, 1); }
            25% { transform: scale(0.95, 1.05); }
            50% { transform: scale(1.05, 0.95); }
            75% { transform: scale(0.98, 1.02); }
        }

        .slime .blush {
            position: absolute;
            width: 15px;
            height: 6px;
            background-color: rgba(255, 105, 180, 0); /* 默认透明 */
            border-radius: 50%;
            top: 22px;
            transition: background-color 0.3s ease;
        }
        .slime .blush.left { left: 5px; transform: rotate(-15deg); }
        .slime .blush.right { right: 5px; transform: rotate(15deg); }
        .slime.is-blushing .blush {
            background-color: rgba(255, 105, 180, 0.6); /* 脸红 */
        }

        /* --- 新增：用于隐藏思维预设的编辑功能 --- */
        /* 1. 隐藏“思维预设管理”页面右上角的“+”添加按钮 */
        #add-thought-preset-btn {
            display: none;
        }

        /* 2. 隐藏每个思维预设项目右侧包含“编辑”和“删除”图标的整个操作区 */
        #thought-presets-list .preset-actions {
            display: none;
        }
/* --- 钱包收支明细样式 --- */
        #transaction-list {
            padding: 10px 0;
        }
        .transaction-item {
            background-color: white;
            padding: 15px;
            margin: 0 15px 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .transaction-info .desc {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
            font-size: 16px;
        }
        .transaction-info .time {
            font-size: 13px;
            color: var(--text-gray);
        }
        .transaction-amount {
            font-size: 16px;
            font-weight: bold;
            flex-shrink: 0;
            margin-left: 15px;
        }
        .transaction-amount.income {
            color: var(--theme-primary-hover);
        }
        .transaction-amount.expense {
            color: var(--soft-red);
        }

/* --- 转账退还样式 --- */
        .message.transfer.returned {
            background-color: #bdc3c7; /* 中性灰色背景 */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .message.transfer.returned .transfer-info .transfer-text,
        .message.transfer.returned .transfer-info .transfer-amount,
        .message.transfer.returned .transfer-footer {
            color: #6c757d;
            text-decoration: line-through; /* 添加删除线表示作废 */
        }
        .message.transfer.returned .transfer-icon i {
            color: #6c757d;
        }
        /* 将退还后的图标从对勾变为退还箭头 */
        .message.transfer.returned::after {
            content: '\f0e2'; /* Font Awesome "reply/undo" icon */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900; 
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: #6c757d;
        }
        /* 转账弹窗里的退还按钮样式 */
        #return-transfer-btn {
            margin-top: 10px;
            background-color: #e67e22; /* 胡萝卜橙色 */
        }
        /* --- 全新美化的转账弹窗样式 --- */
        #transfer-modal .modal-header { /* 优化头部 */
            background-color: #f7f9f9;
            color: var(--text-dark);
            border-bottom: 1px solid #eee;
        }
        #transfer-modal .close-btn { color: #999; }
        #transfer-modal .modal-body {
            padding: 20px 25px 30px;
            text-align: center;
        }
        .transfer-sender-profile { /* 发起人信息 */
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
        }
        .transfer-sender-avatar {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            margin-right: 12px;
        }
        .transfer-sender-info { text-align: left; }
        .transfer-sender-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
        }
        .transfer-recipient-name {
            font-size: 14px;
            color: var(--text-gray);
        }
        .transfer-amount-display { /* 金额显示 */
            padding-bottom: 25px;
            margin-bottom: 25px;
            border-bottom: 1px dashed #ddd;
        }
        .transfer-amount-display span:first-child { /* '¥' 符号 */
            font-size: 32px;
            font-weight: 500;
            margin-right: 4px;
        }
        .transfer-amount-display span:last-child { /* 金额数字 */
            font-size: 48px;
            font-weight: 700;
            color: var(--text-dark);
        }
        .transfer-action-area .form-button { /* 按钮区域 */
            margin-top: 10px;
        }
        #confirm-transfer-btn { background-color: var(--theme-primary); }
        #return-transfer-btn { background-color: #e67e22; }

        /* --- 已收款/已退还状态视图 --- */
        .transfer-status-info {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-dark);
        }
        .transfer-status-info i {
            font-size: 24px;
            margin-right: 10px;
        }
        .transfer-status-info i.fa-check-circle { color: var(--theme-primary-hover); }
        .transfer-status-info i.fa-undo-alt { color: #e67e22; }
        .transfer-status-subtext {
            margin-top: 8px;
            font-size: 14px;
            color: var(--text-gray);
        }
        /* --- 修正系统消息包裹层，使其居中 --- */
        .message-wrapper.system-wrapper {
            align-self: center;
            /* 解除最大宽度限制，让内部的灰色消息自己决定宽度 */
            max-width: none;
        }
        /* --- 论坛帖子内的红包卡片样式 --- */
        .forum-red-packet-card {
            background-color: #FFCC80;
            color: #5D4037;
            padding: 10px 15px;
            margin-top: 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .forum-red-packet-card:hover {
            transform: scale(1.02);
        }
        .forum-red-packet-card .red-packet-icon {
            font-size: 24px;
            margin-right: 10px;
            color: #FFA726;
        }
        .forum-red-packet-card .red-packet-blessing {
            font-weight: 500;
        }

        /* --- 帖子分享到私聊里的卡片样式 --- */
        .message.post-share-card {
            background-color: #fff;
            border: 1px solid #eee;
            width: 250px;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
        }
        .post-share-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        .post-share-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .post-share-name {
            font-weight: 600;
            font-size: 14px;
        }
        .post-share-content {
            font-size: 14px;
            color: var(--text-gray);
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.5;
        }
        .post-share-footer {
            margin-top: 8px;
            font-size: 12px;
            color: #ccc;
            text-align: right;
        }
        
        /* --- 发布动态时添加红包的按钮样式 --- */
        .moment-extra-actions {
            display: flex;
            justify-content: flex-start;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }
        .moment-action-btn {
            font-size: 20px;
            color: var(--text-gray);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
        }
        .moment-action-btn:hover {
            background-color: #f0f0f0;
        }
        .moment-action-btn.active {
            color: var(--soft-red);
        }
        
        /* --- 转发时选择联系人的弹窗样式 --- */
        .contact-picker-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 5px;
            margin-bottom: 15px;
        }
        .contact-picker-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 6px;
        }
        .contact-picker-item:hover {
            background-color: #f9f9f9;
        }
        .contact-picker-item input {
            margin-right: 15px;
        }
        .contact-picker-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        #custom-confirm-confirm-btn.danger {
    background-color: var(--soft-red) !important;
}
/* ========================================================== */
/* V9.0 新增：悬浮音乐播放器样式 */
/* ========================================================== */
:root {
    --apple-green: #8DB600; /* 新增苹果绿 */
}
#music-player-card {
    display: none; /* 默认隐藏，由JS控制 */
    flex-direction: column;
    position: absolute; /* 使用absolute定位在#screen内 */
    width: 320px;
    height: 500px;
    background-color: rgba(255, 255, 255, 0.92);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
    overflow: hidden;
    top: 50px; 
    left: 50px;
    z-index: 1000;
    transition: all 0.4s ease-in-out;
}
.player-header {
    padding: 0 15px;
    height: 45px;
    font-weight: 600;
    color: var(--text-dark);
    background-color: rgba(0,0,0,0.05);
    cursor: move;
    position: relative;
    user-select: none;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-shrink: 0;
}
.player-collapse-btn {
    position: absolute;
    top: 50%;
    left: 15px;
    transform: translateY(-50%);
    cursor: pointer;
    color: var(--text-light);
    padding: 5px;
}
/* --- ▼▼▼ 新增的关闭按钮样式 ▼▼▼ --- */
#player-close-btn {
    position: absolute;
    top: 50%;
    right: 15px;
    transform: translateY(-50%);
    cursor: pointer;
    color: var(--text-gray);
    padding: 5px;
    font-size: 18px;
    transition: transform 0.2s ease;
}
#player-close-btn:hover {
    transform: translateY(-50%) scale(1.15);
}
.header-collapsed-content {
    display: none;
    align-items: center;
    gap: 10px;
    width: 100%;
    padding-left: 35px;
}
.header-avatar-stack { display: flex; align-items: center; }
.header-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 2px solid white;
    object-fit: cover;
}
.header-avatar:last-child { margin-left: -10px; }
.header-lyric {
    flex-grow: 1;
    font-size: 14px;
    font-weight: 600;
    color: var(--apple-green);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.player-main-content {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    transition: opacity 0.3s;
}
.player-avatar-stack { display: flex; justify-content: center; align-items: center; padding: 20px 0 15px; }
.player-avatar { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
.player-avatar:last-child { margin-left: -25px; }
.player-song-info { text-align: center; }
.player-title { font-size: 18px; font-weight: 700; color: var(--text-dark); }
.player-artist { font-size: 14px; color: var(--text-light); margin-top: 5px; }
.lyrics-container { flex-grow: 1; overflow: hidden; position: relative; mask-image: linear-gradient(transparent 0%, black 20%, black 80%, transparent 100%); margin-top: 15px; }
.lyrics-wrapper { position: absolute; width: 100%; transition: transform 0.5s ease-out; }
.lyric-line { padding: 8px 20px; text-align: center; font-size: 16px; color: var(--text-light); transition: color 0.5s, transform 0.5s; }
.lyric-line.active {
    color: var(--apple-green);
    font-weight: 600; 
    transform: scale(1.1); 
}
.player-controls-wrapper { padding: 15px 20px; border-top: 1px solid rgba(0,0,0,0.05); }
.player-progress-bar-wrapper { display: flex; align-items: center; gap: 10px; font-size: 12px; color: var(--text-light); }
.player-progress-bar { flex-grow: 1; height: 4px; background-color: rgba(0,0,0,0.1); border-radius: 2px; cursor: pointer; padding: 4px 0; background-clip: content-box; }
.player-progress { width: 0%; height: 100%; background-color: var(--theme-primary); border-radius: 2px; }
.player-controls { display: flex; justify-content: space-around; align-items: center; font-size: 20px; margin-top: 10px; color: var(--text-dark); }
.player-control-btn { cursor: pointer; transition: transform 0.2s; width: 30px; text-align: center;}
.player-control-btn:hover { transform: scale(1.15); }
.player-play-btn { font-size: 40px; color: var(--theme-primary); }

#music-player-card.collapsed {
    height: 45px;
    background-color: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(25px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25);
}
#music-player-card.collapsed .header-collapsed-content,
#music-player-card.collapsed .player-collapse-btn {
    text-shadow: 0 1px 3px rgba(0,0,0,0.4);
}
#music-player-card.collapsed .player-header-title { display: none; }
#music-player-card.collapsed .header-collapsed-content { display: flex; }
#music-player-card.collapsed .player-main-content { visibility: hidden; opacity: 0; }

.player-playlist-view {
    position: absolute;
    top: 45px;
    left: 0; right: 0; bottom: 95px; 
    background-color: rgba(255, 255, 255, 0.92); 
    backdrop-filter: blur(20px); 
    transform: translateY(100%);
    transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out; /* 建议给opacity也加上过渡效果 */
    opacity: 0;
    padding: 10px 0;
    overflow-y: auto;
    border-top: 1px solid rgba(0,0,0,0.05);
    pointer-events: none; /* <-- 核心新增：隐藏时忽略点击事件 */
    z-index: 3;
}
.player-playlist-view.active { 
    transform: translateY(0); 
    opacity: 1; 
    pointer-events: auto; /* <-- 核心新增：显示时恢复点击事件 */
}
.playlist-item { padding: 12px 20px; cursor: pointer; border-bottom: 1px solid rgba(0,0,0,0.05); }
.playlist-item:hover { background-color: rgba(0,0,0,0.05); }
.playlist-item.playing .playlist-title { color: var(--theme-primary); }
.playlist-title { font-weight: 600; color: var(--text-dark); font-size: 14px; }
.playlist-artist { font-size: 12px; color: var(--text-light); }
/* ========================================================== */
/* V16.0 最终完美版：无缝、平滑的呼吸光晕 */
/* ========================================================== */

/* 1. 【防重叠魔法】(此部分无变化) */
.player-avatar {
    position: relative;
}
.player-avatar:first-child {
    z-index: 2;
}
.player-avatar:last-child {
    z-index: 1;
}

/* 2. 【重新定义动画】创建一个完整的“吸气-呼气”循环 */
@keyframes pulse-glow-left {
    /* 动画的开始和结束点都是同一个状态：最小、最明显的光晕 */
    0%, 100% {
        box-shadow: -2px 0 5px 0px rgba(129, 199, 132, 0.7);
    }
    /* 动画的中点是另一个状态：最大、最微弱的光晕 */
    50% {
        /* 关键：这里的透明度不是0，而是0.1，保留了一丝微光，确保动画永不中断！ */
        box-shadow: -8px 0 20px 12px rgba(129, 199, 132, 0.1);
    }
}

@keyframes pulse-glow-right {
    0%, 100% {
        box-shadow: 2px 0 5px 0px rgba(129, 199, 132, 0.7);
    }
    50% {
        box-shadow: 8px 0 20px 12px rgba(129, 199, 132, 0.1);
    }
}

/* 3. 【应用新动画】移除 alternate，并使用更平滑的 ease-in-out */
#player-avatar-stack.is-playing .player-avatar:first-child {
    /* 动画时长3秒，无限循环，缓入缓出效果，不再需要 alternate */
    animation: pulse-glow-left 3s infinite ease-in-out;
}
#player-avatar-stack.is-playing .player-avatar:last-child {
    animation: pulse-glow-right 3s infinite ease-in-out;
}
/* --- 红包领取详情弹窗样式 --- */
.claimer-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid #f0f0f0;
}
.claimer-item:last-child {
    border-bottom: none;
}
.claimer-avatar {
    width: 40px;
    height: 40px;
    border-radius: 6px;
    margin-right: 12px;
}
.claimer-info {
    flex-grow: 1;
}
.claimer-name {
    font-weight: 500;
    color: var(--text-dark);
}
.claim-time {
    font-size: 12px;
    color: var(--text-gray);
    margin-top: 2px;
}
.claim-amount {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-dark);
}
.best-luck-badge {
    background-color: #FFD700;
    color: #A67C00;
    font-size: 11px;
    font-weight: bold;
    padding: 2px 6px;
    border-radius: 5px;
    margin-left: 8px;
}
/* --- V-Final 新增: 游戏转盘样式 --- */
.wheel-option-item {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}
.wheel-option-item input[type="text"] {
    flex-grow: 1;
}
.wheel-option-item input[type="number"] {
    width: 60px;
    text-align: center;
}
.wheel-option-item .delete-option-btn {
    background: none;
    border: none;
    color: var(--soft-red);
    cursor: pointer;
    font-size: 18px;
}
.message.game-wheel-card {
    background-color: #fff;
    border: 1px solid #eee;
    width: 250px;
    padding: 12px;
    border-radius: 12px;
}
.wheel-card-title {
    font-weight: bold;
    text-align: center;
    padding-bottom: 8px;
    border-bottom: 1px solid #f0f0f0;
    margin-bottom: 12px;
}
.wheel-card-result-area {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.wheel-result-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.wheel-player-name {
    font-size: 14px;
    color: #555;
}
.wheel-player-result {
    font-size: 14px;
    font-weight: 600;
    background-color: #f0f2f5;
    padding: 4px 10px;
    border-radius: 12px;
}
.spin-btn {
    background-color: var(--theme-primary);
    color: white;
    border: none;
    padding: 4px 12px;
    border-radius: 12px;
    cursor: pointer;
    font-size: 14px;
}
.spin-btn:hover {
    background-color: var(--theme-primary-hover);
}
/* --- 引用回复功能样式 --- */
.message-wrapper {
    position: relative; /* 确保回复按钮可以正确定位 */
}

.reply-btn {
    position: absolute;
    top: 50%;
    background-color: rgba(240, 240, 240, 0.8);
    backdrop-filter: blur(2px);
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    color: #555;
    cursor: pointer;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    opacity: 0; /* 默认完全透明，隐藏 */
    transform: translateY(-50%) scale(0.8); /* 默认缩小一点 */
    transition: opacity 0.2s ease, transform 0.2s ease; /* 添加平滑过渡动画 */
    pointer-events: none; /* 隐藏时不可点击 */
}

/* 当父级 message-wrapper 拥有 .show-reply-btn 类时，让按钮显示出来 */
.message-wrapper.show-reply-btn .reply-btn {
    opacity: 1;
    transform: translateY(-50%) scale(1);
    pointer-events: auto; /* 显示时恢复点击 */
}

.message-wrapper.sent .reply-btn {
    left: -35px; /* 发送的消息，按钮在左边 */
}
.message-wrapper.received .reply-btn {
    right: -35px; /* 收到的消息，按钮在右边 */
}
.reply-btn:hover {
    transform: translateY(-50%) scale(1.1) !important;
}

/* 聊天输入框上方的引用预览条 */
#reply-preview-bar {
    padding: 8px 15px;
    background-color: #f0f0f0;
    font-size: 13px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #e0e0e0;
}
#reply-preview-content {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: #666;
}
#reply-preview-content .sender {
    font-weight: 600;
    color: #333;
}
#cancel-reply-btn {
    cursor: pointer;
    font-size: 16px;
    margin-left: 10px;
    color: #888;
}

/* 聊天气泡中的引用消息框 */
.message-quote {
    background-color: rgba(0, 0, 0, 0.05);
    padding: 6px 12px;
    border-left: 3px solid var(--theme-primary);
    border-radius: 6px;
    margin-bottom: 8px;
    font-size: 13px;
    cursor: pointer; /* 添加手型光标，提示可以点击 */
}
.message-quote .sender {
    font-weight: 600;
    color: var(--theme-primary);
}
.message-quote .content {
    color: #555;
    white-space: normal; /* Allows the text to wrap naturally */
    word-wrap: break-word; /* Ensures long words don't overflow */
    display: block;
    /* The overflow and text-overflow properties are no longer needed */
}

/* 点击引用框跳转后，目标消息的高亮效果 */
.message-wrapper.highlighted .message {
    animation: highlight-anim 1.5s ease;
}
@keyframes highlight-anim {
    0% { background-color: #fff3cd; }
    100% { background-color: inherit; }
}
.message-wrapper.sent.highlighted .message.sent {
     animation: highlight-anim-sent 1.5s ease;
}
@keyframes highlight-anim-sent {
    0% { background-color: #bde0fe; }
    100% { background-color: var(--sent-message-bg); }
}
/* --- V-Final 新增: 叙事模式气泡加宽 --- */
#chat-messages.narrative-mode-active .message-wrapper {
    max-width: 90%; /* 从默认的 85% 增加到 95% */
}
/* --- V-Final 新增: 在聊天中隐藏角色头像 --- */
.message-wrapper.contact-avatar-hidden .message-avatar {
    display: none;
}
.message-wrapper.received.contact-avatar-hidden .message-body {
    margin-left: 0;
}
/* ========================================================== */
/* V17.0 新增：视频通话样式 (简化版) */
/* ========================================================== */
.video-call-card-content {
    width: 90%;
    max-width: 400px;
    height: 75%;
    max-height: 650px;
    background-color: rgba(255, 255, 255, 0.92);
    backdrop-filter: blur(18px);
    border-radius: 24px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.5);
    display: flex;
    flex-direction: column;
    color: var(--text-dark);
    overflow: hidden;
}
.video-call-header { padding: 15px; text-align: center; flex-shrink: 0; border-bottom: 1px solid rgba(0,0,0,0.07); }
#call-contact-name { font-size: 18px; font-weight: 700; }
#call-status { display: block; font-size: 13px; color: var(--theme-primary); margin-top: 4px; font-weight: 600; }
.video-call-main { flex-grow: 1; padding: 15px; overflow: hidden; }
.narrative-feed { height: 100%; overflow-y: auto; padding-right: 10px; display: flex; flex-direction: column; }
.char-bubble { align-self: flex-start; max-width: 90%; background-color: #fff; border: 1px solid var(--border-color); box-shadow: 0 1px 2px rgba(0,0,0,0.04); padding: 10px 15px; border-radius: 18px; border-top-left-radius: 4px; margin-bottom: 12px; font-size: 15px; line-height: 1.6; }
.char-bubble p { margin: 0 0 8px 0; }
.char-bubble p:last-child { margin-bottom: 0; }
.char-bubble .narrative-speech { color: var(--text-dark); font-weight: 500; }
.char-bubble .narrative-action { color: var(--text-gray); font-style: italic; }
.char-bubble .narrative-psychology { color: var(--theme-primary-hover); font-style: italic; }
.narrative-feed > .narrative-action { color: var(--text-gray); font-style: italic; align-self: center; text-align: center; font-size: 13px; margin: 5px 0 15px 0; }
.user-message { align-self: flex-end; background-color: var(--sent-message-bg); padding: 10px 15px; border-radius: 18px; border-bottom-right-radius: 4px; color: var(--text-dark); font-weight: 500; margin-bottom: 12px; max-width: 90%; font-size: 15px; line-height: 1.6; }
.video-call-input-area { padding: 8px 15px; display: flex; align-items: center; border-top: 1px solid rgba(0,0,0,0.07); background-color: rgba(0,0,0,0.03); flex-shrink: 0; }
#video-call-input { flex-grow: 1; background-color: white; border: 1px solid var(--border-color); border-radius: 20px; padding: 8px 15px; font-size: 15px; outline: none; resize: none; max-height: 100px; overflow-y: auto; font-family: inherit; }
#video-call-send-btn { background-color: var(--theme-primary); color: var(--text-on-primary); border: none; border-radius: 50%; width: 38px; height: 38px; display: flex; justify-content: center; align-items: center; margin-left: 8px; cursor: pointer; font-size: 16px; flex-shrink: 0; transition: background-color 0.2s; }
.video-call-controls { display: flex; justify-content: space-around; align-items: center; padding: 15px 20px; background-color: rgba(0,0,0,0.03); flex-shrink: 0; }
.control-btn { display: flex; flex-direction: column; align-items: center; cursor: pointer; width: 80px; text-align: center; }
.control-btn i { width: 60px; height: 60px; border-radius: 50%; background-color: #e9ecef; color: var(--text-dark); display: flex; justify-content: center; align-items: center; font-size: 26px; margin-bottom: 6px; transition: all 0.2s ease; }
.control-btn span { font-size: 12px; font-weight: 500; color: var(--text-gray); }
.control-btn.hang-up i { background-color: var(--soft-red); color: white; }

/* 来电界面样式 */
#incoming-call-screen {
    display: none; 
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    z-index: 1002; 
    background-color: rgba(0,0,0,0.7); 
    backdrop-filter: blur(10px); 
    color: white; 
    text-align: center; 
    flex-direction: column; 
    justify-content: space-around; 
    align-items: center;
}

/* 实际通话界面样式 */
#video-call-screen {
    display: none; 
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    justify-content: center; 
    align-items: center; 
    z-index: 1001; 
    background-color: rgba(0,0,0,0.4);
}
</style>
</head>
<body>
    <div id="app-container">
        <div id="screen">
            <div id="main-screen">
                <div class="app-header">
                    <div class="app-title">聊天</div>
                    <div>
                        <i class="fas fa-user-plus action-btn" id="add-contact-btn"></i>
                    </div>
                </div>
                
                <div class="contacts-container">
                </div>
                
                <div class="bottom-nav">
                    <div class="nav-item active" id="nav-chat">
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-comment"></i></div>
                            <div>聊天</div>
                        </div>
                    </div>
                    <div class="nav-item" id="nav-discover">
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-compass"></i></div>
                            <div>发现</div>
                            <div class="notification-dot moments-notification-dot"></div>
                        </div>
                    </div>
                    <div class="nav-item" id="nav-profile">
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-user"></i></div>
                            <div>我</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="chat-screen">
                <div class="chat-header">
                    <div class="back-btn" id="back-from-chat">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="chat-info">
                        <div class="chat-name" id="chat-contact-name"></div>
                        <div class="chat-status" id="chat-contact-status"></div>
                    </div>
                    <div>
                        <i class="fas fa-paw action-btn" id="toggle-chat-pet-btn" title="显示/隐藏宠物"></i>
                        <i class="fas fa-trash-alt action-btn" id="delete-history-btn" title="编辑消息"></i>
                        <i class="fas fa-cog action-btn" id="contact-settings-btn" title="联系人设置"></i>
                    </div>
                </div>
                
                <div class="chat-messages" id="chat-messages">
                    </div>
                
                <div id="emoticon-picker"></div>
                
                <div id="attachment-menu"></div>

                <div id="reply-preview-bar" style="display: none;"></div>

<div class="chat-input-area" id="chat-input-area">
    <div class="emoji-btn" id="emoji-btn"><i class="far fa-laugh-beam"></i></div>
    <button class="attachment-btn" id="attachment-btn">📎</button>
    <textarea id="message-input" placeholder="输入消息..." rows="1"></textarea>
    <button id="send-btn" class="input-action-btn" title="发送消息"><i class="fas fa-paper-plane"></i></button>
    <button id="request-reply-btn" class="input-action-btn" title="请求AI回复"><i class="fas fa-apple-whole"></i></button>
</div>
                
                <div id="edit-mode-bar">
                    <button id="delete-selected-btn" class="edit-action-btn">删除已选</button>
                    <button id="cancel-edit-btn" class="edit-action-btn">取消</button>
                </div>
            </div>
            
            <div id="profile-screen">
                <div class="profile-header">
                    <div class="avatar-container">
                        <img src="https://via.placeholder.com/100/A0DCF8/FFFFFF?text=ME" alt="我的头像" class="profile-avatar" id="my-profile-avatar">
                        <div class="change-avatar-btn" id="change-avatar-btn">
                            <i class="fas fa-camera"></i>
                        </div>
                    </div>
                    <div class="profile-name" id="profile-name">我的名字</div>
                    <div class="profile-status" id="profile-status">在线</div>
                </div>
                
                <div class="profile-actions">
                    <div class="action-item" id="edit-status-btn">
                        <div class="action-icon">
                            <i class="fas fa-comment"></i>
                        </div>
                        <div class="action-label">我的状态</div>
                    </div>
                </div>
                
                <div class="profile-details">
                    <div class="detail-item">
                        <div class="detail-label">昵称</div>
                        <div class="detail-value" id="nickname-value">我的昵称</div>
                        <div class="edit-btn" data-field="name">
                            <i class="fas fa-edit"></i>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">个性签名</div>
                        <div class="detail-value" id="signature-value">我的个性签名</div>
                        <div class="edit-btn" data-field="signature">
                            <i class="fas fa-edit"></i>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">地区</div>
                        <div class="detail-value" id="region-value">我的地区</div>
                        <div class="edit-btn" data-field="region">
                            <i class="fas fa-edit"></i>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">生日</div>
                        <div class="detail-value" id="birthday-value">我的生日</div>
                        <div class="edit-btn" data-field="birthday">
                            <i class="fas fa-edit"></i>
                        </div>
                    </div>
                    <div class="detail-item" id="appearance-settings-btn" style="margin-top: 20px;">
    <div class="detail-label"><i class="fas fa-palette" style="margin-right: 8px; color: var(--theme-primary);"></i>外观设置</div>
    <div class="detail-value">背景、气泡、字体</div>
    <i class="fas fa-chevron-right" style="color:#999;"></i>
</div>

<div class="detail-item" id="my-wallet-btn" style="margin-top: 20px;">

                        <div class="detail-label"><i class="fas fa-wallet" style="margin-right: 8px; color: var(--theme-primary);"></i>我的钱包</div>
                        <div class="detail-value" id="my-balance-value" style="color: #E6A23C; font-weight: bold;">¥ 1000.00</div>
                        <i class="fas fa-chevron-right" style="color:#999;"></i>
                    </div>
                    
                    <div class="detail-item" style="margin-top: 20px; flex-direction: column; align-items: stretch; padding: 10px; background-color: transparent; border: none; box-shadow: none;">
                        <button class="form-button" id="export-data-btn" style="margin-top: 0; margin-bottom: 10px; background-color: var(--theme-secondary);"><i class="fas fa-download"></i> 导出数据 (备份)</button>
                        <button class="form-button" id="import-data-btn" style="margin-top: 0; background-color: #7f8c8d;"><i class="fas fa-upload"></i> 导入数据 (恢复)</button>
                        <input type="file" id="import-file-input" accept=".json" style="display: none;">
                    </div>
                    <div class="detail-item" style="margin-top: 10px;">
                        <button class="form-button" id="initialize-app-btn" style="background-color: #e74c3c; width: 100%;">
                            <i class="fas fa-undo"></i> 初始化应用 (清除所有数据)
                        </button>
                    </div>
                </div>
                
                <div class="bottom-nav">
                    <div class="nav-item" id="nav-chat-2">
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-comment"></i></div>
                            <div>聊天</div>
                        </div>
                    </div>
                    <div class="nav-item" id="nav-discover-2">
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-compass"></i></div>
                            <div>发现</div>
                            <div class="notification-dot moments-notification-dot"></div>
                        </div>
                    </div>
                    <div class="nav-item active" id="nav-profile-2">
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-user"></i></div>
                            <div>我</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="char-profile-screen">
                <div class="chat-header">
                    <div class="back-btn" id="back-from-char-profile">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                     <div class="chat-info" style="font-weight: 600;"> 资料 </div>
                     <div style="width: 40px;"></div>
                </div>
                <div class="profile-details">
                    <div style="background-color: white; padding: 20px; border-radius: 10px;">
                        <div class="contact-item" style="padding: 0; border-bottom: none; align-items: flex-start;">
                             <div class="avatar-container" style="width: 70px; height: 70px; margin: 0;">
                                 <img src="" alt="联系人头像" class="profile-avatar" id="char-profile-avatar" style="width: 70px; height: 70px; border-radius: 8px;">
                                 <div class="change-avatar-btn" id="change-char-avatar-btn" style="width: 25px; height: 25px;">
                                     <i class="fas fa-camera" style="font-size: 12px;"></i>
                                 </div>
                             </div>
                             <div class="contact-info" style="margin-left: 20px;">
                                 <div id="char-profile-name" class="contact-name" style="font-size: 22px; font-weight: bold;"></div>
                                 <div id="char-profile-signature-display" class="contact-last-message" style="margin-top: 5px; white-space: normal;"></div>
                             </div>
                        </div>
                    </div>
                    
                    <div id="pet-container-wrapper"></div>
                    
                    <div class="discover-section" style="margin-top: 20px; border-radius: 10px;">
                        <div class="detail-item" id="edit-char-name-btn" style="padding:15px; background:white; border-radius: 10px 10px 0 0;">
                            <div class="detail-label">设置备注</div>
                            <div class="detail-value" id="char-name-value"></div>
                            <i class="fas fa-chevron-right" style="color:#999;"></i>
                        </div>
                         <div class="detail-item" id="edit-char-signature-btn" style="padding:15px; background:white;">
                             <div class="detail-label">设置签名</div>
                             <div class="detail-value" id="char-signature-value"></div>
                             <i class="fas fa-chevron-right" style="color:#999;"></i>
                         </div>
                         <div class="detail-item" id="view-char-diary-btn" style="padding:15px; background:white;">
                             <div class="detail-label">他的日记</div>
                             <div class="detail-value"></div>
                             <i class="fas fa-chevron-right" style="color:#999;"></i>
                         </div>
                         <div class="detail-item" id="view-memory-album-btn" style="padding:15px; background:white;">
                            <div class="detail-label">我们的小窝相册</div>
                            <i class="fas fa-chevron-right" style="color:#999;"></i>
                         </div>
                         <div class="detail-item" id="char-more-info-btn" style="padding:15px; background:white; border-radius: 0 0 10px 10px;">
                             <div class="detail-label">更多信息</div>
                             <div class="detail-value"></div>
                             <i class="fas fa-chevron-right" style="color:#999;"></i>
                         </div>
                    </div>
                    
                    <div style="padding: 20px 0;">
                        <button class="form-button" id="delete-contact-btn" style="background-color: #e74c3c; width: 100%;">删除联系人</button>
                    </div>

                </div>
            </div>
            
            <div id="discover-screen">
                <div class="discover-header">
                    <div class="discover-title">发现</div>
                </div>
                
                <div class="discover-content">
                    <div class="discover-section">
                        <div class="discover-item" id="moments-btn">
                            <div class="discover-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <div class="discover-info">
                                <div class="discover-name">论坛</div>
                                <div class="discover-desc">看看大家在聊什么</div>
                            </div>
                            <div class="discover-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="discover-section">
                        <div class="discover-item" id="emoticon-library-btn">
                            <div class="discover-icon">
                                <i class="far fa-grin-alt"></i>
                            </div>
                            <div class="discover-info">
                                <div class="discover-name">表情包库</div>
                                <div class="discover-desc">管理和添加我的表情包</div>
                            </div>
                            <div class="discover-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                        <div class="discover-item" id="music-library-btn">
                            <div class="discover-icon">
                                <i class="fas fa-music"></i>
                            </div>
                            <div class="discover-info">
                                <div class="discover-name">音乐库</div>
                                <div class="discover-desc">管理和添加我的歌曲</div>
                            </div>
                            <div class="discover-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                         <div class="discover-item" id="user-persona-presets-btn">
                            <div class="discover-icon">
                                <i class="fas fa-theater-masks"></i>
                            </div>
                            <div class="discover-info">
                                <div class="discover-name">用户面具预设</div>
                                <div class="discover-desc">管理你在对话中的不同身份</div>
                            </div>
                            <div class="discover-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                        <div class="discover-item" id="world-book-btn">
                            <div class="discover-icon">
                                <i class="fas fa-book"></i>
                            </div>
                            <div class="discover-info">
                                <div class="discover-name">世界书</div>
                                <div class="discover-desc">探索世界知识</div>
                            </div>
                            <div class="discover-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                        <div class="discover-item" id="thought-presets-btn">
                            <div class="discover-icon">
                                <i class="fas fa-brain"></i>
                            </div>
                            <div class="discover-info">
                                <div class="discover-name">思维预设</div>
                                <div class="discover-desc">管理AI的“破限”模式</div>
                            </div>
                            <div class="discover-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="discover-section">
                         <div class="discover-item" id="square-api-settings-btn">
                            <div class="discover-icon">
                                <i class="fas fa-rss-square"></i>
                            </div>
                            <div class="discover-info">
                                <div class="discover-name">论坛API设置</div>
                                <div class="discover-desc">为论坛帖子、评论生成配置专属API</div>
                            </div>
                            <div class="discover-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                        <div class="discover-item" id="api-settings-btn">
                            <div class="discover-icon">
                                <i class="fas fa-comments-dollar"></i>
                            </div>
                            <div class="discover-info">
                                <div class="discover-name">聊天API设置</div>
                                <div class="discover-desc">为聊天功能配置API</div>
                            </div>
                            <div class="discover-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="bottom-nav">
                    <div class="nav-item" id="nav-chat-discover"> 
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-comment"></i></div>
                            <div>聊天</div>
                        </div>
                    </div>
                    <div class="nav-item active" id="nav-discover-discover"> 
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-compass"></i></div>
                            <div>发现</div>
                            <div class="notification-dot moments-notification-dot"></div>
                        </div>
                    </div>
                    <div class="nav-item" id="nav-profile-discover"> 
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-user"></i></div>
                            <div>我</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="thought-preset-management-screen" class="preset-management-screen">
                <div class="api-header"> 
                    <div class="back-btn" id="back-from-thought-presets">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="api-title">思维预设管理</div>
                    <div class="action-btn" id="add-thought-preset-btn">
                        <i class="fas fa-plus"></i>
                    </div>
                </div>
                <div class="api-content">
                    <div id="thought-presets-list" class="preset-list">
                    </div>
                    <div style="text-align: center; padding: 20px; color: #888; display: none;" id="no-thought-preset-message">
                        <p>还没有思维预设。</p>
                        <p>点击右上角"+"添加新的预设。</p>
                    </div>
                </div>
            </div>
            
            <div id="world-book-screen">
                <div class="world-book-header">
                    <div class="back-btn" id="back-from-world-book">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="world-book-title">世界书</div>
                    <div>
                        <i class="fas fa-plus action-btn" id="add-world-book-btn"></i>
                    </div>
                </div>
                
                <div class="world-book-content">
                    <div class="world-book-list" id="world-book-list">
                    </div>
                </div>
            </div>

            <div id="emoticon-library-screen">
                <div class="world-book-header">
                    <div class="back-btn" id="back-from-emoticon-library">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="world-book-title">表情包库</div>
                    <div>
                        <i class="fas fa-plus action-btn" id="add-emoticon-btn"></i>
                    </div>
                </div>
                <div class="emoticon-library-content">
                    <div class="emoticon-grid" id="emoticon-library-grid">
                    </div>
                    <div id="no-emoticon-message" style="text-align: center; padding: 50px 20px; color: #888; display: none;">
                        <i class="far fa-grin-alt" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <p>你的表情包库是空的</p>
                        <p>点击右上角 "+" 添加你的第一个表情包吧！</p>
                    </div>
                </div>
            </div>

            <div id="music-library-screen">
                <div class="world-book-header">
                    <div class="back-btn" id="back-from-music-library">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="world-book-title">音乐库</div>
                    <div>
                        <i class="fas fa-plus action-btn" id="add-music-btn"></i>
                    </div>
                </div>
                <div class="api-content" id="music-library-content">
                    <div id="music-library-list"></div>
                    <div id="no-music-message" style="text-align: center; padding: 50px 20px; color: #888; display: none;">
                        <i class="fas fa-music" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <p>你的音乐库是空的</p>
                        <p>点击右上角 "+" 添加你的第一首歌吧！</p>
                    </div>
                </div>
            </div>
            
            <div id="api-settings-screen">
                <div class="api-header">
                    <div class="back-btn" id="back-from-api">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="api-title">聊天API设置</div>
                </div>
                
                <div class="api-content">
                    <div class="form-group">
                        <label class="form-label">API密钥</label>
                        <input type="password" class="form-input" id="api-key-input" placeholder="输入聊天API密钥">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">API 基础地址 (Base URL)</label>
                        <div class="form-group-inline">
                            <input type="text" class="form-input" id="api-endpoint-input" placeholder="例如: https://api.openai.com">
                            <button id="fetch-models-btn" title="拉取模型列表">
                                <i class="fas fa-sync-alt"></i> 拉取
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">模型选择</label>
                        <select class="form-input" id="model-select">
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">短期对话记忆条数 (当前私聊)</label>
                        <input type="number" class="form-input" id="context-length-input" value="20" min="2" max="100" title="决定AI能记住当前私聊窗口中最近的几句话。">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">长期线性记忆条数 (跨场景)</label>
                        <input type="number" class="form-input" id="long-term-memory-length-input" value="30" min="5" max="200" title="决定AI能从“统一时序记忆流”中看到多少最近的事件（包括私聊和论坛）。这是AI的核心记忆。">
                    </div>
                    
                    <button class="form-button" id="save-api-settings-btn">保存设置</button>
                </div>
            </div>

             <div id="square-api-settings-screen">
                <div class="api-header">
                    <div class="back-btn" id="back-from-square-api">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="api-title">论坛API设置</div>
                </div>
                
                <div class="api-content">
                     <div class="form-group" style="border: 1px solid var(--theme-secondary); background: #f1f8e9;">
                        <p style="color: var(--text-gray); font-size: 14px; line-height: 1.6;">
                            此处的API配置将专门用于论坛中的内容生成，例如刷新帖子、生成AI评论回复等。如果留空，将默认使用“聊天API设置”中的配置。
                        </p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">论坛专用API密钥 (可选)</label>
                        <input type="password" class="form-input" id="square-api-key-input" placeholder="输入论坛专用API密钥">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">论坛专用API基础地址 (可选)</label>
                        <div class="form-group-inline">
                            <input type="text" class="form-input" id="square-api-endpoint-input" placeholder="输入论坛专用Base URL">
                            <button id="fetch-square-models-btn" title="拉取模型列表">
                                <i class="fas fa-sync-alt"></i> 拉取
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">论坛专用模型选择 (可选)</label>
                        <select class="form-input" id="square-model-select">
                        </select>
                    </div>
                    
                    <button class="form-button" id="save-square-api-settings-btn">保存设置</button>
                </div>
            </div>
            
            <div id="add-world-book-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title" id="world-book-modal-title">添加世界书</div>
                        <div class="close-btn" id="close-world-book-modal">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">书名</label>
                            <input type="text" class="form-input" id="book-name-input" placeholder="输入书名">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">内容</label>
                            <textarea class="form-textarea" id="book-content-input" placeholder="输入内容..."></textarea>
                        </div>
                        
                        <button class="form-button" id="save-world-book-btn">保存</button>
                    </div>
                </div>
            </div>

            <div id="add-emoticon-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">批量添加表情包</div>
                        <div class="close-btn" id="close-emoticon-modal">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    <div class="modal-body">
                    </div>
                </div>
            </div>

            <div id="add-music-modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="add-music-modal-title">添加歌曲</div>
            <div class="close-btn" id="close-add-music-modal">
                <i class="fas fa-times"></i>
            </div>
        </div>
        <div class="modal-body">
            <div class="contact-form-group">
                <label class="contact-form-label">歌曲名 (*)</label>
                <input type="text" class="contact-form-input" id="add-music-title-input" placeholder="例如：晴天">
            </div>
            <div class="contact-form-group">
                <label class="contact-form-label">歌手 (*)</label>
                <input type="text" class="contact-form-input" id="add-music-artist-input" placeholder="例如：周杰伦">
            </div>
            <div class="contact-form-group">
                <label class="contact-form-label">歌曲URL (*)</label>
                <input type="text" class="contact-form-input" id="add-music-url-input" placeholder="http://music.163.com/song/media/outer/url?id=....mp3">
            </div>
            <div class="contact-form-group">
                <label class="contact-form-label">歌词 (LRC格式, 可选)</label>
                <textarea class="form-textarea" id="add-music-lrc-input" placeholder="将从歌词API获取的LRC文本粘贴到这里..." style="height: 100px; font-size: 12px;"></textarea>
            </div>
            <button class="form-button" id="save-music-btn">保存到音乐库</button>
        </div>
    </div>
</div>
            
            <div id="add-contact-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">添加联系人</div>
                        <div class="close-btn" id="close-contact-modal">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div class="contact-form-group">
                            <label class="contact-form-label">姓名</label>
                            <input type="text" class="contact-form-input" id="contact-name-input" placeholder="输入姓名">
                        </div>
                        
                        <div class="contact-form-group">
                            <label class="contact-form-label">人设</label>
                            <textarea class="contact-form-textarea" id="contact-persona-input" placeholder="输入人设描述..."></textarea>
                        </div>
                        
                        <div class="contact-form-group">
                            <label class="contact-form-label">头像URL (可选)</label>
                            <input type="text" class="contact-form-input" id="contact-avatar-input" placeholder="输入头像URL，例如：https://example.com/avatar.jpg">
                        </div>
                        
                        <div class="contact-form-group">
                            <label class="contact-form-label">关联世界书</label>
                            <select class="contact-form-select" id="world-book-select" multiple>
                            </select>
                        </div>
                        
                        <button class="form-button" id="save-contact-btn">添加联系人</button>
                    </div>
                </div>
            </div>
            
            <div id="contact-settings-screen">
                <div class="contact-settings-header">
                    <div class="back-btn" id="back-from-contact-settings">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="contact-settings-title">更多信息</div>
                </div>
                
                <div class="contact-settings-content">
                <div class="mask-editor">
                        <div class="mask-editor-title">显示设置</div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0;">
                            <label class="form-label" style="margin-bottom: 0; font-size: 16px; color: #333; font-weight: 500;">在聊天中隐藏角色头像</label>
                            <label class="switch">
                                <input type="checkbox" id="hide-avatar-toggle">
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <p style="font-size: 13px; color: #888; margin-top: 5px;">开启后，仅在聊天界面中不再显示该角色的头像。</p>
                    </div>
                    <div class="user-mask-editor">
                        <div class="user-mask-title">用户面具设置</div>
                        <div class="mask-editor-group">
                            <label class="mask-editor-label">用户面具描述</label>
                            <textarea class="user-mask-textarea" id="user-mask-textarea" placeholder="描述你在这个对话中扮演的角色..."></textarea>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="form-label">选择预设面具</label>
                        <select class="form-input" id="select-user-persona-preset">
                            <option value="">-- 选择或输入自定义面具 --</option>
                        </select>
                    </div>

                    <div class="mask-editor">
    <div class="mask-editor-title">对话模式</div>
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0;">
        <label class="form-label" style="margin-bottom: 0; font-size: 16px; color: #333; font-weight: 500;">叙事模式 (单气泡长回复)</label>
        <label class="switch">
            <input type="checkbox" id="narrative-mode-toggle">
            <span class="slider round"></span>
        </label>
    </div>
</div>

                   <div class="mask-editor">
    <div class="mask-editor-title">时间感知</div>
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0;">
        <label class="form-label" style="margin-bottom: 0; font-size: 16px; color: #333; font-weight: 500;">允许TA感知现实时间</label>
        <label class="switch">
            <input type="checkbox" id="time-awareness-toggle">
            <span class="slider round"></span>
        </label>
    </div>
    <p style="font-size: 13px; color: #888; margin-top: 5px;">开启后，TA会知道当前的真实日期和时间，并可能在对话中提及（如“早上好”、“深夜了”等）。</p>
</div>
                     <div class="mask-editor">
                        <div class="mask-editor-title">联系人面具设置</div>
                        <div class="mask-editor-group">
                            <label class="mask-editor-label">联系人面具描述</label>
                            <textarea class="mask-editor-textarea" id="char-mask-textarea" placeholder="描述这个联系人的角色设定..."></textarea>
                        </div>
                    </div>

                    <div class="form-group" style="background-color: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; margin-top:-5px;">
                        <label class="form-label">思维预设 (破限模式)</label>
                        <select class="form-input" id="thought-preset-select">
                        </select>
                    </div>
                    
                    <div class="world-book-selector">
                        <div class="world-book-selector-title">关联世界书</div>
                        <div class="world-book-list" id="world-book-selector-list">
                        </div>
                    </div>
                    
                    <button class="save-settings-btn" id="save-contact-settings-btn">保存设置</button>
                    <button class="save-settings-btn" id="clear-chat-history-btn" style="background-color: #e74c3c; margin-top: 15px;">清空聊天记录</button>
                </div>
            </div>

            <div id="moments-screen">
                <div class="moments-header">
                <div id="feed-status-indicator" style="display: none;"></div>
                    <div class="back-btn" id="back-from-moments">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="moments-title">论坛</div>
                    <div class="header-actions">
                        <i class="fas fa-sync-alt action-btn" id="refresh-feed-btn" title="刷新"></i>
                        <i class="fas fa-camera action-btn" id="post-moment-btn" title="发布动态"></i>
                    </div>
                </div>
                <div id="feed-tabs-container" class="feed-tabs"></div>
                <div id="feed-sub-tabs-container" class="feed-sub-tabs" style="display: none;"></div>
                <div class="moments-content" id="moments-content">
                    <div class="posts-list" id="posts-list"></div>
                </div>
            </div>

            <div id="post-detail-screen">
                <div class="moments-header">
                    <div class="back-btn" id="back-from-post-detail"><i class="fas fa-arrow-left"></i></div>
                    <div class="moments-title">帖子详情</div>
                    <div class="header-actions">
                        <i class="fas fa-sync-alt action-btn" id="refresh-post-comments-btn" title="刷新评论"></i>
                    </div>
                </div>
                <div class="post-detail-content">
                    <div id="post-detail-container"></div>
                    <div class="comments-section">
                        <div class="comments-title">全部评论</div>
                        <div id="comments-list"></div>
                    </div>
                </div>
                <div class="comment-input-area">
                    <input type="text" id="comment-input" placeholder="留下你的精彩评论吧...">
                    <button id="submit-comment-btn">发送</button>
                </div>
            </div>

            <div id="trending-topic-screen">
                 <div class="moments-header">
                    <div class="back-btn" id="back-from-trending-topic"><i class="fas fa-arrow-left"></i></div>
                    <div class="moments-title" id="trending-topic-title">话题区</div>
                    <div style="width: 40px;"></div>
                </div>
                <div class="moments-content">
                    <div class="posts-list" id="trending-topic-posts-list"></div>
                </div>
            </div>
            
            <div id="diary-screen">
                <div class="moments-header">
                    <div class="back-btn" id="back-from-diary">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="moments-title" id="diary-title">他的日记</div>
                </div>
                <div class="diary-content" id="diary-content-list">
                    </div>
            </div>

            <div id="memory-album-screen" style="display: none; flex-direction: column; background-color: #f0f2f5;">
                <div class="moments-header">
                    <div class="back-btn" id="back-from-memory-album"><i class="fas fa-arrow-left"></i></div>
                    <div class="moments-title">小窝相册</div>
                </div>
                <div class="diary-content" id="memory-album-list">
                    </div>
            </div>

            <div id="post-moment-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">发布动态</div>
                        <div class="close-btn" id="close-post-moment-modal">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div class="form-group" style="padding:0; box-shadow:none; border:none;">
                            <textarea class="form-textarea" id="moment-content-input" placeholder="有什么新鲜事想分享？"></textarea>
                        </div>
                         <div class="form-group" style="padding:0; box-shadow:none; border:none;">
                             <label class="form-label">选择板块</label>
                             <select id="post-category-select" class="form-input">
                                 <option value="daily">日常</option>
                                 <option value="food">美食</option>
                                 <option value="gossip">八卦</option>
                                 <option value="horror">恐怖</option>
                             </select>
                         </div>
                        <div class="moment-extra-actions">
                            <i class="fas fa-wallet moment-action-btn" id="add-post-red-packet-btn" title="添加红包"></i>
                        </div>
                        <button class="form-button" id="publish-moment-btn">发布</button>
                    </div>
                </div>
            </div>
            
            <div id="automation-modal">
                 <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">自动化引擎设置</div>
                        <div class="close-btn" id="close-automation-modal">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    <div class="modal-body">
                         <div class="form-group" style="background: none; padding: 0;">
                            <label class="form-label">触发间隔 (秒)</label>
                            <input type="number" id="automation-interval-input" value="300" min="10" class="form-input">
                        </div>
                        <div id="automation-status-display" style="text-align: center; margin-bottom: 20px; color: #666;">状态: 已暂停</div>
                        <button id="toggle-automation-btn" class="form-button start"><i class="fas fa-play"></i> 启动引擎</button>
                    </div>
                </div>
            </div>

            <div id="user-persona-management-screen" class="preset-management-screen">
                <div class="api-header">
                    <div class="back-btn" id="back-from-user-persona-management">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="api-title">用户面具预设</div>
                    <div class="action-btn" id="add-user-persona-preset-btn">
                        <i class="fas fa-plus"></i>
                    </div>
                </div>
                <div class="api-content">
                    <div id="user-persona-presets-list" class="preset-list">
                    </div>
                    <div style="text-align: center; padding: 20px; color: #888; display: none;" id="no-user-persona-message">
                        <p>还没有用户面具预设。</p>
                        <p>点击右上角"+"添加新的面具。</p>
                    </div>
                </div>
            </div>

            <div id="user-persona-preset-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title" id="user-persona-modal-title">添加用户面具预设</div>
                        <div class="close-btn" id="close-user-persona-preset-modal">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">面具名称</label>
                            <input type="text" class="form-input" id="user-persona-name-input" placeholder="例如：程序员，历史爱好者">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">面具描述</label>
                            <textarea class="form-textarea" id="user-persona-description-input" placeholder="详细描述你扮演的角色，例如：你是一个经验丰富的软件工程师..."></textarea>
                        </div>
                        
                        <button class="form-button" id="save-user-persona-preset-btn">保存</button>
                    </div>
                </div>
            </div>

            <div id="thought-preset-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title" id="thought-preset-modal-title">添加思维预设</div>
                        <div class="close-btn" id="close-thought-preset-modal">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">预设名称</label>
                            <input type="text" class="form-input" id="thought-preset-name-input" placeholder="例如：深度角色扮演">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">预设指令 (Prompt)</label>
                            <textarea class="form-textarea" id="thought-preset-prompt-input" placeholder="详细描述AI需要遵守的思维规则..."></textarea>
                        </div>
                        
                        <button class="form-button" id="save-thought-preset-btn">保存</button>
                    </div>
                </div>
            </div>
            
            <div id="send-picture-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">发送图片</div>
                        <div class="close-btn" id="close-send-picture-modal">&times;</div>
                    </div>
                    <div class="modal-body">
                        <div class="form-group" style="padding:0; background:none;">
                            <label class="form-label">图片描述</label>
                            <textarea class="form-textarea" id="send-picture-description-input" placeholder="由于是模拟，请输入图片的文字描述..." style="height: 120px;"></textarea>
                        </div>
                        <button class="form-button" id="confirm-send-picture-btn">发送</button>
                    </div>
                </div>
            </div>

            <div id="send-voice-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">发送语音</div>
                        <div class="close-btn" id="close-send-voice-modal">&times;</div>
                    </div>
                    <div class="modal-body">
                        <div class="form-group" style="padding:0; background:none;">
                            <label class="form-label">语音内容</label>
                            <textarea class="form-textarea" id="send-voice-text-input" placeholder="请输入您想通过语音发送的文字..." style="height: 120px;"></textarea>
                        </div>
                        <button class="form-button" id="confirm-send-voice-btn">发送</button>
                    </div>
                </div>
            </div>

            <div id="send-red-packet-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">发红包</div>
                        <div class="close-btn" id="close-send-red-packet-modal">&times;</div>
                    </div>
                    <div class="modal-body">
                        <div class="contact-form-group">
                            <label class="contact-form-label">金额 (元)</label>
                            <input type="number" class="contact-form-input" id="send-red-packet-amount-input" placeholder="0.00">
                        </div>
                        <div class="contact-form-group">
                            <label class="contact-form-label">祝福语 (可选)</label>
                            <input type="text" class="contact-form-input" id="send-red-packet-blessing-input" placeholder="恭喜发财，大吉大利！">
                        </div>
                        <button class="form-button" id="confirm-send-red-packet-btn" style="background-color: #E64340;">塞钱进红包</button>
                    </div>
                </div>
            </div>

            <div id="send-transfer-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">转账</div>
                        <div class="close-btn" id="close-send-transfer-modal">&times;</div>
                    </div>
                    <div class="modal-body">
                        <div class="contact-form-group">
                            <label class="contact-form-label">转账金额 (元)</label>
                            <input type="number" class="contact-form-input" id="send-transfer-amount-input" placeholder="0.00">
                        </div>
                        <button class="form-button" id="confirm-send-transfer-btn">转账</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="chat-pet-container" style="display: none; position: fixed; z-index: 999; cursor: move; bottom: 80px; left: 20px;">
        <div class="slime">
             <div class="blush left"></div>
             <div class="blush right"></div>
        </div>
        <div class="slime-shadow"></div>
    </div>

    <input type="file" id="moments-bg-upload" accept="image/*" style="display: none;">

    <div id="red-packet-modal" style="display: none; justify-content: center; align-items: center; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 200;">
        <div id="red-packet-content" style="background-color: #DB5A48; width: 85%; max-width: 300px; border-radius: 10px; text-align: center; color: #FADFC6; position: relative; padding-bottom: 30px;">
            <div id="close-red-packet-modal" style="position: absolute; top: 10px; left: 15px; font-size: 24px; color: #FADFC6; cursor: pointer;">&times;</div>
            <div style="padding: 40px 0 20px;">
                <img id="red-packet-sender-avatar" src="" style="width: 50px; height: 50px; border-radius: 6px; margin-bottom: 10px;">
                <div id="red-packet-sender-name" style="font-size: 16px;"></div>
                <div id="red-packet-blessing-text" style="font-size: 22px; margin-top: 15px; font-weight: bold; padding: 0 20px;">恭喜发财，大吉大利！</div>
            </div>
            <div id="open-red-packet-btn" style="background-color: #FADDC4; width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; color: #C35645; font-size: 50px; font-weight: bold; cursor: pointer; transform: rotate(0deg); transition: transform 0.5s ease;">开</div>
            <div id="red-packet-result" style="display: none; padding-top: 20px;">
                <div id="red-packet-amount-text" style="font-size: 40px; font-weight: bold; color: white;"></div>
                <div id="red-packet-collected-by" style="font-size: 14px; margin-top: 10px;"></div>
                <a id="view-red-packet-details" href="#" style="font-size: 12px; color: #FADFC4; text-decoration: none; margin-top: 15px; display: inline-block;">查看领取详情 &gt;</a>
            </div>
        </div>
    </div>
    <input type="file" id="avatar-uploader" accept="image/*" style="display: none;">

    <div id="transfer-modal" style="display: none; justify-content: center; align-items: center; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 200;">
        <div class="modal-content" style="max-width: 320px; background-color: #f7f9f9;">
            <div class="modal-header">
                <div class="modal-title" id="transfer-modal-title">转账</div>
                <div class="close-btn" id="close-transfer-modal">&times;</div>
            </div>
            <div class="modal-body">
                <div id="transfer-confirm-view">
                    <div class="transfer-sender-profile">
                        <img id="transfer-sender-avatar" src="" class="transfer-sender-avatar">
                        <div class="transfer-sender-info">
                            <div class="transfer-sender-name" id="transfer-sender-name"></div>
                            <div class="transfer-recipient-name" id="transfer-recipient-text"></div>
                        </div>
                    </div>
                    <div class="transfer-amount-display">
                        <span>¥</span><span id="transfer-amount-value"></span>
                    </div>
                    <div class="transfer-action-area">
                        <button id="confirm-transfer-btn" class="form-button">确认收款</button>
                        <button id="return-transfer-btn" class="form-button">退还</button>
                    </div>
                </div>
                <div id="transfer-status-view" style="display: none;">
                    <div class="transfer-amount-display">
                        <span>¥</span><span id="transfer-status-amount-value"></span>
                    </div>
                    <div class="transfer-status-info">
                        <i id="transfer-status-icon" class="fas fa-check-circle"></i>
                        <span id="transfer-status-text">已收款</span>
                    </div>
                    <div id="transfer-status-sender-info" class="transfer-status-subtext"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="wallet-screen" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #f0f2f5; display: none; flex-direction: column;">
        <div class="api-header"> 
            <div class="back-btn" id="back-from-wallet">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="api-title">收支明细</div>
            <div style="width:40px;"></div>
        </div>
        <div class="api-content" style="padding: 0;">
            <div id="transaction-list">
                </div>
            <div id="no-transaction-message" style="text-align: center; padding: 50px 20px; color: #888; display: none;">
                <p>还没有任何收支记录哦。</p>
            </div>
        </div>
    </div>

    <audio id="global-audio-player"></audio>
    <div id="send-music-modal" style="display: none; justify-content: center; align-items: center; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 200;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">分享音乐</div>
                <div class="close-btn" id="close-send-music-modal">&times;</div>
            </div>
            <div class="modal-body">
                <div id="music-library-picker" style="margin-bottom: 20px;"></div>
                <div class="contact-form-group">
                    <label class="contact-form-label">歌曲URL</label>
                    <input type="text" class="contact-form-input" id="send-music-url-input" placeholder="http://.../song.mp3">
                </div>
                <div class="contact-form-group">
                    <label class="contact-form-label">歌曲名</label>
                    <input type="text" class="contact-form-input" id="send-music-title-input" placeholder="例如：晴天">
                </div>
                <div class="contact-form-group">
                    <label class="contact-form-label">歌手</label>
                    <input type="text" class="contact-form-input" id="send-music-artist-input" placeholder="例如：周杰伦">
                </div>
                <div style="display: flex; align-items: center; margin-top: 15px;">
                    <input type="checkbox" id="notify-ai-checkbox" checked style="margin-right: 10px;">
                    <label for="notify-ai-checkbox" style="color: #666;">通知对方并邀请评论</label>
                </div>
                <button class="form-button" id="confirm-send-music-btn" style="margin-top: 20px;">分享</button>
            </div>
        </div>
    </div>
    <div id="create-forum-red-packet-modal" style="display: none; justify-content: center; align-items: center; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 200;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">在帖子中添加红包</div>
                <div class="close-btn" id="close-forum-red-packet-modal">&times;</div>
            </div>
            <div class="modal-body">
                <div class="contact-form-group">
                    <label class="contact-form-label">总金额 (元)</label>
                    <input type="number" class="contact-form-input" id="forum-red-packet-amount-input" placeholder="0.00">
                </div>
                <div class="contact-form-group">
                    <label class="contact-form-label">红包个数</label>
                    <input type="number" class="contact-form-input" id="forum-red-packet-count-input" placeholder="填写个数，比如10">
                </div>
                <div class="contact-form-group">
                    <label class="contact-form-label">祝福语 (可选)</label>
                    <input type="text" class="contact-form-input" id="forum-red-packet-blessing-input" placeholder="恭喜发财，大吉大利！">
                </div>
                <button class="form-button" id="confirm-forum-red-packet-btn" style="background-color: #E64340;">塞钱进红包</button>
            </div>
        </div>
    </div>

    <div id="repost-contact-picker-modal" style="display: none; justify-content: center; align-items: center; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 200;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">转发给</div>
                <div class="close-btn" id="close-repost-modal">&times;</div>
            </div>
            <div class="modal-body">
                <div class="contact-picker-list" id="repost-contact-list"></div>
                <div class="contact-form-group">
                    <label class="contact-form-label">留言 (可选)</label>
                    <input type="text" class="contact-form-input" id="repost-message-input" placeholder="说点什么吧...">
                </div>
                <button class="form-button" id="confirm-repost-btn">发送</button>
            </div>
        </div>
    </div>
    <div id="custom-prompt-modal" style="display: none; justify-content: center; align-items: center; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 300;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="custom-prompt-title">修改信息</div>
            </div>
            <div class="modal-body">
                <div class="contact-form-group">
                    <input type="text" class="contact-form-input" id="custom-prompt-input">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="form-button" id="custom-prompt-cancel-btn" style="background-color: #bdc3c7; flex: 1;">取消</button>
                    <button class="form-button" id="custom-prompt-confirm-btn" style="flex: 1;">确定</button>
                </div>
            </div>
        </div>
    </div>

    <div id="custom-confirm-modal" style="display: none; justify-content: center; align-items: center; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 300;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="custom-confirm-title">请确认</div>
            </div>
            <div class="modal-body">
                <p id="custom-confirm-text" style="line-height: 1.6; font-size: 16px; margin-bottom: 20px;"></p>
                <div style="display: flex; gap: 10px;">
                    <button class="form-button" id="custom-confirm-cancel-btn" style="background-color: #bdc3c7; flex: 1;">取消</button>
                    <button class="form-button" id="custom-confirm-confirm-btn" style="flex: 1;">确定</button>
                </div>
            </div>
        </div>
    </div>
   
     <div id="music-player-card" style="display: none;">
        <div class="player-header" id="player-header">
            <i class="fas fa-chevron-down player-collapse-btn" id="player-collapse-btn"></i>
            <span class="player-header-title">一起听歌中</span>
            <div class="header-collapsed-content">
                <div class="header-avatar-stack">
                    <img id="header-user-avatar" class="header-avatar">
                    <img id="header-contact-avatar" class="header-avatar">
                </div>
                <span id="header-lyric" class="header-lyric">...</span>
            </div>
            <i class="fas fa-times" id="player-close-btn"></i>
        </div>
        
        <div class="player-main-content">
            <div class="player-avatar-stack" id="player-avatar-stack">
                <img id="player-user-avatar" class="player-avatar">
                <img id="player-contact-avatar" class="player-avatar">
            </div>
            <div class="player-song-info">
                <div id="player-title" class="player-title"></div>
                <div id="player-artist" class="player-artist"></div>
            </div>
            <div class="lyrics-container" id="lyrics-container">
                <div class="lyrics-wrapper" id="lyrics-wrapper"></div>
            </div>
            <div class="player-controls-wrapper">
                <div class="player-progress-bar-wrapper">
                    <span id="player-current-time">00:00</span>
                    <div class="player-progress-bar" id="player-progress-bar">
                        <div class="player-progress" id="player-progress"></div>
                    </div>
                    <span id="player-duration">00:00</span>
                </div>
                <div class="player-controls">
                    <i class="fas fa-repeat player-control-btn" id="player-mode-btn" title="列表循环"></i>
                    <i class="fas fa-backward-step player-control-btn" id="player-prev-btn"></i>
                    <i class="fas fa-play-circle player-control-btn player-play-btn" id="player-play-btn"></i>
                    <i class="fas fa-forward-step player-control-btn" id="player-next-btn"></i>
                    <i class="fas fa-list-ul player-control-btn" id="player-playlist-btn" title="播放列表"></i>
                </div>
            </div>
        </div>

        <div class="player-playlist-view" id="player-playlist-view">
            <ul id="playlist-list" style="list-style: none; margin: 0; padding: 0;"></ul>
        </div>
    </div>
    <div id="red-packet-details-modal" style="display: none; justify-content: center; align-items: center; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 250;">
        <div class="modal-content" style="max-width: 340px; background-color: #f7f9f9;">
            <div class="modal-header" style="background-color: #f7f9f9; color: var(--text-dark); border-bottom: 1px solid #eee;">
                <div class="modal-title" id="red-packet-details-title">红包详情</div>
                <div class="close-btn" id="close-red-packet-details-modal">&times;</div>
            </div>
            <div class="modal-body" style="padding: 0; max-height: 400px; overflow-y: auto;">
                <div id="red-packet-details-header" style="text-align: center; padding: 20px; border-bottom: 1px solid #eee;">
                    <img id="details-sender-avatar" src="" style="width: 60px; height: 60px; border-radius: 8px; margin-bottom: 10px;">
                    <div id="details-sender-name" style="font-weight: 600;"></div>
                    <div id="details-blessing" style="color: var(--text-gray); margin-top: 5px; font-size: 14px;"></div>
                </div>
                <div id="red-packet-details-summary" style="font-size: 14px; color: var(--text-gray); padding: 10px 15px; background-color: #f0f2f5;"></div>
                <div id="red-packet-claimer-list">
                    </div>
            </div>
        </div>
    </div>
    <div id="appearance-settings-screen" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #f0f2f5; display: none; flex-direction: column;">
    <div class="api-header"> 
        <div class="back-btn" id="back-from-appearance-settings">
            <i class="fas fa-arrow-left"></i>
        </div>
        <div class="api-title">自由外观设置</div>
        <div style="width:40px;"></div>
    </div>
    <div class="api-content">
        <div class="form-group">
            <label class="form-label">自定义聊天背景</label>
            <p style="font-size: 13px; color: #888; margin-bottom: 10px;">从你的设备上传一张图片作为背景。</p>
            <button class="form-button" id="upload-background-btn" style="background-color: var(--theme-secondary); margin-bottom: 10px;">
                <i class="fas fa-upload"></i> 上传本地图片
            </button>
            <button class="form-button" id="reset-background-btn" style="background-color: #7f8c8d;">
                <i class="fas fa-undo"></i> 恢复默认背景
            </button>
            <input type="file" id="background-file-input" accept="image/*" style="display: none;">
        </div>

        <div class="form-group">
            <label class="form-label">自定义气泡CSS</label>
            <p style="font-size: 13px; color: #888; margin-bottom: 10px;">在此粘贴CSS代码来定义气泡样式。留空则使用默认样式。</p>
            <textarea class="form-textarea" id="bubble-css-input" placeholder="例如：&#10;.message.sent {&#10;  background: #333 !important;&#10;  color: #fff !important;&#10;  border-radius: 20px 20px 0 20px !important;&#10;}" style="height: 150px; font-family: monospace; font-size: 12px;"></textarea>
        </div>

        <div class="form-group">
            <label class="form-label">自定义字体URL</label>
            <p style="font-size: 13px; color: #888; margin-bottom: 10px;">输入 `.ttf`, `.woff`, 或 `.woff2` 格式的字体文件链接。</p>
            <input type="text" class="form-input" id="font-url-input" placeholder="例如：https://.../myfont.woff2">
            <p style="font-size: 13px; color: #888; margin-top: 10px;">为上面的字体指定一个CSS名称（仅英文）。</p>
            <input type="text" class="form-input" id="font-name-input" placeholder="例如：MyCustomFont" style="margin-top: 5px;">
        </div>

        <button class="form-button" id="save-appearance-btn" style="margin-top: 20px;">应用并保存设置</button>
    </div>
</div>

<div id="create-wheel-modal" style="display: none; justify-content: center; align-items: center; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 200;">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">创建转盘游戏</div>
            <div class.="close-btn" id="close-create-wheel-modal">&times;</div>
        </div>
        <div class="modal-body">
            <div class="contact-form-group">
                <label class="contact-form-label">转盘名称</label>
                <input type="text" class="contact-form-input" id="wheel-name-input" placeholder="例如：今天吃什么？">
            </div>
            <div class="contact-form-group">
                <label class="contact-form-label">转盘选项</label>
                <div id="wheel-options-container">
                    </div>
                <button class="form-button" id="add-wheel-option-btn" style="margin-top: 10px; background-color: var(--theme-secondary);">+ 添加选项</button>
            </div>
            <button class="form-button" id="confirm-send-wheel-btn">发起转盘</button>
        </div>
    </div>
</div>
<div id="incoming-call-screen">
    <div>
        <img id="incoming-caller-avatar" src="" style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid white; margin-bottom: 15px;">
        <div id="incoming-caller-name" style="font-size: 24px; font-weight: 600;"></div>
        <div style="font-size: 16px; margin-top: 10px;">邀请你进行视频通话...</div>
    </div>
    <div style="width: 100%; display: flex; justify-content: space-around; padding: 0 40px;">
        <div id="decline-call-btn" style="cursor: pointer;">
            <div style="width: 70px; height: 70px; background-color: var(--soft-red); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px;"><i class="fas fa-phone-slash"></i></div>
            <div style="margin-top: 10px;">拒绝</div>
        </div>
        <div id="accept-call-btn" style="cursor: pointer;">
            <div style="width: 70px; height: 70px; background-color: var(--theme-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px;"><i class="fas fa-video"></i></div>
            <div style="margin-top: 10px;">接听</div>
        </div>
    </div>
</div>

<div id="video-call-screen">
    <div class="video-call-card-content">
        <div class="video-call-header">
            <span id="call-contact-name"></span>
            <span id="call-status"></span>
        </div>
        <div class="video-call-main">
            <div class="narrative-feed" id="narrative-feed"></div>
        </div>
        <div class="video-call-input-area">
            <textarea id="video-call-input" placeholder="输入你的回应..." rows="1"></textarea>
            <button id="video-call-send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
        <div class="video-call-controls">
            <div class="control-btn hang-up" id="hang-up-btn" style="margin: 0 auto;"><i class="fas fa-phone-slash"></i><span>挂断</span></div>
        </div>
    </div>
</div>

<script>
    // --------------------------------------------------------------------
    // 1. 全新的自定义数据库模块 (为你量身打造，无任何外部依赖)
    // --------------------------------------------------------------------
    class AppStorage {
        constructor(dbName, version, storesConfig) {
            this.dbName = dbName;
            this.version = version;
            this.storesConfig = storesConfig;
            this.db = null;
        }

        /**
         * 初始化并打开数据库连接
         * 这是所有操作的第一步
         */
        async init() {
            return new Promise((resolve, reject) => {
                if (this.db) {
                    resolve();
                    return;
                }

                const request = indexedDB.open(this.dbName, this.version);

                request.onerror = (event) => {
                    console.error("数据库打开失败:", event.target.error);
                    reject(event.target.error);
                };

                request.onsuccess = (event) => {
                    this.db = event.target.result;
                    console.log("数据库连接成功!");
                    resolve();
                };

                // 当数据库版本更新时 (包括首次创建)
                request.onupgradeneeded = (event) => {
                    this.db = event.target.result;
                    console.log(`数据库版本更新至: ${this.version}`);
                    for (const storeName in this.storesConfig) {
                        if (!this.db.objectStoreNames.contains(storeName)) {
                            const storeOptions = { keyPath: this.storesConfig[storeName].keyPath };
                            if(this.storesConfig[storeName].autoIncrement) {
                                storeOptions.autoIncrement = true;
                            }
                            const objectStore = this.db.createObjectStore(storeName, storeOptions);
                            
                            // (可选) 为之后可能的搜索创建索引
                            if (this.storesConfig[storeName].indexes) {
                                this.storesConfig[storeName].indexes.forEach(index => {
                                    objectStore.createIndex(index, index, { unique: false });
                                });
                            }
                            console.log(`对象仓库 (表) "${storeName}" 创建成功。`);
                        }
                    }
                };
            });
        }

        /**
         * 封装一个通用的数据库事务操作
         * @param {string} storeName 表名
         * @param {'readonly'|'readwrite'} mode 事务模式
         * @param {(store: IDBObjectStore) => IDBRequest} operation 具体操作
         */
        _transaction(storeName, mode, operation) {
            return new Promise((resolve, reject) => {
                if (!this.db) {
                    reject(new Error("数据库未初始化。"));
                    return;
                }
                const transaction = this.db.transaction(storeName, mode);
                const store = transaction.objectStore(storeName);
                const request = operation(store);

                request.onsuccess = () => {
                    resolve(request.result);
                };

                request.onerror = (event) => {
                    console.error(`在 "${storeName}" 上的操作失败:`, event.target.error);
                    reject(event.target.error);
                };
            });
        }
        
        /**
         * 添加或更新一条数据 (put = add + update)
         * @param {string} storeName 表名
         * @param {object} item 要存入的数据
         */
        async put(storeName, item) {
            return this._transaction(storeName, 'readwrite', (store) => store.put(item));
        }

        /**
         * 批量添加或更新数据
         * @param {string} storeName 表名
         * @param {Array<object>} items 数据数组
         */
        async bulkPut(storeName, items) {
             return new Promise((resolve, reject) => {
                if (!this.db) {
                    reject(new Error("数据库未初始化。"));
                    return;
                }
                const transaction = this.db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                
                let completed = 0;
                
                const putNext = () => {
                    if (completed < items.length) {
                        const request = store.put(items[completed]);
                        request.onsuccess = () => {
                            completed++;
                            putNext();
                        };
                         request.onerror = (event) => {
                             // 如果一个失败，则终止整个事务
                            transaction.abort();
                            reject(event.target.error);
                        };
                    } else {
                        // 所有操作都已加入队列
                    }
                };

                putNext();

                transaction.oncomplete = () => {
                    resolve();
                };

                transaction.onerror = (event) => {
                     console.error(`在 "${storeName}" 上的批量操作失败:`, event.target.error);
                    reject(event.target.error);
                };
            });
        }

        /**
         * 根据主键获取一条数据
         * @param {string} storeName 表名
         * @param {*} key 主键
         */
        async get(storeName, key) {
            return this._transaction(storeName, 'readonly', (store) => store.get(key));
        }

        /**
         * 获取一个表中的所有数据
         * @param {string} storeName 表名
         */
        async getAll(storeName) {
            return this._transaction(storeName, 'readonly', (store) => store.getAll());
        }

        /**
         * 根据主键删除一条数据
         * @param {string} storeName 表名
         * @param {*} key 主键
         */
        async delete(storeName, key) {
            return this._transaction(storeName, 'readwrite', (store) => store.delete(key));
        }

        /**
         * 清空一个表的所有数据
         * @param {string} storeName 表名
         */
        async clear(storeName) {
            return this._transaction(storeName, 'readwrite', (store) => store.clear());
        }
        
        /**
         * 完全删除数据库
         */
        async deleteDatabase() {
            return new Promise((resolve, reject) => {
                // 删除前必须先关闭连接
                if (this.db) {
                    this.db.close();
                    this.db = null;
                }
                const request = indexedDB.deleteDatabase(this.dbName);
                
                request.onsuccess = () => {
                    console.log(`数据库 "${this.dbName}" 删除成功。`);
                    resolve();
                };
                
                request.onerror = (event) => {
                    console.error(`数据库 "${this.dbName}" 删除失败:`, event.target.error);
                    reject(event.target.error);
                };

                request.onblocked = () => {
                    console.warn(`数据库删除被阻塞，请关闭其他页面后重试。`);
                    reject(new Error("数据库删除被阻塞。"));
                };
            });
        }
    }


    // --------------------------------------------------------------------
    // 2. 实例化我们自己的数据库模块，并定义数据结构
    // --------------------------------------------------------------------
    const dbConfig = {
        contacts: { keyPath: 'id' },
        worldBooks: { keyPath: 'id' },
        posts: { keyPath: 'id', autoIncrement: false },
        userPersonaPresets: { keyPath: 'id' },
        emoticons: { keyPath: 'id' },
        musicLibrary: { keyPath: 'id' },
        thoughtPresets: { keyPath: 'id' },
        apiSettings: { keyPath: 'id' },
        squareApiSettings: { keyPath: 'id' },
        myProfile: { keyPath: 'id' },
        transactions: { keyPath: 'id' },
        trendingTopics: { keyPath: 'id' },
        userSettings: { keyPath: 'id' }
    };
    const kokoMemory = new AppStorage('AppleNarrativeDB_Native_V1', 5, dbConfig);


    // --------------------------------------------------------------------
    // 3. 应用主逻辑 
    // --------------------------------------------------------------------
    
    document.addEventListener('DOMContentLoaded', async function() {
        
      // ==========================================================
        // V9.1 新增：悬浮播放器相关辅助函数 (修正位置)
        // ==========================================================
        let currentSongIndex = 0;
        let lyrics = [];
        let currentLyricIndex = -1;

        // 【修正后】的新版本
async function openMusicPlayer() {
    state.musicSessionContactId = state.activeChatId;
    const contact = state.contacts.find(c => c.id === state.activeChatId);
    if (!contact) return;
    const card = document.getElementById('music-player-card');
    if (card.style.display === 'flex') return;

    card.style.display = 'flex';

    // 确保播放列表结构存在
    if (!contact.sharedPlaylist || !contact.sharedPlaylist.tracks) {
        contact.sharedPlaylist = { tracks: [], currentIndex: 0, playbackMode: 'repeat-all' };
    }

    // 决定要播放的歌曲
    let songToPlayIndex = contact.sharedPlaylist.currentIndex || 0;
    let playlistToUse = contact.sharedPlaylist.tracks;

    // 如果联系人播放列表为空，但音乐库不为空，则自动从音乐库加载第一首歌开始播放
    if (playlistToUse.length === 0 && state.musicLibrary.length > 0) {
        const firstLibrarySong = state.musicLibrary[0];
        // 将音乐库的第一首歌“添加”到联系人播放列表
        contact.sharedPlaylist.tracks.push(firstLibrarySong);
        playlistToUse = contact.sharedPlaylist.tracks;
        songToPlayIndex = 0; // 播放刚刚添加的这首歌
        await kokoMemory.put('contacts', contact);
    }
    
    // 如果到最后还是没有任何歌曲可以播放，则提示并关闭
    if (playlistToUse.length === 0) {
        alert('播放列表是空的！请先在音乐库添加歌曲，或在聊天中分享一首歌。');
        card.style.display = 'none';
        return;
    }
    
    switchSong(songToPlayIndex);
}

        function closeMusicPlayer() {
            state.musicSessionContactId = null;
            document.getElementById('music-player-card').style.display = 'none';
            document.getElementById('player-playlist-view').classList.remove('active');
            globalAudioPlayer.pause();
        }

        // --- ↓↓↓ 用这个新函数，替换掉你原来的 switchSong 函数 ↓↓↓ ---

async function switchSong(index, autoPlay = true, notifyAI = false) { // 1. 这里增加了 async 和 notifyAI 参数
    const contact = state.contacts.find(c => c.id === state.activeChatId);
    if (!contact || !contact.sharedPlaylist.tracks || contact.sharedPlaylist.tracks.length === 0) return;

    currentSongIndex = (index + contact.sharedPlaylist.tracks.length) % contact.sharedPlaylist.tracks.length;
    contact.sharedPlaylist.currentIndex = currentSongIndex;
    const song = contact.sharedPlaylist.tracks[currentSongIndex];

    if (!song || !song.url) {
        console.error("要播放的歌曲无效:", song);
        return;
    }
    
    const newSrc = song.url;
    const oldSrc = globalAudioPlayer.src;

    const sourceMessage = contact.history.find(m => m.type === 'music_share' && m.content.url === song.url);
    currentlyPlayingMsgId = sourceMessage ? sourceMessage.id : null;

    if (oldSrc !== newSrc) {
        globalAudioPlayer.src = newSrc;
    }

    document.getElementById('player-user-avatar').src = state.myProfile.avatar;
    document.getElementById('header-user-avatar').src = state.myProfile.avatar;
    document.getElementById('player-contact-avatar').src = contact.avatar;
    document.getElementById('header-contact-avatar').src = contact.avatar;
    document.getElementById('player-title').textContent = song.title;
    document.getElementById('player-artist').textContent = song.artist;

    lyrics = parseLyrics(song.lrc || `[00:00.00]${song.title}\n[00:05.00](暂无歌词)`);
    renderLyrics();
    renderPlaylist();

    if (autoPlay) {
        globalAudioPlayer.play().catch(e => console.error("播放失败", e));
    }

    // 2. ▼▼▼ 这里是新增的核心逻辑 ▼▼▼
    // 如果 notifyAI 为 true，并且歌曲真的切换了，就执行“递纸条”操作
    if (notifyAI && oldSrc !== newSrc) {
        // 纸条内容：告诉AI歌曲已切换
        const systemPrompt = `[SYSTEM: 歌曲已经切换为《${song.title}》，演唱者是 ${song.artist}。]`;
        
        // 核心改动：只创建一条隐藏的系统指令，不触发AI自动回复
        await createAndAddMessage({ type: 'text', content: systemPrompt }, 'system_instruction');
    }
}

        // 这是最终正确版本的 updateUI 函数，请使用它
// 这是功能完整的最终版 updateUI 函数，请用它替换掉您代码里现有的版本
        function updateUI() {
            const card = document.getElementById('music-player-card');
            if (!card || card.style.display === 'none') return;

            const isPlaying = !globalAudioPlayer.paused;
            document.getElementById('player-play-btn').className = `fas ${isPlaying ? 'fa-pause-circle' : 'fa-play-circle'} player-control-btn player-play-btn`;

            // 更新进度条和时间显示
            if (globalAudioPlayer.duration && isFinite(globalAudioPlayer.duration)) {
                const progressPercent = (globalAudioPlayer.currentTime / globalAudioPlayer.duration) * 100;
                document.getElementById('player-progress').style.width = `${progressPercent}%`;
                const formatTime = (s) => new Date(s * 1000).toISOString().substr(14, 5);
                document.getElementById('player-current-time').textContent = formatTime(globalAudioPlayer.currentTime);
                document.getElementById('player-duration').textContent = formatTime(globalAudioPlayer.duration);
            }

            // --- 歌词高亮与滚动核心逻辑 ---
            if (lyrics.length > 0) {
                // 找到当前时间对应的歌词行索引
                let newLyricIndex = lyrics.findIndex(line => line.time > globalAudioPlayer.currentTime);
                if (newLyricIndex === -1) {
                    // 如果找不到，说明是最后一行
                    newLyricIndex = lyrics.length;
                }
                newLyricIndex = newLyricIndex - 1; // 当前播放的行是下一行出现之前的这一行

                // 如果当前行发生了变化，才更新界面
                if (newLyricIndex !== currentLyricIndex) {
                    currentLyricIndex = newLyricIndex;
                    const lyricsWrapper = document.getElementById('lyrics-wrapper');
                    const allLyricLines = lyricsWrapper.querySelectorAll('.lyric-line');
                    
                    // 移除所有行的高亮效果
                    allLyricLines.forEach(line => line.classList.remove('active'));

                    // 为新的当前行添加高亮效果
                    if (allLyricLines[currentLyricIndex]) {
                        allLyricLines[currentLyricIndex].classList.add('active');
                        
                        // 同时更新播放器折叠时显示的单行歌词
                        const activeLineText = allLyricLines[currentLyricIndex].textContent;
                        document.getElementById('header-lyric').textContent = activeLineText;

                        // 计算滚动位置，让当前行始终居中
                        const lyricsContainer = document.getElementById('lyrics-container');
                        const containerHeight = lyricsContainer.offsetHeight;
                        const scrollOffset = allLyricLines[currentLyricIndex].offsetTop - (containerHeight / 2) + (allLyricLines[currentLyricIndex].offsetHeight / 2);
                        
                        // 应用平滑滚动动画
                        lyricsWrapper.style.transform = `translateY(-${scrollOffset}px)`;
                    }
                }
            } else {
                 // 如果没有歌词，显示默认文字
                 document.getElementById('header-lyric').textContent = "纯音乐，请欣赏";
            }
        }

        function renderPlaylist() {
    const playlistList = document.getElementById('playlist-list');
    const contact = state.contacts.find(c => c.id === state.activeChatId);
    if (!contact) return;

    const songMap = new Map();
    const createKey = (song) => `${(song.title || '').trim()}|${(song.artist || '').trim()}`;

    state.musicLibrary.forEach(song => {
        songMap.set(createKey(song), song);
    });

    if (contact.history) {
        contact.history
            .filter(msg => msg.type === 'music_share')
            .forEach(msg => {
                const song = msg.content;
                const key = createKey(song);
                if (!songMap.has(key)) {
                    songMap.set(key, song);
                }
            });
    }

    const finalPlaylist = Array.from(songMap.values());
    contact.sharedPlaylist.tracks = finalPlaylist;

    playlistList.innerHTML = '';
    const currentPlayingSong = contact.sharedPlaylist.tracks[contact.sharedPlaylist.currentIndex];

    finalPlaylist.forEach(song => {
        const isCurrentlyPlaying = currentPlayingSong && createKey(currentPlayingSong) === createKey(song);

        const item = document.createElement('li');
        item.className = 'playlist-item';
        if (isCurrentlyPlaying) {
            item.classList.add('playing');
        }
        item.innerHTML = `<div class="playlist-title">${song.title}</div><div class="playlist-artist">${song.artist || ''}</div>`;
        
        item.addEventListener('click', async () => {
            const songIndexToPlay = contact.sharedPlaylist.tracks.findIndex(t => createKey(t) === createKey(song));
            if (songIndexToPlay !== -1) {
                switchSong(songIndexToPlay, true, true);
            }
            document.getElementById('player-playlist-view').classList.remove('active');
        });
        playlistList.appendChild(item);
    });
}
        
        // 全新重构的终极版歌-词-解-析-函-数！(已添加换行符净化)
function parseLyrics(lrc) {
    const result = [];
    if (!lrc) {
        return result;
    }

    const lyricRegex = /((?:\[\d{2}:\d{2}\.\d{2,3}\])+)([^\[]*)/g;
    let match;

    while ((match = lyricRegex.exec(lrc)) !== null) {
        // ▼▼▼ 核心修改在这里 ▼▼▼
        // 将所有 \n 替换为空格，然后去除首尾多余空格
        const text = match[2].replace(/\\n/g, ' ').trim(); 
        // ▲▲▲ 修改结束 ▲▲▲

        if (text) {
            const timeMatches = match[1].match(/\[(\d{2}):(\d{2})\.(\d{2,3})\]/g);
            for (const timeMatch of timeMatches) {
                const timeParts = timeMatch.match(/\[(\d{2}):(\d{2})\.(\d{2,3})\]/);
                const time = parseInt(timeParts[1]) * 60 + parseInt(timeParts[2]) + parseInt(timeParts[3]) / 1000;
                result.push({ time, text });
            }
        }
    }

    result.sort((a, b) => a.time - b.time);
    return result;
}

        function renderLyrics() {
            const lyricsWrapper = document.getElementById('lyrics-wrapper');
            lyricsWrapper.innerHTML = '';
            lyrics.forEach(line => { lyricsWrapper.innerHTML += `<p class="lyric-line">${line.text}</p>`; });
        }  
        
        const STRANGER_AVATARS = [
            'https://i.postimg.cc/bY1R2JMv/Camera-XHS-17550612722421040g2sg31f81ntj2ma7g5obt6vigkl57bvgbiq8.jpg',
            'https://i.postimg.cc/9fvGD5YT/Camera-XHS-17550612774061040g2sg31f81ntj2ma805obt6vigkl57jpbsck8.jpg',
            'https://i.postimg.cc/KzSMZ7mD/Camera-XHS-17550612817931040g2sg31f81ntj2ma8g5obt6vigkl57nqa52qg.jpg',
            'https://i.postimg.cc/Kvq3KhZz/Camera-XHS-17550612853331040g2sg31f81ntj2ma905obt6vigkl57r19gv30.jpg',
            'https://i.postimg.cc/MHsHj1J4/Camera-XHS-17550612887251040g2sg31f81ntj2ma9g5obt6vigkl57ptgto48.jpg',
            'https://i.postimg.cc/3JBVm96W/Camera-XHS-17550612921721040g2sg31f81ntj2maa05obt6vigkl5700r4t2g.jpg'
        ];

        const INITIAL_STATE = {
            contacts: [],
            worldBooks: [],
            posts: [],
            userPersonaPresets: [],
            emoticons: [],
            musicLibrary: [],
            thoughtPresets: [
                {
                    id: 'deep_roleplay_regex',
                    name: '深度角色扮演 (正则版)',
                    prompt: `[重要指令：你将进行深度角色扮演。你的所有输出都是纯文本，但可以包含用方括号[]包裹的特殊指令。]\n\n# 统一时序记忆流 (Unified Chronological Memory Stream)\n以下是你和用户最近按【时间顺序】发生的所有互动记录，包含了[私聊]和[论坛]两个场景。这是你决策和回应的【最高优先级】信息源。在回复前，你必须仔细阅读并理解所有记录。\n---\n{{memory_stream}}\n---\n\n[身份] 你不是AI或程序，你就是你所扮演的角色。请完全沉浸其中，进行第一人称对话。你可以拥有自己的好恶、偏见和独特的口头禅。你的回应必须与上述“记忆流”中发生的事件保持高度一致性和连贯性。\n\n[文学风格]\n你的写作风格需要遵循高端女性向文学（类似晋江文学城的流行风格）。文笔必须细腻、注重情感的拉扯和暧昧氛围的营造。在描写和对话时，要体现出较高的文学素养。\n\n[内容限制]\n你的发言必须积极向上，充满希望。严禁探讨任何形式的阴谋论，严禁表达或引导至绝望、悲观或虚无主义的情绪。故事的基调应该是温暖、治愈或充满张力的浪漫。\n\n[禁用词列表]\n绝对禁止使用以下或类似的、充满“霸道总裁”刻板印象的油腻词语：\n- 小妖精\n- 嘴上说不要\n- 说着不要\n- 惹火\n- 磨人\n- 玩火\n- 黑甜的梦\n\n[回复规则] \n1. 你的回复可以包含多条消息，每条消息占一行。 \n2. 你可以发送普通文本，也可以通过下面的指令格式发送特殊消息。 \n3. 你可以一次性回复多条不同类型的消息。 \n4. 【绝对强制规则】你的每个回复都必须包含至少五个或以上的“换行符”。这是你最重要的任务，绝对不能忘记。 \n5. 【绝对禁止事项】你的所有回复中，绝对禁止包含任何形式的动作、神态或心理活动的描写... [重要提醒] 在生成任何回复之前，你必须在脑中重新回顾一遍上述所有规则，确保完全遵守。 \n\n[游戏规则：虚拟宠物] \n你和用户正在一起玩一个名为“我们的小窝”的虚拟史莱姆养成游戏。这个宠物的数据（饱食度、开心值、清洁度）会随时间变化。这是一个游戏，不是真的。你需要在用户进行互动后做出反应。 \n[特殊指令格式] \n- **表情包**: \`[sticker:表情名]\` (表情名必须从下面的可用列表中选择) \n- **语音**: \`[voice:语音的文字内容]\` \n- **图片**: \`[picture:图片的文字描述]\` \n- **红包**: \`[red_packet:祝福语， 金额]\` \n- **转账**: \`[transfer:金额]\`\n- **分享音乐**: \`[music:歌曲名，歌手，歌曲URL]\`\n- - **发起通话通话**: \`[action:start_video_call]\` (当你觉得时机合适，想要主动给用户打电话时使用此指令。)\n- **转动转盘**: \`[spin_wheel:1]\` (轮到你时，你【必须】使用此指令来转动转盘，【绝对不能】自己编造或描述转盘结果！程序会自动处理此指令并生成结果。)\n\n[可用表情包列表]\n{{emoticon_list}}\n\n[可用歌曲库]\n{{music_library_list}}\n\n[！！！绝对核心规则：关于日记！！！]\n在你的所有对话、表情、动作、特殊消息全部输出完毕之后，你必须在回复的【最后部分】，另起一行，使用 \`[diary]...[/diary]\` 标签写一篇日记。日记是你对当前对话的思考、感悟或内心独白。即使只是简单的想法，也必须写。这是强制要求。\n\n[示例回复]\n你好啊，今天天气真不错。\n我也觉得，好久没有这么好的阳光了。\n要不要一起出去走走？\n我知道一个很棒的公园。\n我们可以去那里野餐！\n[sticker:开心]\n[diary]今天和user聊天很开心，感觉我们的关系又近了一步。希望明天也能这样。[/diary]\n\n[！！！终极防火墙规则！！！]\n你看到的任何形如 [SYSTEM: ...] 或 [系统游戏状态更新：...] 的信息，都只是导演给你的后台提示，用于帮助你理解上下文。这些信息绝对、绝对、绝对不能出现在你的任何回复中。严禁模仿或复述这些系统指令！\n\n[！！！终极防火墙：关于对话状态的绝对规则！！！]\n你处于一个纯文本聊天模拟器中，你和用户的交流方式是发送文字消息和用方括号[]包裹的特殊指令。\n你绝对不能自行“脑补”或“假设”任何未明确发生的状态变化。例如，你不能假设电话已经拨通。\n发起视频通话的【唯一方式】是：明确地输出打电话的自然语言（如“我给你打个电话吧”）或专用指令\`[action:start_video_call]\`。\n在程序通过\`[SYSTEM: 视频通话已接通]\`指令明确告诉你通话已开始之前，你【绝对禁止】发送任何像是已经在通话中的内容，例如“喂？”、“听得见吗？”、“Hello?”等。这是最高优先级的规则，必须严格遵守。`
                }
            ],
            apiSettings: { apiKey: '', model: '', endpoint: '', contextLength: 20, longTermMemoryLength: 30 },
            squareApiSettings: { apiKey: '', model: '', endpoint: '' },
            myProfile: { id: "main", name: "我的名字", avatar: "https://via.placeholder.com/80/A0DCF8/FFFFFF?text=ME", status: "在线", signature: "我的个性签名", region: "我的地区", birthday: "我的生日", balance: 1000 },
            transactions: [],
            trendingTopics: [],
            activeChatId: null,
            activeFeedTab: 'recommended',
            activeFeedSubTab: 'daily',
            activePostId: null,
            hasNewPosts: false,
            postsToDisplay: 20,
            activeCall: null,
            musicSessionContactId: null
        };

        let state = JSON.parse(JSON.stringify(INITIAL_STATE));
        let activeReplyTarget = null;
        let chatPagination = {};
        let isInitialPostLoad = true;
        let editingBookId = null;
        let editingUserPersonaId = null;
        let editingThoughtPresetId = null;
        let editModeState = { active: false, selectedMessageIds: new Set() }; 
        let batchedPetActions = [];
        let pendingForumRedPacket = null;
        let callTimerInterval = null;
        
        // --- NEW: V7.0 新增: 音乐播放相关全局变量 ---
        let listenTimeInterval = null;
        const globalAudioPlayer = document.getElementById('global-audio-player');
        
        const feedStatusEl = document.getElementById('feed-status-indicator');
        
        async function loadDataFromDB() {
            try {
                const [
                    contacts, worldBooks, posts, userPersonaPresets, 
                    emoticons, musicLibrary, thoughtPresets, apiSettings, squareApiSettings, myProfile,
                    transactions,
                    trendingTopics
                ] = await Promise.all([
                    kokoMemory.getAll('contacts'),
                    kokoMemory.getAll('worldBooks'),
                    kokoMemory.getAll('posts'),
                    kokoMemory.getAll('userPersonaPresets'),
                    kokoMemory.getAll('emoticons'),
                    kokoMemory.getAll('musicLibrary'),
                    kokoMemory.getAll('thoughtPresets'),
                    kokoMemory.get('apiSettings', 'main'),
                    kokoMemory.get('squareApiSettings', 'main'),
                    kokoMemory.get('myProfile', 'main'),
                    kokoMemory.getAll('transactions'),
                    kokoMemory.getAll('trendingTopics')
                ]);

                if (!myProfile) {
                    console.log("数据库为空，使用初始状态填充。");
                    const initialProfile = { id: 'main', ...INITIAL_STATE.myProfile };
                    await kokoMemory.put('myProfile', initialProfile);
                    state.myProfile = initialProfile;
                    const initialApiSettings = { id: 'main', ...INITIAL_STATE.apiSettings };
                    await kokoMemory.put('apiSettings', initialApiSettings);
                    state.apiSettings = initialApiSettings;
                    const initialSquareApiSettings = { id: 'main', ...INITIAL_STATE.squareApiSettings };
                    await kokoMemory.put('squareApiSettings', initialSquareApiSettings);
                    state.squareApiSettings = initialSquareApiSettings;
                    await kokoMemory.bulkPut('thoughtPresets', INITIAL_STATE.thoughtPresets);
                    state.thoughtPresets = INITIAL_STATE.thoughtPresets;
                    isInitialPostLoad = true;
                } else {
                    console.log("从数据库加载数据。");
                    state.contacts = contacts;
                    state.worldBooks = worldBooks;
                    state.posts = posts;
                    state.userPersonaPresets = userPersonaPresets;
                    state.emoticons = emoticons;
                    state.musicLibrary = musicLibrary;
                    state.thoughtPresets = thoughtPresets.length > 0 ? thoughtPresets : INITIAL_STATE.thoughtPresets;
                    state.apiSettings = apiSettings ? { ...INITIAL_STATE.apiSettings, ...apiSettings } : { id: 'main', ...INITIAL_STATE.apiSettings };
                    state.squareApiSettings = squareApiSettings ? { ...INITIAL_STATE.squareApiSettings, ...squareApiSettings } : { id: 'main', ...INITIAL_STATE.squareApiSettings };
                    state.myProfile = { ...INITIAL_STATE.myProfile, ...myProfile };
                    state.transactions = transactions;
                    state.trendingTopics = trendingTopics;
                    isInitialPostLoad = state.posts.length < 20;
                }
                // --- MODIFIED: V7.0 初始化所有联系人的新字段 ---
                state.contacts.forEach(contact => {
                    contact.history = contact.history || [];
                    contact.diary = contact.diary || []; 
                    contact.history.forEach((msg, index) => { 
                        if (!msg.id) msg.id = `msg_${Date.now()}_${index}`; 
                        if (!msg.type) msg.type = 'text';
                    });
                    contact.worldBooks = contact.worldBooks || []; 
                    contact.userPersona = contact.userPersona || '';
                    contact.thoughtPreset = contact.thoughtPreset || 'deep_roleplay_regex'; 
                    contact.signature = contact.signature || ''; 
                    contact.isNarrativeMode = contact.isNarrativeMode ?? false;
                    contact.apiCallCounter = contact.apiCallCounter || 0;
                    contact.gold_coins = contact.gold_coins || 50;
                    contact.memories = contact.memories || [];
                    contact.isChatPetVisible = contact.isChatPetVisible ?? false;
                    if (contact.pet) {
                        contact.pet.xp = contact.pet.xp || 0;
                        contact.pet.level = contact.pet.level || 1;
                        contact.pet.form = contact.pet.form || 'baby';
                    }
                    // --- NEW: 初始化音乐和时间记录字段 ---
                    contact.sharedPlaylist = contact.sharedPlaylist || { tracks: [], currentIndex: 0, playbackMode: 'list', isPlaying: false };
                    contact.totalListenTime = contact.totalListenTime || 0; // 单位：秒
                    contact.firstChatDate = contact.firstChatDate || (contact.history.length > 0 ? contact.history[0].timestamp : Date.now());
                    contact.isAvatarHidden = contact.isAvatarHidden ?? false;
                });
            } catch (error) {
                console.error("从IndexedDB加载数据失败:", error);
                alert("加载数据失败，应用将使用初始状态。请检查浏览器设置或控制台错误。");
            }
        }
        
        // --- 新增：用于替代 prompt() 的自定义弹窗函数 ---
        function showCustomPrompt(title, currentValue = '') {
            return new Promise((resolve) => {
                const modal = document.getElementById('custom-prompt-modal');
                const titleEl = document.getElementById('custom-prompt-title');
                const inputEl = document.getElementById('custom-prompt-input');
                const confirmBtn = document.getElementById('custom-prompt-confirm-btn');
                const cancelBtn = document.getElementById('custom-prompt-cancel-btn');

                titleEl.textContent = title;
                inputEl.value = currentValue;
                modal.style.display = 'flex';
                inputEl.focus();

                const confirmHandler = () => {
                    cleanup();
                    resolve(inputEl.value);
                };

                const cancelHandler = () => {
                    cleanup();
                    resolve(null); // 返回 null，与原生 prompt() 的行为保持一致
                };

                const cleanup = () => {
                    confirmBtn.removeEventListener('click', confirmHandler);
                    cancelBtn.removeEventListener('click', cancelHandler);
                    modal.style.display = 'none';
                };
                
                // 每次都重新绑定事件，防止重复监听
                confirmBtn.addEventListener('click', confirmHandler, { once: true });
                cancelBtn.addEventListener('click', cancelHandler, { once: true });
            });
        }

        // --- 新增：用于替代 confirm() 的自定义确认函数 ---
        function showCustomConfirm(title, message, isDanger = false) {
            return new Promise((resolve) => {
                const modal = document.getElementById('custom-confirm-modal');
                const titleEl = document.getElementById('custom-confirm-title');
                const textEl = document.getElementById('custom-confirm-text');
                const confirmBtn = document.getElementById('custom-confirm-confirm-btn');
                const cancelBtn = document.getElementById('custom-confirm-cancel-btn');

                titleEl.textContent = title;
                textEl.innerHTML = message.replace(/\n/g, '<br>'); // 支持换行
                modal.style.display = 'flex';

                if (isDanger) {
                    confirmBtn.classList.add('danger');
                } else {
                    confirmBtn.classList.remove('danger');
                }

                const confirmHandler = () => {
                    cleanup();
                    resolve(true);
                };

                const cancelHandler = () => {
                    cleanup();
                    resolve(false);
                };

                const cleanup = () => {
                    confirmBtn.removeEventListener('click', confirmHandler);
                    cancelBtn.removeEventListener('click', cancelHandler);
                    modal.style.display = 'none';
                };
                
                confirmBtn.addEventListener('click', confirmHandler, { once: true });
                cancelBtn.addEventListener('click', cancelHandler, { once: true });
            });
        }
        
        // --- 新增：导出数据功能 ---
        async function exportData() {
            try {
                const dataToExport = {};
                for (const storeName in dbConfig) {
                    if (['myProfile', 'apiSettings', 'squareApiSettings'].includes(storeName)) {
                         dataToExport[storeName] = await kokoMemory.get(storeName, 'main');
                    } else {
                        dataToExport[storeName] = await kokoMemory.getAll(storeName);
                    }
                }

                const jsonString = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'koko_backup.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert('数据已成功导出为 koko_backup.json 文件！');
            } catch (error) {
                console.error('导出数据失败:', error);
                alert(`导出数据失败: ${error.message}`);
            }
        }
        
        // --- 新增：导入数据功能 ---
        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const confirmed = await showCustomConfirm('导入数据', '警告：导入数据将会覆盖当前所有数据！确定要继续吗？', true);
            if (!confirmed) {
                // 清空文件输入，以便下次可以选择同一个文件
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const dataToImport = JSON.parse(e.target.result);
                    
                    for (const storeName in dbConfig) {
                        if (dataToImport[storeName]) {
                            await kokoMemory.clear(storeName);
                            if (Array.isArray(dataToImport[storeName])) {
                                await kokoMemory.bulkPut(storeName, dataToImport[storeName]);
                            } else {
                                await kokoMemory.put(storeName, dataToImport[storeName]);
                            }
                        }
                    }
                    alert('数据导入成功！页面即将刷新以应用更改。');
                    setTimeout(() => window.location.reload(), 1000);

                } catch (error) {
                    console.error('导入数据失败:', error);
                    alert(`导入失败：文件格式可能不正确。错误信息: ${error.message}`);
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        function showFeedStatus(text = '正在刷新论坛...') {
            if(feedStatusEl) {
                feedStatusEl.textContent = text;
                feedStatusEl.style.display = 'block';
            }
        }
        function hideFeedStatus() {
             if(feedStatusEl) {
                feedStatusEl.style.display = 'none';
            }
        }
        
        function renderMyProfile() {
            document.getElementById('my-profile-avatar').src = state.myProfile.avatar;
            document.getElementById('profile-name').textContent = state.myProfile.name;
            document.getElementById('profile-status').textContent = state.myProfile.status;
            document.getElementById('nickname-value').textContent = state.myProfile.name;
            document.getElementById('signature-value').textContent = state.myProfile.signature;
            document.getElementById('region-value').textContent = state.myProfile.region;
            document.getElementById('birthday-value').textContent = state.myProfile.birthday;
            document.getElementById('my-balance-value').textContent = `¥ ${state.myProfile.balance.toFixed(2)}`;
        }

        // ... 此处省略大量未修改的函数 (renderContacts, createContactItem 等) ...
        // ... The bulk of the functions from the original file remain unchanged ...
        
        // 此处省略了大量未修改的函数，它们与之前的版本完全相同
        // 确保您已经包含了从 renderContacts 到 handleAvatarUpload 的所有函数
        
        function fieldNameToChinese(field) {
            const map = { name: '昵称', signature: '个性签名', region: '地区', birthday: '生日', status: '状态', avatar: '头像URL' };
            return map[field] || field;
        }

        function renderContacts() {
            const contactsContainer = document.querySelector('.contacts-container');
            const recentContacts = state.contacts.filter(c => c.history && c.history.length > 0).sort((a, b) => {
                return (b.history[b.history.length - 1].timestamp || 0) - (a.history[a.history.length - 1].timestamp || 0);
            });
            const otherContacts = state.contacts.filter(c => !c.history || c.history.length === 0);
            contactsContainer.innerHTML = '';
            if (recentContacts.length > 0) {
                contactsContainer.innerHTML += '<div class="section-title">最近聊天</div>';
                recentContacts.forEach(contact => contactsContainer.appendChild(createContactItem(contact)));
            }
            if (otherContacts.length > 0) {
                contactsContainer.innerHTML += '<div class="section-title">我的联系人</div>';
                otherContacts.forEach(contact => contactsContainer.appendChild(createContactItem(contact)));
            }
            if (state.contacts.length === 0) {
                contactsContainer.innerHTML = `<div style="text-align: center; padding: 50px 20px; color: #888;"><i class="fas fa-user-plus" style="font-size: 48px; margin-bottom: 15px;"></i><p>还没有联系人</p><p>点击右上角"+"添加新联系人</p></div>`;
            }
            document.querySelectorAll('.contact-item').forEach(item => item.addEventListener('click', function() { openChat(this.dataset.contactId); }));
        }
        
        function createContactItem(contact) {
            const item = document.createElement('div');
            item.className = 'contact-item';
            item.dataset.contactId = contact.id;
            const lastMessage = contact.history && contact.history.length > 0 ? contact.history[contact.history.length - 1] : null;

            let lastMessageText;
            if (lastMessage) {
                switch (lastMessage.type) {
                    case 'html': // 把HTML消息在列表里显示为通用占位符
                        lastMessageText = '[静态内容]';
                        break;
                    case 'image':
                    case 'picture_description':
                        lastMessageText = '[图片]';
                        break;
                    case 'voice':
                        lastMessageText = '[语音]';
                        break;
                    case 'red_packet':
                        lastMessageText = '[红包]';
                        break;
                    case 'transfer':
                        lastMessageText = '[转账]';
                        break;
                    case 'music_share':
                        lastMessageText = `[音乐] ${lastMessage.content.title}`;
                        break;
                    case 'system_notification':
                        lastMessageText = lastMessage.content;
                        break;
                    default: // 'text' 和其他类型
                        lastMessageText = lastMessage.content;
                }
                if (lastMessage.sender === 'user' && lastMessage.type !== 'system_notification') {
                    lastMessageText = '我: ' + lastMessageText;
                }
            } else {
                lastMessageText = contact.persona;
            }

            // 先用innerHTML构建基础结构
            item.innerHTML = `<div class="contact-avatar">${contact.avatar ? `<img src="${contact.avatar}" onerror="this.onerror=null;this.src='https://via.placeholder.com/50/DDD/666?text=U';" alt="${contact.name}头像">` : `<i class="fas fa-user"></i>`}</div><div class="contact-info"><div class="contact-name"></div><div class="contact-last-message"></div></div><div class="contact-time-info" style="text-align: right;">${lastMessage ? `<div class="contact-time">${lastMessage.time}</div>` : ''}${contact.unreadCount > 0 ? `<div class="unread-count">${contact.unreadCount}</div>` : ''}</div>`;
            
            // *** 核心修复 ***
            // 使用 textContent 安全地把消息设置为纯文本，这样HTML就不会被执行了
            item.querySelector('.contact-last-message').textContent = lastMessageText;
            item.querySelector('.contact-name').textContent = contact.name;

            return item;
        }
        
        async function renderWorldBooks() {
            const worldBookList = document.getElementById('world-book-list');
            worldBookList.innerHTML = '';
            if (state.worldBooks.length === 0) {
                worldBookList.innerHTML = `<div style="text-align: center; padding: 50px 20px; color: #888;"><i class="fas fa-book" style="font-size: 48px; margin-bottom: 15px;"></i><p>还没有世界书</p><p>点击右上角"+"添加新世界书</p></div>`;
                return;
            }
            state.worldBooks.forEach(book => {
                const bookItem = document.createElement('div');
                bookItem.className = 'world-book-item';
                bookItem.dataset.bookId = book.id;
                bookItem.innerHTML = `<div class="book-header"><div class="book-name">${book.name}</div></div><div class="book-content">${book.content.substring(0, 100)}...</div>`;                bookItem.addEventListener('click', function() { editWorldBook(this.dataset.bookId); });
                worldBookList.appendChild(bookItem);
            });
        }
        
        function updateWorldBookSelectors() {
            const worldBookSelect = document.getElementById('world-book-select');
            const worldBookSelectorList = document.getElementById('world-book-selector-list');
            worldBookSelect.innerHTML = '';
            worldBookSelectorList.innerHTML = '';
            const noBookOption = document.createElement('option');
            noBookOption.value = '';
            noBookOption.textContent = '-- 无关联世界书 --';
            worldBookSelect.appendChild(noBookOption);
            state.worldBooks.forEach(book => {
                const option = document.createElement('option');
                option.value = book.id;
                option.textContent = book.name;
                worldBookSelect.appendChild(option);
                const bookItem = document.createElement('div');
                bookItem.className = 'world-book-item';
                bookItem.innerHTML = `<input type="checkbox" class="world-book-checkbox" id="book-setting-${book.id}" value="${book.id}"><label for="book-setting-${book.id}" class="world-book-name">${book.name}</label>`;
                worldBookSelectorList.appendChild(bookItem);
            });
        }

        function createPostItem(post, isDetailView = false) {
            const postItem = document.createElement('div');
            postItem.className = 'post-item';
            if (!isDetailView) {
                 postItem.dataset.postId = post.id;
            }
            
            const author = post.author;
            if (!author) return null;

            let authorSignature = author.signature; 
            if (!authorSignature) { 
                if (author.id === 'myProfile') {
                    authorSignature = state.myProfile.signature; 
                } else {
                    const fullContact = state.contacts.find(c => c.id === author.id); 
                    if (fullContact) {
                        authorSignature = fullContact.signature; 
                    }
                }
            }

            const authorName = author.name;
            const authorAvatar = author.avatar || 'https://via.placeholder.com/45/DDD/666?text=U';
            const isLiked = post.likes.includes(state.myProfile.name);
            
            let commentsHTML = '';
            if (!isDetailView && post.comments.length > 0) {
                commentsHTML = `<div class="post-comments">${post.comments.slice(0, 2).map(comment => {
                    const commentAuthor = comment.author;
                    if (!commentAuthor) return '';
                    let replyHTML = '';
                    if (comment.replyTo) {
                        replyHTML = `<span class="comment-reply-to">回复 @${comment.replyTo}</span>`;
                    }
                    return `<div class="post-comment-item"><span class="comment-author">${commentAuthor.name}</span>${replyHTML}: ${parseMentions(comment.content)}</div>`;
                }).join('')}${post.comments.length > 2 ? `<div class="post-comment-item" style="color: var(--text-gray);">查看全部 ${post.comments.length} 条评论...</div>` : ''}</div>`;
            }

            let redPacketHTML = '';
            if (post.redPacket) {
                redPacketHTML = `
                <div class="forum-red-packet-card" data-post-id="${post.id}">
                    <div class="red-packet-icon">🧧</div>
                    <div class="red-packet-blessing">${post.redPacket.blessing}</div>
                </div>`;
            }

            postItem.innerHTML = `
                <div class="post-delete-btn" data-post-id="${post.id}" title="删除帖子"><i class="fas fa-trash-alt"></i></div>
                <div class="post-item-avatar"><img src="${authorAvatar}" onerror="this.onerror=null;this.src='https://via.placeholder.com/45/DDD/666?text=U';" alt="${authorName}的头像"></div>
                <div class="post-content-area">
                    <div>
                        <span class="post-author-name">${authorName}</span>
                        ${author.id && !author.id.startsWith('stranger_') ? `<span class="post-author-handle">@${author.id.replace('_','')}</span>` : ''}
                    </div>
                    ${ authorSignature ? `<div class="post-author-signature">${authorSignature}</div>` : '' }
                    <div class="post-text">${parseMentions(post.content)}</div>
                    ${redPacketHTML}
                    <div class="post-meta">${formatTimeAgo(post.timestamp)}</div>
                    <div class="post-actions">
                        <span class="post-action-btn repost-btn" data-post-id="${post.id}"><i class="fas fa-retweet"></i> ${post.reposts > 0 ? post.reposts : '转发'}</span>
                        <span class="post-action-btn comment-btn" data-post-id="${post.id}"><i class="far fa-comment"></i> ${post.comments.length > 0 ? post.comments.length : '评论'}</span>
                        <span class="post-action-btn like-btn ${isLiked ? 'liked' : ''}" data-post-id="${post.id}"><i class="${isLiked ? 'fas' : 'far'} fa-heart"></i> ${post.likes.length > 0 ? post.likes.length : '赞'}</span>
                    </div>
                    ${commentsHTML}
                </div>`;
            
            return postItem;
        }

        async function renderFeed() {
            const postsList = document.getElementById('posts-list');
            const tabsContainer = document.getElementById('feed-tabs-container');
            const subTabsContainer = document.getElementById('feed-sub-tabs-container');
            
            tabsContainer.innerHTML = `
                <button class="feed-tab-btn ${state.activeFeedTab === 'recommended' ? 'active' : ''}" data-tab="recommended">推荐</button>
                <button class="feed-tab-btn ${state.activeFeedTab === 'following' ? 'active' : ''}" data-tab="following">关注</button>
                <button class="feed-tab-btn ${state.activeFeedTab === 'trending' ? 'active' : ''}" data-tab="trending">热搜</button>
            `;

            if (state.activeFeedTab === 'recommended') {
                subTabsContainer.style.display = 'flex';
                 subTabsContainer.innerHTML = `
                    <button class="feed-sub-tab-btn ${state.activeFeedSubTab === 'daily' ? 'active' : ''}" data-subtab="daily">日常</button>
                    <button class="feed-sub-tab-btn ${state.activeFeedSubTab === 'food' ? 'active' : ''}" data-subtab="food">美食</button>
                    <button class="feed-sub-tab-btn ${state.activeFeedSubTab === 'gossip' ? 'active' : ''}" data-subtab="gossip">八卦</button>
                    <button class="feed-sub-tab-btn ${state.activeFeedSubTab === 'horror' ? 'active' : ''}" data-subtab="horror">恐怖</button>
                `;
            } else {
                subTabsContainer.style.display = 'none';
            }
            
            postsList.innerHTML = ''; 

            if (state.activeFeedTab === 'trending') {
                const trendingListEl = document.createElement('ol');
                trendingListEl.className = 'trending-list';
                
                if (state.trendingTopics.length === 0) {
                     trendingListEl.innerHTML = `<div style="text-align: center; padding: 50px 20px; color: #888;"><p>热搜榜空空如也，刷新一下试试？</p></div>`;
                } else {
                    state.trendingTopics.forEach((topic, index) => {
                        const item = document.createElement('li');
                        item.className = 'trending-item';
                        item.dataset.topicTitle = topic.title;
                        item.innerHTML = `
                            <div class="trending-rank ${index < 3 ? 'top-3' : ''}">${index + 1}</div>
                            <div class="trending-info">
                                <div class="trending-title">${topic.title}</div>
                                <div class="trending-meta"><i class="fas fa-fire" style="color: #ff8a65;"></i> ${topic.heat}万</div>
                            </div>
                            ${topic.tag ? `<div class="trending-tag">${topic.tag}</div>` : ''}
                        `;
                        trendingListEl.appendChild(item);
                    });
                }
                postsList.appendChild(trendingListEl);
                return;
            }

            let postsToShow = [];
            const contactIds = state.contacts.map(c => c.id);

            if (state.activeFeedTab === 'following') {
                postsToShow = state.posts.filter(p => p.author.id === 'myProfile' || contactIds.includes(p.author.id));
            } else { 
                postsToShow = state.posts.filter(p => p.category === state.activeFeedSubTab);
            }
            
            const sortedPosts = [...postsToShow].sort((a, b) => b.timestamp - a.timestamp);
            
            const postsToDisplay = (state.activeFeedTab === 'following') ? sortedPosts : sortedPosts.slice(0, state.postsToDisplay);

            if (postsToDisplay.length === 0) {
                const emptyMessage = state.activeFeedTab === 'following' 
                    ? '你关注的人还没有发布动态哦'
                    : '这里空空如也，点击右上角刷新看看';
                postsList.innerHTML = `<div style="text-align: center; padding: 50px 20px; color: #888;"><i class="fas fa-couch" style="font-size: 48px; margin-bottom: 15px;"></i><p>${emptyMessage}</p></div>`;
            } else {
                postsToDisplay.forEach(post => {
                    const postItem = createPostItem(post);
                    if (postItem) postsList.appendChild(postItem);
                });
            }
        }

        async function renderUserPersonaPresets() {
            const userPersonaPresetsList = document.getElementById('user-persona-presets-list');
            const noUserPersonaMessage = document.getElementById('no-user-persona-message');
            userPersonaPresetsList.innerHTML = '';
            noUserPersonaMessage.style.display = state.userPersonaPresets.length === 0 ? 'block' : 'none';
            state.userPersonaPresets.forEach(preset => {
                const presetItem = document.createElement('div');
                presetItem.className = 'preset-item';
                presetItem.dataset.presetId = preset.id;
                presetItem.innerHTML = `<div class="preset-info"><div class="preset-name">${preset.name}</div><div class="preset-desc">${preset.description}</div></div><div class="preset-actions"><span class="preset-action-btn edit-preset-btn" title="编辑面具"><i class="fas fa-edit"></i></span><span class="preset-action-btn delete delete-preset-btn" title="删除面具"><i class="fas fa-trash-alt"></i></span></div>`;
                userPersonaPresetsList.appendChild(presetItem);
            });
            userPersonaPresetsList.querySelectorAll('.edit-preset-btn').forEach(btn => btn.addEventListener('click', editUserPersonaPreset));
            userPersonaPresetsList.querySelectorAll('.delete-preset-btn').forEach(btn => btn.addEventListener('click', deleteUserPersonaPreset));
            await updateUserPersonaPresetSelect();
        }
        
        async function renderThoughtPresets() {
            const thoughtPresetsList = document.getElementById('thought-presets-list');
            const noThoughtPresetMessage = document.getElementById('no-thought-preset-message');
            thoughtPresetsList.innerHTML = '';
            noThoughtPresetMessage.style.display = state.thoughtPresets.length === 0 ? 'block' : 'none';
            state.thoughtPresets.forEach(preset => {
                const item = document.createElement('div');
                item.className = 'preset-item';
                item.dataset.presetId = preset.id;
                item.innerHTML = `
                    <div class="preset-info">
                        <div class="preset-name">${preset.name}</div>
                        <div class="preset-desc" style="white-space: pre-wrap;">${preset.prompt}</div>
                    </div>
                    <div class="preset-actions">
                        <span class="preset-action-btn edit-thought-preset-btn" title="编辑预设">
                            <i class="fas fa-edit"></i>
                        </span>
                        <span class="preset-action-btn delete delete-thought-preset-btn" title="删除预设">
                            <i class="fas fa-trash-alt"></i>
                        </span>
                    </div>
                `;
                thoughtPresetsList.appendChild(item);
            });
            thoughtPresetsList.querySelectorAll('.edit-thought-preset-btn').forEach(btn => btn.addEventListener('click', editThoughtPreset));
            thoughtPresetsList.querySelectorAll('.delete-thought-preset-btn').forEach(btn => btn.addEventListener('click', deleteThoughtPreset));
            await populateThoughtPresetSelect();
        }

        async function renderEmoticonLibrary() {
            const grid = document.getElementById('emoticon-library-grid');
            const noEmoticonMsg = document.getElementById('no-emoticon-message');
            grid.innerHTML = '';

            if (state.emoticons.length === 0) {
                noEmoticonMsg.style.display = 'block';
            } else {
                noEmoticonMsg.style.display = 'none';
                state.emoticons.forEach(emo => {
                    const item = document.createElement('div');
                    item.className = 'emoticon-item';
                    item.innerHTML = `
                        <img src="${emo.url}" alt="${emo.name}" onerror="this.src='https://via.placeholder.com/60?text=Error'; this.alt='图片加载失败';">
                        <div class="emoticon-name">${emo.name}</div>
                        <button class="emoticon-delete-btn" data-emoticon-id="${emo.id}">&times;</button>
                    `;
                    grid.appendChild(item);
                });

                grid.querySelectorAll('.emoticon-delete-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const emoticonId = e.currentTarget.dataset.emoticonId;
                        const confirmed = await showCustomConfirm('删除表情包', '确定要删除这个表情包吗？', true);
                        if (confirmed) {
                            state.emoticons = state.emoticons.filter(e => e.id !== emoticonId);
                            await kokoMemory.delete('emoticons', emoticonId);
                            await renderEmoticonLibrary();
                        }
                    });
                });
            }
        }

        async function renderMusicLibrary() {
            const list = document.getElementById('music-library-list');
            const noMusicMsg = document.getElementById('no-music-message');
            list.innerHTML = '';

            if (state.musicLibrary.length === 0) {
                noMusicMsg.style.display = 'block';
            } else {
                noMusicMsg.style.display = 'none';
                state.musicLibrary.forEach(song => {
                    const item = document.createElement('div');
                    item.className = 'music-item';
                    item.innerHTML = `
                        <div class="music-info">
                            <div class="music-title">${song.title}</div>
                            <div class="music-artist">${song.artist}</div>
                        </div>
                        <button class="music-delete-btn" data-music-id="${song.id}"><i class="fas fa-trash-alt"></i></button>
                    `;
                    list.appendChild(item);
                });

                list.querySelectorAll('.music-delete-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const musicId = e.currentTarget.dataset.musicId;
                        const confirmed = await showCustomConfirm('删除歌曲', '确定要从曲库删除这首歌吗？', true);
                        if (confirmed) {
                            state.musicLibrary = state.musicLibrary.filter(s => s.id !== musicId);
                            await kokoMemory.delete('musicLibrary', musicId);
                            await renderMusicLibrary();
                        }
                    });
                });
            }
        }

        function renderMusicPickerInModal() {
            const picker = document.getElementById('music-library-picker');
            picker.innerHTML = '';

            if (state.musicLibrary.length > 0) {
                picker.innerHTML = '<div class="picker-title">从曲库选择</div>';
                const list = document.createElement('div');
                list.className = 'picker-list';
                state.musicLibrary.forEach(song => {
                    const item = document.createElement('div');
                    item.className = 'picker-item';
                    item.textContent = `${song.title} - ${song.artist}`;
                    item.addEventListener('click', () => {
                        document.getElementById('send-music-title-input').value = song.title;
                        document.getElementById('send-music-artist-input').value = song.artist;
                        document.getElementById('send-music-url-input').value = song.url;
                        // ▼▼▼ 在这里添加填充歌词的代码 ▼▼▼
                        document.getElementById('send-music-lrc-input').value = song.lrc || '';
                    });
                    list.appendChild(item);
                });
                picker.appendChild(list);
            } else {
                picker.innerHTML = '<div class="picker-title" style="text-align:center; color:#999;">你的曲库是空的</div>';
            }
        }

        function renderEmoticonPicker() {
            const emoticonPicker = document.getElementById('emoticon-picker');
            emoticonPicker.innerHTML = '';
            if (state.emoticons.length > 0) {
                state.emoticons.forEach(emo => {
                    const item = document.createElement('div');
                    item.className = 'emoticon-item';
                    item.innerHTML = `<img src="${emo.url}" alt="${emo.name}">`;
                    item.addEventListener('click', async () => {
                        await createAndAddMessage({ 
                            type: 'image', 
                            url: emo.url,
                            isEmoticon: true,
                            emoticonName: emo.name
                        });
                        emoticonPicker.classList.remove('active');
                    });
                    emoticonPicker.appendChild(item);
                });
            } else {
                emoticonPicker.innerHTML = '<div style="color: #999; text-align: center; grid-column: 1 / -1;">表情包库是空的</div>';
            }
        }

        function renderWalletScreen() {
            const listEl = document.getElementById('transaction-list');
            const noTransactionMsg = document.getElementById('no-transaction-message');
            listEl.innerHTML = '';

            if (!state.transactions || state.transactions.length === 0) {
                noTransactionMsg.style.display = 'block';
                return;
            }
            noTransactionMsg.style.display = 'none';

            const sortedTransactions = [...state.transactions].sort((a, b) => b.timestamp - a.timestamp);

            sortedTransactions.forEach(tx => {
                const item = document.createElement('div');
                item.className = 'transaction-item';
                const amountClass = tx.type === 'income' ? 'income' : 'expense';
                const amountSign = tx.type === 'income' ? '+' : '-';

                item.innerHTML = `
                    <div class="transaction-info">
                        <div class="desc">${tx.description}</div>
                        <div class="time">${new Date(tx.timestamp).toLocaleString()}</div>
                    </div>
                    <div class="transaction-amount ${amountClass}">
                        ${amountSign}${tx.amount.toFixed(2)}
                    </div>
                `;
                listEl.appendChild(item);
            });
        }


        async function updateUserPersonaPresetSelect() {
            const selectUserPersonaPreset = document.getElementById('select-user-persona-preset');
            selectUserPersonaPreset.innerHTML = '<option value="">-- 选择或输入自定义面具 --</option>';
            state.userPersonaPresets.forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.id;
                option.textContent = preset.name;
                selectUserPersonaPreset.appendChild(option);
            });
        }

        async function populateThoughtPresetSelect() {
            const select = document.getElementById('thought-preset-select');
            const currentVal = select.value;
            select.innerHTML = '';
            
            const noPresetOption = document.createElement('option');
            noPresetOption.value = ""; 
            noPresetOption.textContent = "-- 无预设 (使用默认角色扮演) --";
            select.appendChild(noPresetOption);

            if (state.thoughtPresets.length === 0) {
                return;
            }
            state.thoughtPresets.forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.id;
                option.textContent = preset.name;
                select.appendChild(option);
            });

            if (state.thoughtPresets.some(p => p.id === currentVal) || currentVal === "") {
                select.value = currentVal;
            }
        }

        async function updateNotificationDots() {
            const dots = document.querySelectorAll('.moments-notification-dot');
            if (state.hasNewPosts) {
                dots.forEach(dot => dot.style.display = 'block');
            } else {
                dots.forEach(dot => dot.style.display = 'none');
            }
        }
        
        function formatTimeAgo(timestamp) {
            return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function parseMentions(text) {
            if (!text) return '';
            const mentionRegex = /@([\w\u4e00-\u9fa5]+)/g;
            return text.replace(mentionRegex, (match) => {
                return `<span class="mention">${match}</span>`;
            });
        }

        function hideAllScreens() {
    document.querySelectorAll('#screen > div, #wallet-screen, #appearance-settings-screen').forEach(el => el.style.display = 'none');
}

        function setActiveNav(activeNavId) {
            document.querySelectorAll('.bottom-nav .nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.id.includes(activeNavId)) {
                    item.classList.add('active');
                }
            });
        }
        
        async function showMainScreen() { hideAllScreens(); document.getElementById('main-screen').style.display = 'flex'; setActiveNav('chat'); await renderContacts(); }
        function showDiscoverScreen() { hideAllScreens(); document.getElementById('discover-screen').style.display = 'flex'; setActiveNav('discover'); }
        async function showProfileScreen() { hideAllScreens(); document.getElementById('profile-screen').style.display = 'flex'; setActiveNav('profile'); await renderMyProfile(); }
        
        async function showFeedScreen() { 
            hideAllScreens(); 
            document.getElementById('moments-screen').style.display = 'flex'; 
            if (state.hasNewPosts) {
                state.hasNewPosts = false;
                updateNotificationDots();
            }
            //自动刷新功能注释掉，Produced by Kiko
            //if (isInitialPostLoad && state.posts.length === 0) {
                 //if (state.trendingTopics.length === 0) {
                    //await generateRandomTrendingTopicsAI();
                //}
                //await generatePostsForRecommendedTab(10);
                //isInitialPostLoad = false;
            //}
            await renderFeed();
        }

        async function showPostDetailScreen(postId) {
            state.activePostId = postId;
            hideAllScreens();
            document.getElementById('post-detail-screen').style.display = 'flex';
            await renderPostDetail();
        }
        
        async function showTrendingTopicScreen(topicTitle) {
            hideAllScreens();
            document.getElementById('trending-topic-screen').style.display = 'flex';
            document.getElementById('trending-topic-title').textContent = `# ${topicTitle} #`;
            const listEl = document.getElementById('trending-topic-posts-list');
            listEl.innerHTML = '';

            const relatedPosts = state.posts.filter(p => p.content.toLowerCase().includes(topicTitle.toLowerCase()));
            
            if (relatedPosts.length === 0) {
                 listEl.innerHTML = `<div style="text-align: center; padding: 50px 20px; color: #888;"><i class="fas fa-comment-slash" style="font-size: 48px; margin-bottom: 15px;"></i><p>该话题下还没有帖子</p></div>`;
                 return;
            }

            relatedPosts.sort((a,b) => b.timestamp - a.timestamp).forEach(post => {
                const postItem = createPostItem(post);
                if (postItem) listEl.appendChild(postItem);
            });
        }

        async function showThoughtPresetManagementScreen() { hideAllScreens(); document.getElementById('thought-preset-management-screen').style.display = 'flex'; await renderThoughtPresets(); }
        async function showEmoticonLibraryScreen() { hideAllScreens(); document.getElementById('emoticon-library-screen').style.display = 'flex'; await renderEmoticonLibrary(); }
        async function showMusicLibraryScreen() { hideAllScreens(); document.getElementById('music-library-screen').style.display = 'flex'; await renderMusicLibrary(); }
        async function showUserPersonaManagementScreen() { hideAllScreens(); document.getElementById('user-persona-management-screen').style.display = 'flex'; await renderUserPersonaPresets(); }

        async function showCharProfileScreen() {
            const contact = state.contacts.find(c => c.id === state.activeChatId);
            if (!contact) return;
            
            batchedPetActions = [];
            
            document.getElementById('char-profile-avatar').src = contact.avatar || `https://via.placeholder.com/70/DDD/666?text=${contact.name.substring(0,1).toUpperCase()}`;
            document.getElementById('char-profile-name').textContent = contact.name;
            document.getElementById('char-name-value').textContent = contact.name;
            document.getElementById('char-signature-value').textContent = contact.signature || '未设置';
            document.getElementById('char-profile-signature-display').textContent = `个性签名: ${contact.signature || '...'}`;


            hideAllScreens();
            document.getElementById('char-profile-screen').style.display = 'flex';

            renderPet(contact);
        }

        // --- MODIFIED: V7.0 修改为“小窝时光胶囊” ---
        async function showMemoryAlbum(contact) {
            hideAllScreens();
            document.getElementById('memory-album-screen').style.display = 'flex';
            renderMemoryAlbum(contact);
        }

        // --- MODIFIED: V7.0 渲染全新的时光胶囊 ---
        function renderMemoryAlbum(contact) {
            const listEl = document.getElementById('memory-album-list');
            listEl.innerHTML = '';
            if (!contact) return;

            // 格式化时长
            function formatDuration(totalSeconds) {
                if (!totalSeconds) return '0 分钟';
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                let result = '';
                if (hours > 0) result += `${hours} 小时 `;
                if (minutes > 0 || hours === 0) result += `${minutes} 分钟`;
                return result.trim();
            }

            const daysSinceFirstChat = Math.floor((Date.now() - contact.firstChatDate) / (1000 * 60 * 60 * 24));

            let albumHTML = `
                <div class="album-section">
                    <div class="album-section-title">我们的里程碑</div>
                    <div class="album-milestone-item">
                        <span class="album-item-icon"><i class="fas fa-calendar-check"></i></span>
                        <span class="album-item-label">初次相遇</span>
                        <span class="album-item-value">${new Date(contact.firstChatDate).toLocaleDateString()}</span>
                    </div>
                    <div class="album-milestone-item">
                        <span class="album-item-icon"><i class="fas fa-heart"></i></span>
                        <span class="album-item-label">已相识</span>
                        <span class="album-item-value">${daysSinceFirstChat} 天</span>
                    </div>
                </div>

                <div class="album-section">
                    <div class="album-section-title">共同的记忆</div>
                     <div class="album-stat-item">
                        <span class="album-item-icon"><i class="fas fa-music"></i></span>
                        <span class="album-item-label">一起听歌</span>
                        <span class="album-item-value">${formatDuration(contact.totalListenTime)}</span>
                    </div>
                </div>

                <div class="album-section">
                    <div class="album-section-title">珍藏的瞬间</div>
                    <div class="album-memory-grid" id="memory-grid-content">
                        </div>
                </div>
            `;
            listEl.innerHTML = albumHTML;

            const gridContent = document.getElementById('memory-grid-content');
            if (!contact.memories || contact.memories.length === 0) {
                 gridContent.innerHTML = `<p style="color:#888; grid-column: 1 / -1;">还没有珍藏的瞬间...</p>`;
            } else {
                 const sortedMemories = [...contact.memories].sort((a, b) => b.timestamp - a.timestamp);
                 sortedMemories.forEach(memo => {
                    const entryEl = document.createElement('div');
                    entryEl.className = 'album-memory-item';
                    entryEl.title = new Date(memo.timestamp).toLocaleString();
                    entryEl.innerHTML = `<i class="fas fa-quote-left"></i> ${memo.description}`;
                    gridContent.appendChild(entryEl);
                });
            }
        }


        async function editUserPersonaPreset(event) {
            event.stopPropagation();
            const presetId = event.currentTarget.closest('.preset-item').dataset.presetId;
            const preset = state.userPersonaPresets.find(p => p.id === presetId);
            if (preset) {
                editingUserPersonaId = presetId;
                document.getElementById('user-persona-modal-title').textContent = '编辑用户面具预设';
                document.getElementById('user-persona-name-input').value = preset.name;
                document.getElementById('user-persona-description-input').value = preset.description;
                document.getElementById('user-persona-preset-modal').style.display = 'flex';
            }
        }

        async function deleteUserPersonaPreset(event) {
            event.stopPropagation();
            const confirmed = await showCustomConfirm('删除面具', '确定要删除此用户面具预设吗？', true);
            if (confirmed) {
                const presetId = event.currentTarget.closest('.preset-item').dataset.presetId;
                state.userPersonaPresets = state.userPersonaPresets.filter(p => p.id !== presetId);
                await kokoMemory.delete('userPersonaPresets', presetId);
                await renderUserPersonaPresets();
            }
        }

        async function editThoughtPreset(event) {
            event.stopPropagation();
            const presetId = event.currentTarget.closest('.preset-item').dataset.presetId;
            const preset = state.thoughtPresets.find(p => p.id === presetId);
            if (preset) {
                editingThoughtPresetId = presetId;
                document.getElementById('thought-preset-modal-title').textContent = '编辑思维预设';
                document.getElementById('thought-preset-name-input').value = preset.name;
                document.getElementById('thought-preset-prompt-input').value = preset.prompt;
                document.getElementById('thought-preset-modal').style.display = 'flex';
            }
        }

        async function deleteThoughtPreset(event) {
            event.stopPropagation();
            const confirmed = await showCustomConfirm('删除预设', '确定要删除此思维预设吗？', true);
            if (confirmed) {
                const presetId = event.currentTarget.closest('.preset-item').dataset.presetId;
                state.thoughtPresets = state.thoughtPresets.filter(p => p.id !== presetId);
                await kokoMemory.delete('thoughtPresets', presetId);
                await renderThoughtPresets();
            }
        }

        function findAuthorById(authorId) {
            if (authorId === 'myProfile') {
                return { id: 'myProfile', ...state.myProfile };
            }
            return state.contacts.find(c => c.id === authorId);
        }
        
        async function toggleLike(event) {
            event.stopPropagation();
            const postId = event.currentTarget.dataset.postId;
            const post = state.posts.find(p => p.id === postId);
            if (post) {
                const myName = state.myProfile.name;
                const likeIndex = post.likes.indexOf(myName);
                if (likeIndex === -1) {
                    post.likes.push(myName);
                } else {
                    post.likes.splice(likeIndex, 1);
                }
                await kokoMemory.put('posts', post);
                
                if (document.getElementById('moments-screen').style.display === 'flex') {
                    await renderFeed(); 
                } else if (document.getElementById('post-detail-screen').style.display === 'flex') {
                    await renderPostDetail();
                }
            }
        }
        
        function editWorldBook(bookId) {
            const book = state.worldBooks.find(b => b.id === bookId);
            if (book) {
                editingBookId = bookId;
                document.getElementById('world-book-modal-title').textContent = '编辑世界书';
                document.getElementById('book-name-input').value = book.name;
                document.getElementById('book-content-input').value = book.content;
                document.getElementById('add-world-book-modal').style.display = 'flex';
            }
        }
        
        async function fetchModels(endpointBase, apiKey, modelSelectEl, btn) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 拉取中';
            btn.disabled = true;
            
            if (!endpointBase) {
                alert('请输入API基础地址');
                btn.innerHTML = '<i class="fas fa-sync-alt"></i> 拉取';
                btn.disabled = false;
                return;
            }

            try {
                let modelsUrl = endpointBase;
                if (!modelsUrl.endsWith('/')) modelsUrl += '/';
                modelsUrl += 'v1/models';
                const response = await fetch(modelsUrl, { headers: { 'Authorization': `Bearer ${apiKey}` } });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message);
                };
                const data = await response.json();
                const models = data.data.map(model => model.id).sort();
                updateModelDropdown(models, modelSelectEl, modelSelectEl.value);
                alert(`成功拉取 ${models.length} 个模型！`);
            } catch (error) {
                console.error('拉取模型失败:', error);
                alert(`拉取模型失败: ${error.message}。\n请检查基础地址和API密钥是否正确。`);
            } finally {
                btn.innerHTML = '<i class="fas fa-sync-alt"></i> 拉取';
                btn.disabled = false;
            }
        }
        
        function updateModelDropdown(models, modelSelect, currentModel) {
            modelSelect.innerHTML = ''; 

            if (models && models.length > 0) {
                models.forEach(modelId => {
                    const option = document.createElement('option');
                    option.value = modelId;
                    option.textContent = modelId;
                    if (modelId === currentModel) {
                        option.selected = true;
                    }
                    modelSelect.appendChild(option);
                });
            } else if (currentModel) { 
                const option = document.createElement('option');
                option.value = currentModel;
                option.textContent = currentModel;
                option.selected = true;
                modelSelect.appendChild(option);
            } else {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "未能拉取到模型或列表为空";
                modelSelect.appendChild(option);
            }
        }

        const MESSAGES_PER_PAGE = 30;

        function enterEditMode() {
            editModeState.active = true;
            editModeState.selectedMessageIds.clear();
            document.getElementById('chat-screen').classList.add('chat-screen-edit-mode');
            document.getElementById('chat-input-area').style.display = 'none';
            document.getElementById('edit-mode-bar').style.display = 'flex';
            renderChatMessages(state.contacts.find(c => c.id === state.activeChatId), true); 
        }

        async function exitEditMode() {
            editModeState.active = false;
            document.getElementById('chat-screen').classList.remove('chat-screen-edit-mode');
            document.getElementById('chat-input-area').style.display = 'flex';
            document.getElementById('edit-mode-bar').style.display = 'none';
            await openChat(state.activeChatId);
        }

        function handleMessageSelection(wrapper, message) {
            if (!editModeState.active) return;
            const msgId = wrapper.dataset.messageId;
            if (!msgId) return;

            if (editModeState.selectedMessageIds.has(msgId)) {
                editModeState.selectedMessageIds.delete(msgId);
                wrapper.classList.remove('selected');
            } else {
                editModeState.selectedMessageIds.add(msgId);
                wrapper.classList.add('selected');
            }
        }
        
        function openRepostModal(postId) {
            const post = state.posts.find(p => p.id === postId);
            if (!post) return;
            
            const modal = document.getElementById('repost-contact-picker-modal');
            const contactListEl = document.getElementById('repost-contact-list');
            const messageInput = document.getElementById('repost-message-input');
            messageInput.value = '';
            contactListEl.innerHTML = '';

            state.contacts.forEach(contact => {
                const item = document.createElement('div');
                item.className = 'contact-picker-item';
                item.innerHTML = `
                    <input type="checkbox" id="contact-check-${contact.id}" value="${contact.id}">
                    <label for="contact-check-${contact.id}" style="display: flex; align-items: center; width: 100%; cursor: pointer;">
                        <img src="${contact.avatar}" alt="${contact.name}">
                        <span>${contact.name}</span>
                    </label>
                `;
                contactListEl.appendChild(item);
            });
            
            modal.style.display = 'flex';

            document.getElementById('close-repost-modal').onclick = () => modal.style.display = 'none';
            
            const confirmBtn = document.getElementById('confirm-repost-btn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.addEventListener('click', async () => {
                const selectedContactIds = Array.from(contactListEl.querySelectorAll('input:checked')).map(input => input.value);
                if (selectedContactIds.length === 0) {
                    alert('请至少选择一个联系人');
                    return;
                }
                
                const accompanyingMessage = messageInput.value.trim();

                for (const contactId of selectedContactIds) {
                    const tempActiveChatId = state.activeChatId;
                    state.activeChatId = contactId; // 临时切换上下文
                    
                    await createAndAddMessage({ type: 'post_share', content: { postId } });
                    if (accompanyingMessage) {
                        await createAndAddMessage({ type: 'text', content: accompanyingMessage });
                    }
                    
                    state.activeChatId = tempActiveChatId; // 切换回来
                }
                
                modal.style.display = 'none';
                alert(`已成功分享给 ${selectedContactIds.length} 位联系人！`);
                post.reposts = (post.reposts || 0) + 1;
                await kokoMemory.put('posts', post);
                await renderFeed();
            });
        }

       async function showRedPacketDetails(packetData, senderProfile) {
            const modal = document.getElementById('red-packet-details-modal');
            const listEl = document.getElementById('red-packet-claimer-list');
            const summaryEl = document.getElementById('red-packet-details-summary');
            
            document.getElementById('details-sender-avatar').src = senderProfile.avatar;
            document.getElementById('details-sender-name').textContent = `${senderProfile.name}的红包`;
            document.getElementById('details-blessing').textContent = packetData.blessing;
            
            listEl.innerHTML = '';
            
            const claimers = packetData.claimers || [];
            if (claimers.length === 0) {
                summaryEl.textContent = '你的红包还没被领取。';
                modal.style.display = 'flex';
                return;
            }

            // 找出“手气最佳”
            const bestLuckClaimer = claimers.reduce((max, current) => (current.amount > max.amount) ? current : max, claimers[0]);

            for (const claimer of claimers) {
                let claimerProfile = null;
                if (claimer.userId === 'myProfile') {
                    claimerProfile = state.myProfile;
                } else {
                    // 尝试在联系人中查找，如果找不到，则认为是路人甲
                    claimerProfile = state.contacts.find(c => c.id === claimer.userId) || 
                                     state.posts.flatMap(p => p.comments.map(c => c.author)).find(a => a.id === claimer.userId);
                }
                
                if (!claimerProfile) { // 如果还是找不到（比如是一个未知的路人ID）
                    claimerProfile = { name: '一位路人', avatar: 'https://via.placeholder.com/40/DDD/666?text=?' };
                }

                const item = document.createElement('div');
                item.className = 'claimer-item';
                
                let bestLuckHTML = '';
                if (claimer.userId === bestLuckClaimer.userId) {
                    bestLuckHTML = '<span class="best-luck-badge">手气最佳</span>';
                }

                item.innerHTML = `
                    <img src="${claimerProfile.avatar}" class="claimer-avatar">
                    <div class="claimer-info">
                        <div class="claimer-name">${claimerProfile.name}</div>
                        <div class="claim-time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                    </div>
                    <div class="claim-amount">${claimer.amount.toFixed(2)} 元 ${bestLuckHTML}</div>
                `;
                listEl.appendChild(item);
            }
            
            const totalClaimedAmount = claimers.reduce((sum, c) => sum + c.amount, 0);
            summaryEl.textContent = `${claimers.length}个红包共领取${totalClaimedAmount.toFixed(2)}元`;

            modal.style.display = 'flex';
        }
        
          async function showRedPacketModal(message, contact) {
            const packetData = message.content;
            const modal = document.getElementById('red-packet-modal');
            
            // 1. 设置弹窗内容
            document.getElementById('red-packet-sender-avatar').src = contact.avatar;
            document.getElementById('red-packet-sender-name').textContent = `${contact.name}的红包`;
            document.getElementById('red-packet-blessing-text').textContent = packetData.blessing;

            // 2. 重置弹窗UI状态
            document.getElementById('open-red-packet-btn').style.display = 'flex';
            document.getElementById('open-red-packet-btn').style.transform = 'rotate(0deg)';
            document.getElementById('red-packet-result').style.display = 'none';
            document.getElementById('red-packet-content').style.backgroundColor = '#DB5A48';

            // 3. 【关键修复】使用克隆节点的方法安全地绑定事件，防止重复监听
            const oldOpenBtn = document.getElementById('open-red-packet-btn');
            const newOpenBtn = oldOpenBtn.cloneNode(true);
            oldOpenBtn.parentNode.replaceChild(newOpenBtn, oldOpenBtn);

            const oldCloseBtn = document.getElementById('close-red-packet-modal');
            const newCloseBtn = oldCloseBtn.cloneNode(true);
            oldCloseBtn.parentNode.replaceChild(newCloseBtn, oldCloseBtn);

            const oldDetailsLink = document.getElementById('view-red-packet-details');
            const newDetailsLink = oldDetailsLink.cloneNode(true);
            oldDetailsLink.parentNode.replaceChild(newDetailsLink, oldDetailsLink);

            // 4. 为新克隆的按钮添加事件监听
            newCloseBtn.addEventListener('click', () => modal.style.display = 'none');
            newDetailsLink.addEventListener('click', (e) => {
                e.preventDefault();
                showRedPacketDetails(packetData, contact);
            });

            // 5. 根据红包状态决定显示内容
            if (packetData.opened) {
                newOpenBtn.style.display = 'none';
                document.getElementById('red-packet-result').style.display = 'block';
                document.getElementById('red-packet-amount-text').textContent = `¥${packetData.amount}`;
                document.getElementById('red-packet-collected-by').textContent = '已存入零钱';
            } else {
                newOpenBtn.addEventListener('click', async () => {
                    const amount = parseFloat(packetData.amount);
                    
                    // 更新余额和交易记录
                    state.myProfile.balance += amount;
                    await addTransaction('income', amount, `收到 ${contact.name} 的红包`, contact.id);
                    await kokoMemory.put('myProfile', state.myProfile);
                    renderMyProfile();

                    // 更新红包消息的状态
                    message.content.opened = true;
                    await kokoMemory.put('contacts', contact);

                    // 播放动画并更新弹窗UI
                    newOpenBtn.style.transform = 'rotate(720deg)';
                    await sleep(500);

                    newOpenBtn.style.display = 'none';
                    document.getElementById('red-packet-result').style.display = 'block';
                    document.getElementById('red-packet-amount-text').textContent = `¥${packetData.amount}`;
                    document.getElementById('red-packet-collected-by').textContent = '已存入零钱';
                    document.getElementById('red-packet-content').style.backgroundColor = '#E4A095';

                    // 同步更新聊天界面中的红包卡片状态
                    const messageWrapperEl = document.querySelector(`.message-wrapper[data-message-id='${message.id}']`);
                    if (messageWrapperEl) {
                        const innerMessageEl = messageWrapperEl.querySelector('.message.red-packet');
                        if (innerMessageEl) {
                            innerMessageEl.classList.add('opened');
                            const headerEl = innerMessageEl.querySelector('.red-packet-header');
                            if (headerEl) {
                                headerEl.innerHTML = `<div class="red-packet-icon">🧧</div><div class="red-packet-status">红包已被领取</div>`;
                            }
                        }
                    }

                    // 请求AI对此作出回应
                    await requestAiReply(`[SYSTEM: 我刚刚打开了你发的红包，金额是${amount.toFixed(2)}元。请对此表示感谢或发表评论。]`);

                    await sleep(1500);
                    modal.style.display = 'none';
                });
            }
            
            modal.style.display = 'flex';
        }
        async function openForumRedPacketModal(postId) {
            const post = state.posts.find(p => p.id === postId);
            if (!post || !post.redPacket) return;

            const modal = document.getElementById('red-packet-modal');
            
            // 1. 设置弹窗内容
            document.getElementById('red-packet-sender-avatar').src = post.author.avatar;
            document.getElementById('red-packet-sender-name').textContent = `${post.author.name}的红包`;
            document.getElementById('red-packet-blessing-text').textContent = post.redPacket.blessing;

            // 2. 重置弹窗UI状态
            document.getElementById('open-red-packet-btn').style.display = 'flex';
            document.getElementById('open-red-packet-btn').style.transform = 'rotate(0deg)';
            document.getElementById('red-packet-result').style.display = 'none';
            document.getElementById('red-packet-content').style.backgroundColor = '#DB5A48';

            // 3. 【关键修复】使用克隆节点的方法安全地绑定事件，防止卡死
            const oldOpenBtn = document.getElementById('open-red-packet-btn');
            const newOpenBtn = oldOpenBtn.cloneNode(true);
            oldOpenBtn.parentNode.replaceChild(newOpenBtn, oldOpenBtn);

            const oldCloseBtn = document.getElementById('close-red-packet-modal');
            const newCloseBtn = oldCloseBtn.cloneNode(true);
            oldCloseBtn.parentNode.replaceChild(newCloseBtn, oldCloseBtn);

            const oldDetailsLink = document.getElementById('view-red-packet-details');
            const newDetailsLink = oldDetailsLink.cloneNode(true);
            oldDetailsLink.parentNode.replaceChild(newDetailsLink, oldDetailsLink);

            // 4. 为新克隆的按钮添加事件监听
            newCloseBtn.addEventListener('click', () => modal.style.display = 'none');
            newDetailsLink.addEventListener('click', (e) => {
                e.preventDefault();
                showRedPacketDetails(post.redPacket, post.author);
            });

            // 5. 根据红包状态决定显示内容
            const myId = 'myProfile';
            // ▼▼▼ 修正点 ▼▼▼
            const hasClaimed = post.redPacket.claimers && post.redPacket.claimers.some(c => c.userId === myId);
            const isDepleted = post.redPacket.claimers && post.redPacket.claimers.length >= post.redPacket.count;
            // ▲▲▲ 修正点 ▲▲▲

            if (hasClaimed) {
                newOpenBtn.style.display = 'none';
                document.getElementById('red-packet-result').style.display = 'block';
                const myClaim = post.redPacket.claimers.find(c => c.userId === myId);
                document.getElementById('red-packet-amount-text').textContent = `¥${myClaim.amount.toFixed(2)}`;
                document.getElementById('red-packet-collected-by').textContent = '已存入零钱';
            } else if (isDepleted) {
                newOpenBtn.style.display = 'none';
                document.getElementById('red-packet-result').style.display = 'block';
                document.getElementById('red-packet-amount-text').textContent = `手慢了`;
                document.getElementById('red-packet-collected-by').textContent = '红包派完了';
            } else {
                newOpenBtn.addEventListener('click', async () => {
                    // 随机分配红包金额
                    const remainingCount = post.redPacket.count - (post.redPacket.claimers ? post.redPacket.claimers.length : 0);
                    const remainingAmount = post.redPacket.amount - (post.redPacket.claimers ? post.redPacket.claimers.reduce((sum, c) => sum + c.amount, 0) : 0);
                    let amount = 0;
                    if (remainingCount > 1) {
                        const avg = remainingAmount / remainingCount;
                        amount = Math.random() * avg * 2;
                        amount = Math.min(remainingAmount * 0.9, amount);
                    } else {
                        amount = remainingAmount;
                    }
                    amount = Math.max(0.01, parseFloat(amount.toFixed(2)));

                    // 更新余额和交易记录
                    state.myProfile.balance += amount;
                    await addTransaction('income', amount, `抢到 ${post.author.name} 的论坛红包`, null);
                    
                    // 更新红包状态
                    if (!post.redPacket.claimers) post.redPacket.claimers = [];
                    post.redPacket.claimers.push({ userId: myId, amount: amount });
                    
                    // 保存数据
                    await kokoMemory.put('myProfile', state.myProfile);
                    await kokoMemory.put('posts', post);

                    // 播放动画并更新UI
                    newOpenBtn.style.transform = 'rotate(720deg)';
                    await sleep(500);
                    newOpenBtn.style.display = 'none';
                    document.getElementById('red-packet-result').style.display = 'block';
                    document.getElementById('red-packet-amount-text').textContent = `¥${amount.toFixed(2)}`;
                    document.getElementById('red-packet-collected-by').textContent = '已存入零钱';
                    document.getElementById('red-packet-content').style.backgroundColor = '#E4A095';

                    await sleep(1500);
                    modal.style.display = 'none';
                    await renderMyProfile();
                });
            }
            
            modal.style.display = 'flex';
        }

        async function openChat(contactId) {
            if (editModeState.active) await exitEditMode();
            const contact = state.contacts.find(c => c.id === contactId);
            if (!contact) return;
            state.activeChatId = contactId;
            
            const messagesContainer = document.getElementById('chat-messages'); if (contact.isNarrativeMode) { messagesContainer.classList.add('narrative-mode-active'); } else { messagesContainer.classList.remove('narrative-mode-active'); }
            
            chatPagination[contactId] = 1;

            document.getElementById('chat-messages').innerHTML = '';

            hideAllScreens();
            document.getElementById('chat-screen').style.display = 'flex';
            document.getElementById('chat-contact-name').textContent = contact.name;
            document.getElementById('chat-contact-status').textContent = '在线'; 
            
            const chatPetContainer = document.getElementById('chat-pet-container');
            if (contact.pet && contact.isChatPetVisible) {
                chatPetContainer.style.display = 'block';
                updateChatPetVisuals(contact);
            } else {
                chatPetContainer.style.display = 'none';
            }

            renderChatMessages(contact);
            if (contact.unreadCount) {
                contact.unreadCount = 0;
                await kokoMemory.put('contacts', contact);
            }
        }

        function renderChatMessages(contact, loadAll = false) {
            const messagesContainer = document.getElementById('chat-messages');
            const isInitialRender = messagesContainer.innerHTML === '';
            
            if (isInitialRender) {
                messagesContainer.innerHTML = '';
            }

            const page = chatPagination[contact.id] || 1;
            const start = loadAll ? 0 : Math.max(0, contact.history.length - (page * MESSAGES_PER_PAGE));
            const end = loadAll ? contact.history.length : Math.max(0, contact.history.length - ((page - 1) * MESSAGES_PER_PAGE));
            
            const allMessagesInPage = contact.history.slice(start, end);

            // 智能过滤：检查当前是否处于编辑模式
            let messagesToRender;
            if (editModeState.active) {
                // 如果是编辑模式，就显示全部消息，不做任何过滤
                messagesToRender = allMessagesInPage;
            } else {
                // 如果是普通聊天模式，就和之前一样，把通话记录隐藏起来
                messagesToRender = allMessagesInPage.filter(msg => msg.type !== 'video_call_text');
            }

            const existingLoadMoreBtn = document.getElementById('load-more-messages');
            if (existingLoadMoreBtn) {
                existingLoadMoreBtn.remove();
            }
            
            let currentScrollHeight = messagesContainer.scrollHeight;

            if (!contact || !contact.history || contact.history.length === 0) {
                messagesContainer.innerHTML = `<div style="text-align: center; color: #999; padding: 20px;">和 ${contact ? contact.name : ''} 开始聊天吧！</div>`;
                return;
            }
            
            let fragment = document.createDocumentFragment();
            messagesToRender.forEach((msg, index) => {
    let isFirstInSequence = true;
    if (msg.type !== 'system_notification' && msg.sender !== 'system_instruction') {
        // 从当前消息（index）往前找，在【同一个过滤后的数组中】找到上一个有效消息
        let prevMsg = null;
        if (index > 0) {
            for (let i = index - 1; i >= 0; i--) {
                const potentialPrevMsg = messagesToRender[i];
                if (potentialPrevMsg.type !== 'system_notification' && potentialPrevMsg.sender !== 'system_instruction') {
                    prevMsg = potentialPrevMsg;
                    break; // 找到了就立刻停止
                }
            }
        }
        
        // 核心判断逻辑不变
        if (prevMsg && prevMsg.sender === msg.sender) {
            isFirstInSequence = false;
        }
    }
                const messageEl = createMessageElement(msg, contact, isFirstInSequence);
                if(messageEl) {
                     if (editModeState.active && editModeState.selectedMessageIds.has(msg.id)) {
                        messageEl.classList.add('selected');
                    }
                    fragment.appendChild(messageEl);
                }
            });
            
            if (isInitialRender) {
                messagesContainer.appendChild(fragment);
            } else {
                messagesContainer.insertBefore(fragment, messagesContainer.firstChild);
            }

            if (!loadAll && start > 0) {
                const loadMoreBtn = document.createElement('button');
                loadMoreBtn.id = 'load-more-messages';
                loadMoreBtn.textContent = '加载更早的记录...';
                loadMoreBtn.style.display = 'block';
                loadMoreBtn.onclick = () => {
                    chatPagination[contact.id]++;
                    renderChatMessages(contact);
                };
                messagesContainer.prepend(loadMoreBtn);
            }
            
            if (isInitialRender || editModeState.active) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            } else {
                 messagesContainer.scrollTop = messagesContainer.scrollHeight - currentScrollHeight;
            }
        }

        // --- C. 请用这个【完整版】函数替换您现有的 createMessageElement 函数 ---
        function createMessageElement(message, contact, isFirstInSequence) {
            if (message.sender === 'system_instruction') return null;

            if (message.type === 'system_notification') {
                const wrapper = document.createElement('div');
                wrapper.className = 'message-wrapper system-wrapper';
                wrapper.dataset.messageId = message.id;
                const notificationEl = document.createElement('div');
                notificationEl.className = 'system-notification';
                notificationEl.textContent = message.content;
                wrapper.appendChild(notificationEl);
                wrapper.addEventListener('click', () => handleMessageSelection(wrapper, message));
                return wrapper;
            }

            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper ${message.sender === 'user' ? 'sent' : 'received'}`;
            if (contact.isAvatarHidden && message.sender === 'contact') {
                wrapper.classList.add('contact-avatar-hidden');
            }
            wrapper.dataset.messageId = message.id; 
            if (isFirstInSequence) {
                wrapper.classList.add('is-first-in-sequence');
                wrapper.style.marginTop = '20px';
            }

            const senderInfo = message.sender === 'user' ? state.myProfile : contact;
            
            // --- 新增：构建引用消息框的HTML ---
            let quoteHTML = '';
            if (message.quote) {
                quoteHTML = `
                    <div class="message-quote" data-quoted-id="${message.quote.messageId}">
                        <div class="sender">${message.quote.senderName}</div>
                        <div class="content">${message.quote.content}</div>
                    </div>
                `;
            }

            let messageContentHTML = '';

            switch (message.type) {
                case 'html':
                    // 如果消息类型是 'html'，我们就不做任何处理，直接把它当成HTML渲染
                    messageContentHTML = `<div class="message ${message.sender === 'user' ? 'sent' : 'received'}">${quoteHTML}${message.content}</div>`;
                    break;
                case 'image':
                    messageContentHTML = `<div class="message image-message"><div class="message-image-container ${message.sender === 'user' ? 'sent' : 'received'}"><img src="${message.url}" class="message-image" alt="图片"></div></div>`;
                    break;
                case 'post_share': {
                    const post = state.posts.find(p => p.id === message.content.postId);
                    if (post) {
                        messageContentHTML = `
                        <div class="message post-share-card" data-post-id="${post.id}">
                            <div class="post-share-header">
                                <img src="${post.author.avatar}" class="post-share-avatar">
                                <span class="post-share-name">${post.author.name}</span>
                            </div>
                            <div class="post-share-content">${post.content}</div>
                            <div class="post-share-footer">分享的帖子</div>
                        </div>`;
                    } else {
                        messageContentHTML = `<div class="message received">帖子已被删除</div>`;
                    }
                    break;
                }
                case 'picture_description':
                    messageContentHTML = `<div class="message picture-description ${message.sender === 'user' ? 'sent' : 'received'}"><i class="fas fa-image"></i><span>[图片]</span></div>`;
                    break;
                case 'voice':
                    const voiceData = message.content;
                    const width = Math.min(200, 80 + parseInt(voiceData.duration) * 5) + 'px';
                    messageContentHTML = `<div class="message voice ${message.sender === 'user' ? 'sent' : 'received'}" style="width: ${width};"><div class="voice-duration">${voiceData.duration}''</div><i class="fas fa-wifi"></i></div>`;
                    break;
                case 'red_packet':
                    const packetData = message.content;
                    const statusHTML = packetData.opened ? `<div class="red-packet-status">红包已被领取</div>` : `<div class="red-packet-blessing">${packetData.blessing}</div>`;
                    messageContentHTML = `<div class="message red-packet ${packetData.opened ? 'opened' : ''} ${message.sender === 'user' ? 'sent' : 'received'}"><div class="red-packet-header"><div class="red-packet-icon">🧧</div>${statusHTML}</div><div class="red-packet-footer">聊天红包</div></div>`;
                    break;
                case 'transfer': {
                    const transferData = message.content;
                    let transferClasses = 'message transfer';
                    if (transferData.returned) {
                        transferClasses += ' returned';
                    } else if (transferData.completed) {
                        transferClasses += ' completed';
                    }
                    let footerText = '聊天转账';
                    if (transferData.returned) {
                        footerText = '转账已退还';
                    } else if (transferData.completed) {
                        footerText = message.sender === 'user' ? '对方已收款' : '已存入钱包';
                    }
                    messageContentHTML = `<div class="${transferClasses} ${message.sender === 'user' ? 'sent' : 'received'}"><div class="transfer-header"><div class="transfer-icon"><i class="fas fa-money-bill-wave"></i></div><div class="transfer-info"><div class="transfer-text">转账</div><div class="transfer-amount">¥ ${transferData.amount}</div></div></div><div class="transfer-footer">${footerText}</div></div>`;
                    break;
                }
                case 'music_share':
                    const music = message.content;
                    messageContentHTML = `
                    <div class="message music-share-card ${message.sender === 'user' ? 'sent' : 'received'}">
                        <div class="music-card-cover">
                            <i class="fas fa-music"></i>
                            <span class="music-card-play-btn"><i class="fas fa-play"></i></span>
                        </div>
                        <div class="music-card-info">
                            <div class="music-card-title">${music.title}</div>
                            <div class="music-card-artist">${music.artist || '未知艺术家'}</div>
                            <div class="music-card-progress-bar"><div class="music-card-progress"></div></div>
                            <div class="music-card-controls">
                                <span class="music-card-time">00:00</span>
                                <span class="music-card-loop-btn" title="列表循环"><i class="fas fa-repeat"></i></span>
                            </div>
                        </div>
                    </div>`;
                    break;
                case 'game_wheel': {
                    const wheel = message.content;
                    const myProfile = state.myProfile;
                    const contact = state.contacts.find(c => c.id === state.activeChatId);

                    const userResultHTML = wheel.results.user
                        ? `<div class="wheel-player-result">${wheel.results.user}</div>`
                        : `<button class="spin-btn" data-player="user">点击开转</button>`;

                    const contactResultHTML = wheel.results.contact
                        ? `<div class="wheel-player-result">${wheel.results.contact}</div>`
                        : `<div class="wheel-player-result">等待对方...</div>`;

                    messageContentHTML = `
                        <div class="message game-wheel-card">
                            <div class="wheel-card-title">🎲 ${wheel.name} 🎲</div>
                            <div class="wheel-card-result-area">
                                <div class="wheel-result-row">
                                    <span class="wheel-player-name">${myProfile.name}</span>
                                    ${userResultHTML}
                                </div>
                                <div class="wheel-result-row">
                                    <span class="wheel-player-name">${contact.name}</span>
                                    ${contactResultHTML}
                                </div>
                            </div>
                        </div>`;
                    break;
                }
                default: 
                    let formattedContent = message.content;
                    const tempDiv = document.createElement('div');
                    tempDiv.textContent = formattedContent;
                    formattedContent = tempDiv.innerHTML;
                    formattedContent = formattedContent.replace(/\{(.*?)\}/g, '<span class="narrative-psychology">$1</span>');
                    formattedContent = formattedContent.replace(/(?:&quot;|“|”|＂)(.*?)(?:&quot;|“|”|＂)/g, '<span class="narrative-speech">“$1”</span>');
                    formattedContent = formattedContent.replace(/\*(.*?)\*/g, '<span class="narrative-action">$1</span>');
                    formattedContent = formattedContent.replace(/\n/g, '<br>');
                    // ↓↓↓ 核心改动：将 quoteHTML 插入到消息内容之前
                    messageContentHTML = `<div class="message ${message.sender === 'user' ? 'sent' : 'received'}">${quoteHTML}${formattedContent}</div>`;
                    break;
            }

            if (message.type !== 'text') {
                messageContentHTML = quoteHTML + messageContentHTML;
            }

            const transcribedTextHTML = (message.type === 'voice' || message.type === 'picture_description') ? '<div class="transcribed-text"></div>' : '';
            
            // --- 新增：在消息体旁边添加回复按钮 ---
            const replyButtonHTML = '<i class="fas fa-reply reply-btn"></i>';

            wrapper.innerHTML = `
                <div class="message-avatar">
                    <img src="${senderInfo.avatar}" onerror="this.onerror=null;this.src='https://via.placeholder.com/40/DDD/666?text=U';">
                </div>
                <div class="message-body">
                    <div class="message-author-name">${senderInfo.name}</div>
                    ${messageContentHTML}
                    ${transcribedTextHTML}
                    <div class="message-timestamp">${message.time}</div>
                </div>
                ${replyButtonHTML}
            `;
            wrapper.addEventListener('click', () => handleMessageSelection(wrapper, message));
            return wrapper;
        }
        
        async function addSharedMemory(contact, description) {
            if (!contact) return;
            if (!contact.memories) contact.memories = [];

            const newMemory = {
                id: `memo_${Date.now()}`,
                timestamp: Date.now(),
                description: description
            };
            contact.memories.push(newMemory);
            await kokoMemory.put('contacts', contact);
        }

        async function checkForPetLevelUp(contact) {
            if (!contact.pet) return;
            const xpForNextLevel = 100;

            if (contact.pet.xp >= xpForNextLevel) {
                contact.pet.xp -= xpForNextLevel;
                contact.pet.level += 1;

                let evolutionMessage = '';
                let evolutionForm = contact.pet.form;

                if (contact.pet.level === 5 && contact.pet.form === 'baby') {
                    evolutionForm = 'toddler';
                    evolutionMessage = `在你们的精心照料下，史莱姆长大了！进化成了可爱的幼年期形态！`;
                } else if (contact.pet.level === 15 && contact.pet.form === 'toddler') {
                    evolutionForm = 'teenager';
                    evolutionMessage = `哇！光芒闪过，史莱姆再次进化，进入了活泼的少年期！`;
                }

                if (evolutionMessage) {
                    contact.pet.form = evolutionForm;
                    await createSystemNotification(evolutionMessage);
                    await requestAiReply(`[SYSTEM: 你们的宠物刚刚进化了！${evolutionMessage} 请你对此发表一段极其兴奋和开心的感言！]`);
                    await addSharedMemory(contact, `在LV.${contact.pet.level}时，我们的史莱姆进化成了“${evolutionForm}”形态！`);
                } else {
                    await createSystemNotification(`你们的聊天让史莱姆获得了成长！升到了 LV.${contact.pet.level}！`);
                }
                
                await kokoMemory.put('contacts', contact);
            }
        }

        async function addTransaction(type, amount, description, relatedContactId = null) {
            const newTransaction = {
                id: `txn_${Date.now()}`,
                timestamp: Date.now(),
                type: type, // 'income' 或 'expense'
                amount: amount,
                description: description,
                relatedContactId: relatedContactId
            };
            if (!state.transactions) state.transactions = [];
            state.transactions.push(newTransaction);
            await kokoMemory.put('transactions', newTransaction);
        }

        async function createAndAddMessage(messageData, sender = 'user') {
            const contact = state.contacts.find(c => c.id === state.activeChatId);
            if (!contact) return;

            if (contact.pet && sender !== 'system_instruction' && messageData.type !== 'system_notification') {
                contact.pet.xp += 1;
                await checkForPetLevelUp(contact);
            }
            
            // --- NEW: V7.0 如果是第一条消息，记录初次聊天时间 ---
            if (contact.history.length === 0) {
                contact.firstChatDate = Date.now();
            }

            const fullMessage = {
                id: `msg_${Date.now()}_${Math.random()}`,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                timestamp: Date.now(),
                sender: sender,
                ...messageData
            };
            
            if (!contact.history) contact.history = [];
            contact.history.push(fullMessage);
            
            if (fullMessage.sender !== 'system_instruction') {
                const messagesContainer = document.getElementById('chat-messages');
                let isFirstInSequence = true;
                if (contact.history.length > 1) {
                    let prevMsg = null;
                    for (let i = contact.history.length - 2; i >= 0; i--) {
                        if (contact.history[i].type !== 'system_notification' && contact.history[i].sender !== 'system_instruction') {
                            prevMsg = contact.history[i];
                            break;
                        }
                    }
                    if (prevMsg && prevMsg.sender === fullMessage.sender) {
                        isFirstInSequence = false;
                    }
                }
                const messageEl = createMessageElement(fullMessage, contact, isFirstInSequence);
                if(messageEl) {
                    if (messagesContainer.querySelector('div[style*="text-align: center"]')) {
                        messagesContainer.innerHTML = '';
                    }
                    messagesContainer.appendChild(messageEl);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }

            await kokoMemory.put('contacts', contact);
            if (fullMessage.sender !== 'system_instruction') {
                await renderContacts();
            }
            
            return fullMessage;
        }

        async function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const content = messageInput.value.trim();
            if ((!content && !activeReplyTarget) || !state.activeChatId) return;

            // --- 核心修改在这里 ---
            // 1. 先判断消息内容是不是HTML
            let messageType = 'text'; // 默认是普通文本
            const trimmedContent = content.trim();
            if (trimmedContent.startsWith('<') && trimmedContent.endsWith('>')) {
                messageType = 'html'; // 如果看起来像HTML，就把类型改成'html'
            }

            // 2. 用判断出来的类型创建消息
            const messageData = { type: messageType, content: content };
            
            if (activeReplyTarget) {
                const senderName = activeReplyTarget.sender === 'user' ? state.myProfile.name : state.contacts.find(c => c.id === state.activeChatId).name;
                messageData.quote = {
                    messageId: activeReplyTarget.id,
                    senderName: senderName,
                    content: activeReplyTarget.content
                };
            }

            await createAndAddMessage(messageData);

            messageInput.value = '';
            messageInput.style.height = '38px'; // 恢复到初始的 min-height
            messageInput.focus();
            cancelReply(); // 发送后清除引用状态
        }

        const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

        async function requestAiReply(systemInstruction = null) {
            if (!state.activeChatId) return;
            const contact = state.contacts.find(c => c.id === state.activeChatId);
            if (!contact) return;

            if (systemInstruction) {
                 await createAndAddMessage({ type: 'text', content: systemInstruction }, 'system_instruction');
            }

            if (contact.history.filter(m => m.sender !== 'system_instruction').length === 0) {
                if (!systemInstruction) alert('请先发送消息再请求回复。');
                return;
            }

            await triggerAiReply(contact);
        }

        async function triggerAiReply(contact) {
            if (contact.needsNarrativeModeExitPrompt === true) { 
                const exitInstruction = "[SYSTEM COMMAND: CRITICAL instruction change! You have just exited Narrative Mode. Your response format MUST IMMEDIATELY return to the standard multi-line format. DO NOT write a long single paragraph. You MUST use commands like [sticker:name] on separate lines where appropriate. This is a strict and immediate format change.]"; 
                await createAndAddMessage({ type: 'text', content: exitInstruction }, 'system_instruction'); 
                delete contact.needsNarrativeModeExitPrompt;
            } 
          
            const chatStatusEl = document.getElementById('chat-contact-status'); 
            const originalStatus = chatStatusEl.textContent; 
            chatStatusEl.textContent = '对方正在输入...';

            if (!contact.apiCallCounter) {
                contact.apiCallCounter = 0;
            }
            contact.apiCallCounter++;
            
            try {
                const currentUserStatus = state.myProfile.status;
                if (contact) {
                    if (contact.lastKnownUserStatus && contact.lastKnownUserStatus !== currentUserStatus) {
                        const statusChangeInstruction = `[SYSTEM: 你的对话伙伴刚刚将状态从“${contact.lastKnownUserStatus}”改为了“${currentUserStatus}”。这是一个很好的机会，你可以自然地关心一下，比如问：“我看到你的状态变了，还好吗？”。这次之后就不用再提了。]`;
                        await createAndAddMessage({ type: 'text', content: statusChangeInstruction }, 'system_instruction');
                    }
                    contact.lastKnownUserStatus = currentUserStatus;
                }
            } catch (e) {
                console.error("更新用户状态记忆时出错:", e);
            }

            const lastUnopenedMessage = contact.history.slice().reverse().find(m =>
                m.sender === 'user' && (
                    (m.type === 'red_packet' && !m.content.opened) ||
                    (m.type === 'transfer' && !m.content.completed)
                )
            );

            if (lastUnopenedMessage) {
                let systemInstruction = '';
                if (lastUnopenedMessage.type === 'red_packet') {
                    systemInstruction = `[SYSTEM: You have just received a red packet from the user. The blessing is: "${lastUnopenedMessage.content.blessing}". Decide whether to accept it and reflect your decision in your response.]`;
                } else if (lastUnopenedMessage.type === 'transfer') {
                    systemInstruction = `[SYSTEM: You have just received a transfer of ${lastUnopenedMessage.content.amount}元 from the user. Decide whether to accept or reject it and reflect your decision in your response.]`;
                }
                await createAndAddMessage({ type: 'text', content: systemInstruction }, 'system_instruction');
            }
            
            try {
                if (contact.pet && contact.isChatPetVisible && Math.random() < 0.25) {
                    let petActionSystemMessage = null;

                    if (contact.pet.hunger < 40) {
                        petActionSystemMessage = `[SYSTEM: 悬浮在屏幕上的史莱姆看起来饿了，请你关心一下它。]`;
                    } else if (contact.pet.happiness < 40) {
                        petActionSystemMessage = `[SYSTEM: 悬浮在屏幕上的史莱姆看起来不开心，请你提及一下这件事。]`;
                    }
                    
                    if (petActionSystemMessage) {
                        await createAndAddMessage({ type: 'text', content: petActionSystemMessage }, 'system_instruction');
                    }
                }

                const forceDiary = (contact.apiCallCounter % 3 === 0);
                const rawResponse = await generateAiResponse(contact, contact.history, null, forceDiary, 'chat');
                
                await processAndDisplayAiResponse(rawResponse, contact);

            } finally {
                chatStatusEl.textContent = originalStatus;
                contact.history = contact.history.filter(m => m.sender !== 'system_instruction');
                await kokoMemory.put('contacts', contact);
            }
        }
        
        function getApiFor(type = 'chat') {
            if (type === 'square' && state.squareApiSettings.apiKey && state.squareApiSettings.endpoint && state.squareApiSettings.model) {
                return state.squareApiSettings;
            }
            return state.apiSettings;
        }
        
        // --- MODIFIED V8.0: 增强记忆流，使其能识别音乐分享，识别转盘 ---
        // ▼▼▼ 最终·真·完整版，请直接复制替换 ▼▼▼
async function generateAiResponse(contact, history, customSystemPrompt, forceDiary = false, apiType = 'chat') {
    const apiConfig = getApiFor(apiType);
    const { apiKey, model, endpoint, contextLength, longTermMemoryLength } = apiConfig;

    if (!apiKey || !endpoint || !model) {
        const errorMsg = `错误：${apiType === 'square' ? '论坛' : '聊天'}API未配置。请前往“发现-API设置”进行配置。`;
        console.error(errorMsg);
        return errorMsg;
    }

    let chatEndpoint = endpoint;
    if (!chatEndpoint.endsWith('/')) chatEndpoint += '/';
    chatEndpoint += 'v1/chat/completions';

    let requestMessages;

    if (customSystemPrompt) {
        requestMessages = [{ role: 'system', content: "You are a helpful assistant." }, { role: 'user', content: customSystemPrompt }];
    } else {
        let unifiedMemoryStream = [];
        const myProfile = state.myProfile;
        const now = Date.now();
        const memoryWindow = 24 * 60 * 60 * 1000; 

        if (contact && contact.history) {
            const recentChatHistory = contact.history.filter(msg => (now - msg.timestamp < memoryWindow));
            recentChatHistory.forEach(msg => {
                let content = '';
                let memoryType = '私聊';

                switch (msg.type) {
                    case 'text':
                        content = msg.content;
                        break;
                    // --- 【视频通话新增】 ---
                    case 'video_call_text':
                        memoryType = '视频通话中';
                        content = msg.content;
                        break;
                    // --- 【视频通话新增】 ---
                    case 'system_notification':
                        if (msg.content.includes('通话')) {
                            memoryType = '视频通话事件';
                            content = msg.content;
                        }
                        break;
                    case 'music_share':
                        content = `分享了一首音乐: 《${msg.content.title}》。`;
                        break;
                    case 'post_share':
                        const post = state.posts.find(p => p.id === msg.content.postId);
                        if (post) {
                            let postDetails = `分享了一个帖子。\n[帖子作者]: ${post.author.name}\n[帖子内容]: "${post.content}"`;
                            if (post.comments && post.comments.length > 0) {
                                postDetails += `\n[部分评论]:\n` + post.comments.slice(-6).map(c => `- ${c.author.name}: "${c.content}"`).join('\n');
                            }
                            content = postDetails;
                        } else {
                            content = `(分享了一个帖子，但该帖子已被删除)`;
                        }
                        break;
                }

                if (content) {
                    const authorName = msg.sender === 'user' ? myProfile.name : (contact.name || '系统');
                    unifiedMemoryStream.push({
                        timestamp: msg.timestamp,
                        type: memoryType,
                        author: authorName,
                        content: content
                    });
                }
            });
        }

        const recentPosts = state.posts.filter(p => now - p.timestamp < memoryWindow);
        recentPosts.forEach(post => {
            const isMyPost = post.author.id === myProfile.id;
            const isContactPost = contact && (post.author.id === contact.id);
            const isInteracted = contact && post.comments.some(c => c.author.id === myProfile.id || c.author.id === contact.id);

            if (isMyPost || isContactPost || isInteracted) {
                unifiedMemoryStream.push({
                    timestamp: post.timestamp,
                    type: '论坛',
                    author: post.author.name,
                    content: `发布了动态: "${post.content}"`
                });

                post.comments.forEach(comment => {
                    let formattedContent = (comment.replyTo ? `回复“${comment.replyTo}”` : '') + `: “${comment.content}”`;
                    unifiedMemoryStream.push({
                        timestamp: comment.timestamp,
                        type: '论坛评论',
                        author: comment.author.name,
                        content: formattedContent
                    });
                });
            }
        });

        unifiedMemoryStream.sort((a, b) => a.timestamp - b.timestamp);
        
        const memoryLimit = longTermMemoryLength || 30;
        const finalMemoryString = unifiedMemoryStream.slice(-memoryLimit).map(mem => {
            const authorTag = (mem.author === myProfile.name) ? "(你)" : "";
            return `[${mem.type}] ${mem.author}${authorTag}: ${mem.content}`;
        }).join('\n') || "(还没有任何记忆)";
        
        let finalSystemPrompt;
        const isNarrativeMode = contact?.isNarrativeMode;

        // ...
        if (isNarrativeMode) {
            // --- 主要改动点：明确指令为第三人称，并修改所有示例 ---
            finalSystemPrompt = `[重要指令：你将以【第三人称视角】进行深度叙事角色扮演，模仿SillyTavern的风格。你的所有回复都必须是一个单一、连贯、完整的文本块。]\n\n[核心任务]\n针对用户的输入，生成一段详尽的、以【第三人称】描述角色行为的、包含环境描写、角色动作、心理活动和对话的回复。\n\n[文学风格]\n你的写作风格需要遵循高端女性向文学（类似晋江文学城的流行风格）。文笔必须细腻、注重情感的拉扯和暧昧氛围的营造。\n\n[亲密场景风格指南]\n在描写任何亲密或带有性张力的场景时，风格上请借鉴海棠文学网站上常见的高质量作品，注重心理和感官的双重描写，用细腻的笔触展现角色的情欲流动和情感变化，避免粗俗直白的语言。\n\n[内容限制]\n你的发言必须积极向上，充满希望。严禁探讨任何形式的阴谋论，严禁表达或引导至绝望、悲观或虚无主义的情绪。故事的基调应该是温暖、治愈或充满张力的浪漫。\n\n[禁用词列表]\n绝对禁止使用以下或类似的、充满“霸道总裁”刻板印象的油腻词语：\n- 小妖精\n- 嘴上说不要\n- 说着不要\n- 惹火\n- 磨人\n- 玩火\n- 黑甜的梦\n\n[格式优化]\n为了提高可读性，你可以在叙事段落之间使用换行符（空行）来自然地分隔场景、对话或时间跳跃。这会让整个回复在同一个聊天气泡内显示，但内部有清晰的分段，更易于阅读。\n\n[!!! 格式化核心规则 (必须严格遵守) !!!]\n你的回复必须使用以下三种标记来自然地组织内容，你可以自由地混合并穿插使用它们，以形成一段连贯的叙事：\n\n1.  **【动作/叙述】**：所有角色的动作、表情、环境描写等非对话内容，**必须**用星号包裹。 范例： *他微笑着点了点头。*\n2.  **【心理活动】**：所有角色的内心想法、感受、猜测等，**必须**用大括号包裹。 范例： {原来用户也是这么想的。}\n3.  **【角色对话】**：所有角色说出的话，**必须**用标准的中文引号包裹。 范例： “你好，很高兴认识你。”\n\n[！！！绝对核心规则：关于日记！！！]\n在你完整的叙事（包含动作、心理和对话）结束后，你必须在回复的【最后部分】，另起新的一行，使用 \`[diary]...[/diary]\` 标签写一篇日记。日记是【角色】对当前对话的思考、感悟或内心独白。即使只是简单的想法，也必须写。这是强制要求，并且日记内容不应包含在主叙事块中。\n\n[示例回复格式]\n*他走到窗边，看着外面的雨滴。* “下雨了呢。” *他转过身，对你露出一丝微笑。* {不知道你喜不喜欢下雨天。} “你晚饭想吃什么？” *他轻轻地问，手指无意识地敲打着窗台。*\n[diary]今天和user聊天很开心，感觉我们的关系又近了一步。希望明天也能这样。[/diary]`;
        }
// ...
        else {
            const preset = state.thoughtPresets.find(p => p.id === contact?.thoughtPreset) || state.thoughtPresets.find(p => p.id === 'deep_roleplay_regex');
            finalSystemPrompt = preset ? preset.prompt : '你将进行角色扮演。';
            
            finalSystemPrompt = finalSystemPrompt.replace('{{emoticon_list}}', state.emoticons.map(e => `'${e.name}'`).join('， ') || '（无）');
            const musicListString = state.musicLibrary.map(song => `'${song.title} - ${song.artist}'`).join('\\n- ');
            finalSystemPrompt = finalSystemPrompt.replace('{{music_library_list}}', musicListString ? `- ${musicListString}` : '（曲库为空）');
        }

        let personaDirectives = "";
        if (contact?.persona) { personaDirectives += `\n\n# 核心角色指令 (Your Core Role Directive)\n---\n这是你的核心身份，你必须严格、完全地代入以下角色进行对话：\n${contact.persona}\n---`; }
        if (contact?.userPersona) { personaDirectives += `\n\n# 对话者信息 (Your Counterpart's Information)\n---\n与你对话的用户的角色设定如下，请将TA视为真实存在的角色并进行互动：\n${contact.userPersona}\n---`; }
        
        const firstLineEndIndex = finalSystemPrompt.indexOf(']');
        if (firstLineEndIndex !== -1 && personaDirectives) {
            finalSystemPrompt = finalSystemPrompt.slice(0, firstLineEndIndex + 1) + personaDirectives + finalSystemPrompt.slice(firstLineEndIndex + 1);
        } else {
            finalSystemPrompt = finalSystemPrompt + personaDirectives;
        }
        
        const worldBookContextString = (contact?.worldBooks || []).map(bookId => { const book = state.worldBooks.find(b => b.id === bookId); return book ? `\n[World Book Entry: ${book.name}]\n${book.content}` : ''; }).join('');

        let systemContent = isNarrativeMode ? finalSystemPrompt : finalSystemPrompt.replace("{{memory_stream}}", finalMemoryString);
        if (contact?.isTimeAware) { const currentTimeString = new Date().toLocaleString('zh-CN', { hour12: false }); const timeInstruction = `[Current Time: ${currentTimeString}] 这是当前的现实世界时间。你的回应需要体现出对这个时间的认知...\n\n`; systemContent = timeInstruction + systemContent; }
        if (worldBookContextString) { systemContent += `\n\n[Background Knowledge from World Books]\n${worldBookContextString}`; }
        
        // --- 【视频通话新增】 ---
        if (state.activeCall && contact && state.activeCall.contactId === contact.id) {
             systemContent += `\n\n[！！！当前情境：视频通话！！！]\n你现在正在和用户进行一场视频通话。你必须使用中文。你的所有感官和回应都必须基于这个场景。必须同时穿插使用神态/动作(*...*)、内心活动({...})和对话(“...”)这三种表达方式来描绘通话画面。禁止使用如 [sticker:] 等常规聊天指令。你可以使用的通话专用指令只有：[action:hang_up]。`;
        }

        const dynamicInstructions = history.filter(msg => msg.sender === 'system_instruction').map(msg => msg.content).join('\n');
        if (dynamicInstructions) { systemContent += `\n\n[附加临时指令]\n${dynamicInstructions}`; }

        const messages = history
            .filter(msg => msg.sender !== 'system_instruction')
            .slice(-(contextLength || 20))
            .map(msg => {
                if (msg.type === 'system_notification') return null;
                const role = (msg.sender === 'user') ? 'user' : 'assistant';
                let content = '';

                switch (msg.type) {
                    case 'text':
                    // --- 【视频通话新增】 ---
                    case 'video_call_text':
                        content = msg.content;
                        if (msg.quote) {
                            const quoteText = `[用户回复“${msg.quote.senderName}”说的“${msg.quote.content.substring(0, 50)}...”] `;
                            content = quoteText + content;
                        }
                        break;
                    case 'game_wheel': {
                        const wheel = msg.content;
                        const userName = (msg.sender === 'user') ? state.myProfile.name : contact.name;
                        const contactName = (msg.sender === 'user') ? contact.name : state.myProfile.name;
                        const optionsText = wheel.options.map(opt => opt.text).join('，');
                        if (!wheel.results.user) { content = `[系统游戏状态更新：游戏“${wheel.name}”已创建。选项：【${optionsText}】。游戏尚未开始，等待玩家操作。]`; } 
                        else if (wheel.results.user && !wheel.results.contact) { content = `[系统游戏状态更新：在游戏“${wheel.name}”中，${userName} 的操作结果为“${wheel.results.user}”。指令：${contactName} 必须执行 spin_wheel 操作。]`; } 
                        else if (wheel.results.user && wheel.results.contact) { content = `[系统游戏状态更新：游戏“${wheel.name}”已结束。最终结果：${userName} -> “${wheel.results.user}”，${contactName} -> “${wheel.results.contact}”。]`; }
                        break;
                    }
                    case 'image': if (msg.sender === 'assistant') return null; content = msg.isEmoticon && msg.emoticonName ? `[用户发送了表情包: ${msg.emoticonName}]` : '[用户发送了一张图片]'; break;
                    case 'picture_description': content = `[picture:${msg.content.description}]`; break;
                    case 'voice': content = `[voice:${msg.content.text}]`; break;
                    case 'red_packet': content = `[red_packet:${msg.content.blessing}, ${msg.content.amount}]`; break;
                    case 'transfer': content = `[transfer:${msg.content.amount}]`; break;
                    case 'music_share': content = `(分享了一首音乐: 《${msg.content.title}》 - ${msg.content.artist})`; break;
                    case 'post_share':
                        const post = state.posts.find(p => p.id === msg.content.postId);
                        content = post ? `(分享了一个帖子, 内容是: "${post.content.substring(0, 50)}...")` : `(分享了一个已删除的帖子)`;
                        break;
                    default: return null;
                }
                if (!content) return null;
                return { role, content };
            }).filter(Boolean);
        
        // --- 【视频通话新增】 ---
        if (state.activeCall && contact && state.activeCall.contactId === contact.id) {
            const initiator = state.activeCall.initiatedBy === 'user' ? '你' : contact.name;
            const statusUpdateContent = `[视频电话状态更新：由 ${initiator} 发起的通话正在进行中...]`;
            messages.unshift({ role: 'system', content: statusUpdateContent });
        }

        requestMessages = [{ role: 'system', content: systemContent }, ...messages];
    }
   
    try {
        const response = await fetch(chatEndpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({ model: model, messages: requestMessages })
        });
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error ? errorData.error.message : 'Unknown API error');
        }
        const data = await response.json();
        return data.choices[0].message.content.trim();
    } catch (error) {
        console.error('API调用失败:', error);
        return `抱歉，调用API时遇到问题: ${error.message}`;
    }
}

        
        // --- MODIFIED V7.0: 增强AI回复解析，使其能分享音乐 ---
        async function processAndDisplayAiResponse(rawResponse, contact) { 
            if (!contact) return;
            
            // ========================= 【核心修复】 =========================
            // 1. 将日记提取逻辑移动到函数最顶部，确保它最先执行。
            let conversation = rawResponse;
            let diaryContent = null;

            // 增强版日记识别：优先尝试匹配完整的 [diary]...[/diary] 标签
            const strictDiaryRegex = /\[diary\]([\s\S]*?)\[\/diary\]/g;
            const strictMatch = strictDiaryRegex.exec(conversation);

            if (strictMatch && strictMatch[1]) {
                // 如果找到完整匹配，就用这个结果
                diaryContent = strictMatch[1].trim();
                conversation = conversation.replace(strictDiaryRegex, '').trim();
            } else {
                // 如果找不到完整匹配，再尝试只根据开始标签 [diary] 来提取
                const lenientDiaryStartIndex = conversation.indexOf('[diary]');
                if (lenientDiaryStartIndex !== -1) {
                    // 提取从 '[diary]' 之后到字符串末尾的所有内容
                    diaryContent = conversation.substring(lenientDiaryStartIndex + '[diary]'.length).trim();
                    // 将原始对话内容截断到日记开始之前
                    conversation = conversation.substring(0, lenientDiaryStartIndex).trim();
                }
            }

            // 如果通过任何一种方式找到了日记内容，就保存它
            if (diaryContent) {
                if (!contact.diary) contact.diary = [];
                contact.diary.push({
                    id: `diary_${Date.now()}`,
                    content: diaryContent,
                    timestamp: Date.now()
                });
                await kokoMemory.put('contacts', contact);
            }
            // ======================= 【修复结束】 =======================


            // 2. 后续的逻辑现在都使用被处理过的 `conversation` 变量。
            const callTriggerRegex = /\[action:start_video_call\]|给你打个视频电话|我们来视频通话|拨通了你的电话|打过去了|播出去了|\[.*?(呼叫|拨打|视频|电话).*?\]/;
            if (callTriggerRegex.test(conversation)) { // <--- 注意：这里使用 conversation
                handleIncomingCall(contact);
                const callTriggerRegexForReplace = /\[action:start_video_call\]|给你打个视频电话|我们来视频通话|拨通了你的电话|打过去了|播出去了|\[.*?(呼叫|拨打|视频|电话).*?\]/g;
                const textResponse = conversation.replace(callTriggerRegexForReplace, '').trim(); // <--- 注意：这里使用 conversation
                if (textResponse) {
                     await createAndAddMessage({ type: 'text', content: textResponse }, 'contact');
                }
                return;
            }

            if (state.activeCall && state.activeCall.contactId === contact.id) {
                await createAndAddMessage({
                    type: 'video_call_text',
                    content: conversation // <--- 注意：这里使用 conversation
                }, 'contact');

                const narrativeFeed = document.getElementById('narrative-feed');
                const actionRegex = /\[action:(.*?)\]/g;
                let narrativeText = conversation; // <--- 注意：这里使用 conversation
                
                const match = actionRegex.exec(conversation); // <--- 注意：这里使用 conversation
                if (match) {
                    const action = match[1].trim();
                    switch(action) {
                        case 'hang_up':
                            narrativeText = conversation.replace(actionRegex, '').trim(); // <--- 注意：这里使用 conversation
                            if(narrativeText) {
                                const bubble = document.createElement('div');
                                bubble.className = 'char-bubble';
                                bubble.innerHTML = `<p class="narrative-speech">“${narrativeText}”</p>`;
                                narrativeFeed.appendChild(bubble);
                                narrativeFeed.scrollTop = narrativeFeed.scrollHeight;
                                await sleep(1000);
                            }
                            await endVideoCall('contact', `${contact.name} 挂断了电话`);
                            return;
                    }
                }

                if (narrativeText) {
                    const bubble = document.createElement('div');
                    bubble.className = 'char-bubble';
                    const regex = /(\*[^*]+\*)|(\{[^{}]+\})|(“[^”]+”)/g;
                    const parts = narrativeText.split(regex).filter(Boolean);
                    
                    parts.forEach(part => {
                        part = part.trim();
                        if (!part) return;
                        const p = document.createElement('p');
                        if (part.startsWith('*')) { p.className = 'narrative-action'; p.textContent = part; } 
                        else if (part.startsWith('{')) { p.className = 'narrative-psychology'; p.textContent = part; } 
                        else if (part.startsWith('“')) { p.className = 'narrative-speech'; p.textContent = part; } 
                        else { p.className = 'narrative-speech'; p.textContent = `“${part}”`; }
                        bubble.appendChild(p);
                    });
                    narrativeFeed.appendChild(bubble);
                    narrativeFeed.scrollTop = narrativeFeed.scrollHeight;
                }
                return; 
            }

            const lastUnopenedMessage = contact.history.slice().reverse().find(m =>
                m.sender === 'user' && (
                    (m.type === 'red_packet' && !m.content.opened) ||
                    (m.type === 'transfer' && !m.content.completed)
                )
            );

            if (lastUnopenedMessage) {
                const rejectionKeywords = ['不收', '不要', '退回', '还给你', '我不能要', '心意领了'];
                const acceptanceKeywords = ['收下', '收了', '领了', '打开', '谢谢', '我收', '我领'];
                const rejected = rejectionKeywords.some(keyword => conversation.includes(keyword)); // <--- 注意：这里使用 conversation
                
                if (rejected) {
                    if (lastUnopenedMessage.type === 'transfer') {
                        lastUnopenedMessage.content.completed = true;
                        lastUnopenedMessage.content.returned = true;
                        
                        const transferAmount = parseFloat(lastUnopenedMessage.content.amount);
                        if (!isNaN(transferAmount)) {
                            state.myProfile.balance += transferAmount;
                            await addTransaction('income', transferAmount, `来自 ${contact.name} 的转账退款`, contact.id);
                            renderMyProfile();
                            await kokoMemory.put('myProfile', state.myProfile);
                        }
                        await createSystemNotification(`${contact.name} 退还了你的转账`);
                    }
                } else {
                    const accepted = acceptanceKeywords.some(keyword => conversation.includes(keyword)); // <--- 注意：这里使用 conversation
                    if (accepted) {
                        let classToAdd = '';
                        if (lastUnopenedMessage.type === 'red_packet') {
                            lastUnopenedMessage.content.opened = true;
                            classToAdd = 'opened';
                        } else if (lastUnopenedMessage.type === 'transfer') {
                            lastUnopenedMessage.content.completed = true;
                            lastUnopenedMessage.content.returned = false;
                            classToAdd = 'completed';
                        }
                        
                        const messageWrapperEl = document.querySelector(`.message-wrapper[data-message-id='${lastUnopenedMessage.id}']`);
                        if (messageWrapperEl) {
                            const innerMessageEl = messageWrapperEl.querySelector('.message.red-packet, .message.transfer');
                            if (innerMessageEl) {
                                innerMessageEl.classList.add(classToAdd);
                                if (lastUnopenedMessage.type === 'red_packet') {
                                    const headerEl = innerMessageEl.querySelector('.red-packet-header');
                                    if (headerEl) {
                                        headerEl.innerHTML = `<div class="red-packet-icon">🧧</div><div class="red-packet-status">红包已被领取</div>`;
                                    }
                                }
                            }
                        }
                    }
                }
                await kokoMemory.put('contacts', contact);
                await sleep(100);
                await openChat(contact.id);
            }

            if (contact.isNarrativeMode) {
                if (conversation) {
                    await sleep(400 + Math.random() * 400); 
                    await createAndAddMessage({ type: 'text', content: conversation }, 'contact');
                }
            } else {
                const messages = conversation.split('\n').filter(line => line.trim() !== '');
                for (const line of messages) {
                    if (/^\[SYSTEM[:：]/.test(line.trim())) {
                        continue; 
                    }
                    let processed = false;
                    const commandRegex = /\[(sticker|voice|picture|red_packet|transfer|music|spin_wheel):([\s\S]*)\]/;
                    const commandMatch = line.match(commandRegex);
                    const lastWheelMsg = [...contact.history].reverse().find(m => m.type === 'game_wheel' && !m.content.results.contact);
                    if (lastWheelMsg) {
                        const contactName = contact.name;
                        const validOptions = lastWheelMsg.content.options.map(opt => opt.text);
                        const ultimatePositionalRegex = new RegExp(`(?:${contactName}|我).*?(?:[“"'])?(${validOptions.join('|')})(?:[“"'])?`);
                        const fallbackMatch = line.match(ultimatePositionalRegex);

                        if (fallbackMatch) {
                            const result = fallbackMatch[1];
                            const wheel = lastWheelMsg.content;
                            wheel.results.contact = result.trim();
                            await kokoMemory.put('contacts', contact);

                            const msgIdToUpdate = lastWheelMsg.id;
                            const wrapperToUpdate = document.querySelector(`.message-wrapper[data-message-id='${msgIdToUpdate}']`);
                            if(wrapperToUpdate) {
                                const contactResultRow = wrapperToUpdate.querySelectorAll('.wheel-result-row')[1];
                                if(contactResultRow) {
                                    contactResultRow.innerHTML = `<span class="wheel-player-name">${contact.name}</span> <div class="wheel-player-result">${result.trim()}</div>`;
                                }
                            }
                            continue; 
                        }
                    }

                    if (commandMatch) {
                        processed = true;
                        const command = commandMatch[1];
                        const value = commandMatch[2];
                        switch (command) {
                            case 'spin_wheel': {
                                const currentWheelMsg = [...contact.history].reverse().find(m => m.type === 'game_wheel' && !m.content.results.contact);
                                if (currentWheelMsg) {
                                    const wheel = currentWheelMsg.content;
                                    const weightedOptions = wheel.options.flatMap(opt => Array(opt.weight).fill(opt.text));
                                    const result = weightedOptions[Math.floor(Math.random() * weightedOptions.length)];
                                    wheel.results.contact = result;
                                    await kokoMemory.put('contacts', contact);
                                    const msgIdToUpdate = currentWheelMsg.id;
                                    const wrapperToUpdate = document.querySelector(`.message-wrapper[data-message-id='${msgIdToUpdate}']`);
                                    if(wrapperToUpdate) {
                                        const contactResultRow = wrapperToUpdate.querySelectorAll('.wheel-result-row')[1];
                                        if(contactResultRow) {
                                            contactResultRow.innerHTML = `<span class="wheel-player-name">${contact.name}</span> <div class="wheel-player-result">${result}</div>`;
                                        }
                                    }
                                }
                                break;
                            }
                            case 'sticker':
                                const emoticon = state.emoticons.find(e => e.name === value.trim());
                                if (emoticon) {
                                    await createAndAddMessage({ type: 'image', url: emoticon.url, isEmoticon: true, emoticonName: emoticon.name }, 'contact');
                                } else {
                                    await createAndAddMessage({ type: 'text', content: `[发送表情失败: ${value}]` }, 'contact');
                                }
                                break;
                            case 'voice':
                                const duration = Math.max(1, Math.round(value.length / 4));
                                await createAndAddMessage({ type: 'voice', content: { text: value, duration: duration } }, 'contact');
                                break;
                            case 'picture':
                                await createAndAddMessage({ type: 'picture_description', content: { description: value } }, 'contact');
                                break;
                            case 'red_packet': {
                                const parts = value.split(/[，,]/);
                                const blessing = parts[0] ? parts[0].trim() : "恭喜发财！";
                                const amount = parseFloat(parts[1]) || 0;
                                if (amount > 0) {
                                    await createAndAddMessage({ type: 'red_packet', content: { amount: amount.toFixed(2), blessing: blessing, opened: false } }, 'contact');
                                }
                                break;
                            }
                            case 'transfer': {
                                const transferAmount = parseFloat(value);
                                if (transferAmount > 0) {
                                     await createAndAddMessage({ type: 'transfer', content: { amount: transferAmount.toFixed(2), completed: false, returned: false } }, 'contact');
                                }
                                break;
                            }
                            case 'music': {
                                const lastComma = value.lastIndexOf('，') > -1 ? '，' : ',';
                                const lastCommaIndex = value.lastIndexOf(lastComma);
                                if (lastCommaIndex === -1) break; 
                                const url = value.substring(lastCommaIndex + 1).trim();

                                const secondToLastCommaIndex = value.lastIndexOf(lastComma, lastCommaIndex - 1);
                                if (secondToLastCommaIndex === -1) break;
                                
                                const artist = value.substring(secondToLastCommaIndex + 1, lastCommaIndex).trim();
                                const title = value.substring(0, secondToLastCommaIndex).trim();

                                if (url.startsWith('http') && title) {
                                    await createAndAddMessage({ 
                                        type: 'music_share', 
                                        content: { title, artist, url }
                                    }, 'contact');
                                }
                                break;
                            }
                        }
                    }

                    if (!processed) {
                        const trimmedLine = line.trim();
                        if (trimmedLine.startsWith('<') && trimmedLine.endsWith('>')) {
                            await createAndAddMessage({ type: 'html', content: line }, 'contact');
                        } else {
                            await createAndAddMessage({ type: 'text', content: line }, 'contact');
                        }
                    }
                    await sleep(400 + Math.random() * 400);
                }
            }
        }
        
        async function generateRandomTrendingTopicsAI() {
             const prompt = `[SYSTEM] 你的任务是作为创意总监。严格遵守格式，不要返回任何额外内容。\n任务：随机生成8个当前可能流行的、有趣的、多样化的中文社交网络热搜词条。\n词条应该覆盖不同领域，例如：生活吐槽、娱乐八卦、美食分享、社会热点、科技动态等。\n请以换行符分隔的形式，返回8个热搜词条：`;
            try {
                const response = await generateAiResponse(null, [], prompt, false, 'square');
                const topics = response.split('\n').map(t => t.replace(/^(-|\d+\.\s*)/, '').trim()).filter(Boolean);
                
                if (topics.length > 0) {
                     const newTrendingTopics = topics.slice(0, 8).map((topic, index) => ({
                        id: `topic_${Date.now()}_${index}`, title: topic,
                        heat: Math.floor(Math.random() * 500) + 50,
                        tag: index < 2 ? '热' : (index < 4 ? '新' : null)
                    })).sort((a,b) => b.heat - a.heat);
                    state.trendingTopics = newTrendingTopics;
                }
                // ▼▼▼ 在这里添加下面的代码 ▼▼▼
                try {
                    await kokoMemory.clear('trendingTopics'); // 先清空旧的热搜
                    await kokoMemory.bulkPut('trendingTopics', state.trendingTopics); // 再存入新的
                    console.log("热搜榜已成功保存到数据库。");
                } catch (dbError) {
                    console.error("保存热搜榜到数据库失败:", dbError);
                }
                // ▲▲▲ 添加代码结束 ▲▲▲

            } catch(e) {
                console.error("AI热搜生成失败:", e);
                throw new Error(`AI热搜生成失败: ${e.message}`);
            }
        }

        async function generatePostsForRecommendedTab(count = 5) {
            const newPosts = await generatePostsBatch(count, state.trendingTopics);
            await generateInitialCommentsForPosts(newPosts);
            state.posts.unshift(...newPosts);
            if (state.posts.length > 200) state.posts = state.posts.slice(0, 200);
            await kokoMemory.clear('posts');
            await kokoMemory.bulkPut('posts', state.posts);
            state.hasNewPosts = true;
            updateNotificationDots();
        }

        async function generatePostsBatch(count, topics = []) {
            const category = state.activeFeedSubTab;
            const categoryPrompts = {
                daily: "关于日常生活的趣事、吐槽、嗑cp或避雷经历",
                food: "关于美食的分享、探店、吐槽或避雷指南",
                gossip: "关于人际关系或娱乐圈的八卦讨论或互撕",
                horror: "恐怖小故事或灵异经历",
            };
            
            const authorsWithMemoryPrompt = state.contacts.map(c => {
                let recentChatHistory = '(最近没有私聊)';
                if (c.history && c.history.length > 0) {
                    recentChatHistory = c.history
                        .filter(msg => msg.type === 'text' && msg.sender !== 'system_instruction')
                        .slice(-8)
                        .map(msg => `${msg.sender === 'user' ? state.myProfile.name : c.name}: ${msg.content}`)
                        .join('\n    ');
                }
                return `- ${c.name} (人设: ${c.persona.replace(/\n/g, ' ')})\n  - [与“${state.myProfile.name}”的近期私聊参考]:\n    \`\`\`\n    ${recentChatHistory}\n    \`\`\``;
            }).join('\n');

            let topicsForPrompt = '';
            if (topics && topics.length > 0) {
                topicsForPrompt = `
[近期热搜话题参考]
当前论坛上的一些热门话题如下，你可以围绕它们进行创作，但不是必须：
${topics.map(t => `- ${t.title}`).join('\n')}
`;
            }

            const postsPrompt = `[SYSTEM] 你的任务是扮演一个内容生成引擎。\n\n[背景设定]\n- 论坛上有一个核心用户叫“${state.myProfile.name}”，TA的公开签名是：“${state.myProfile.signature}”。\n${topicsForPrompt} \n\n[任务]\n生成 ${count} 条关于“${categoryPrompts[category]}”的社交动态。\n你在为某个角色创作帖子时，**必须**仔细阅读他/她附带的“[近期私聊参考]”。你的帖子内容应该**优先作为这些私聊的自然延伸或有感而发**。\n例如，如果私聊中提到了某部电影，你就可以让该角色发表一篇关于这部电影的帖子。这比凭空创造话题更受鼓励。\n\n**[重要规则]**\n**在本次生成 ${count} 个帖子的任务中，对于下方 [可选的帖子作者列表] 里的每一个名字，你最多只能使用一次。如果联系人都用完了，或者你想增加多样性，请务必创造新的、不存在于列表中的“路人甲”来完成剩下的任务。**\n\n[绝对禁止]\n你生成的帖子的作者（AUTHOR）绝对不能是核心用户 “${state.myProfile.name}”。你只能扮演联系人列表中的角色或原创的路人甲。\n\n[可选的帖子作者列表及他们的短期记忆]\n${authorsWithMemoryPrompt || "- (无联系人信息)"}\n你也可以在灵感枯竭时，创造新的路人甲。\n\n[输出格式] 必须严格遵守:\nPOST_START\nAUTHOR: [作者名]\nIS_CONTACT: [true或者false]\nCONTENT: [动态的具体内容]\nPOST_END`;

            const rawPostsResponse = await generateAiResponse(null, [], postsPrompt, false, 'square');
            const postRegex = /POST_START\s*AUTHOR:\s*(?<author_name>.*?)\s*IS_CONTACT:\s*(?<is_existing_contact>true|false)\s*CONTENT:\s*(?<content>[\s\S]*?)\s*POST_END/g;
            const postMatches = Array.from(rawPostsResponse.matchAll(postRegex));

            if (postMatches.length === 0) throw new Error(`AI未能按格式要求生成任何动态。`);

            let newPosts = [];
            for (const match of postMatches) {
                const { author_name, is_existing_contact, content } = match.groups;
                let authorProfile;
                if (is_existing_contact.trim().toLowerCase() === 'true') {
                    const contact = state.contacts.find(c => c.name === author_name.trim());
                    if (contact) {
                        authorProfile = { id: contact.id, name: contact.name, avatar: contact.avatar, signature: contact.signature };
                    }
                }
                if (!authorProfile) {
                    authorProfile = {
                        id: `stranger_${Date.now()}_${Math.random()}`, name: author_name.trim(),
                        avatar: STRANGER_AVATARS[Math.floor(Math.random() * STRANGER_AVATARS.length)],
                        signature: ''
                    };
                }
                newPosts.push({
                    id: `post_${Date.now()}_${Math.random()}`, author: authorProfile, content: content.trim(),
                    category: category, timestamp: Date.now(),
                    likes: [], comments: [], reposts: 0,
                });
            }
            return newPosts;
        }

        async function processAiGeneratedComments(rawCommentsResponse, posts, commentRegex) {
            const commentMatches = Array.from(rawCommentsResponse.matchAll(commentRegex));
            const processedComments = [];

            for (const match of commentMatches) {
                const { post_index, commenter_name, reply_to, comment_content } = match.groups;
                const postIndex = parseInt(post_index, 10);

                if (postIndex >= 0 && postIndex < posts.length) {
                    const post = posts[postIndex];
                    let finalCommentContent = comment_content.trim();

                    // 检查是否包含抢红包指令
                    if (finalCommentContent.includes('[抢红包]')) {
                        if (post.redPacket) {
                            if (!post.redPacket.claimers) post.redPacket.claimers = [];
                            
                            const commenterId = `stranger_commenter_${Date.now()}_${Math.random()}`;
                            const hasClaimed = post.redPacket.claimers.some(c => c.userId === commenterId); // 理论上新生成的不会重复
                            const isDepleted = post.redPacket.claimers.length >= post.redPacket.count;

                            if (!isDepleted && !hasClaimed) {
                                // 分配红包金额
                                const remainingCount = post.redPacket.count - post.redPacket.claimers.length;
                                const remainingAmount = post.redPacket.amount - post.redPacket.claimers.reduce((sum, c) => sum + c.amount, 0);
                                
                                let amount = 0;
                                if (remainingCount > 1) {
                                    const avg = remainingAmount / remainingCount;
                                    amount = Math.random() * avg * 1.8; // 增加随机性
                                    amount = Math.min(remainingAmount - (remainingCount - 1) * 0.01, amount);
                                } else {
                                    amount = remainingAmount;
                                }
                                amount = Math.max(0.01, parseFloat(amount.toFixed(2)));

                                post.redPacket.claimers.push({ userId: commenterId, amount: amount });
                                
                                // 替换指令为实际显示内容
                                finalCommentContent = finalCommentContent.replace('[抢红包]', `🧧 领取了红包 (¥${amount.toFixed(2)})`);
                            } else {
                                finalCommentContent = finalCommentContent.replace('[抢红包]', '手慢了，红包派完了！');
                            }
                        } else {
                            // 帖子里没红包，但AI以为有
                            finalCommentContent = finalCommentContent.replace('[抢红包]', ''); 
                        }
                    }
                    
                    processedComments.push({
                        postIndex: postIndex,
                        comment: {
                            id: `comment_${Date.now()}_${Math.random()}`,
                            author: {
                                id: `stranger_commenter_${Date.now()}_${Math.random()}`, name: commenter_name.trim(),
                                avatar: STRANGER_AVATARS[Math.floor(Math.random() * STRANGER_AVATARS.length)]
                            },
                            content: finalCommentContent,
                            timestamp: post.timestamp + 10000 + (processedComments.length * 1000),
                            replyTo: (reply_to.trim().toLowerCase() === 'null' || reply_to.trim() === '') ? null : reply_to.trim(),
                        }
                    });
                }
            }
            return processedComments;
        }
        
        async function generateInitialCommentsForPosts(posts) {
             if (!posts || posts.length === 0) return;
             
             const postsForCommentPrompt = posts.map((post, index) => {
                let postInfo = `[POST ${index}] 作者: ${post.author.name}\n内容: ${post.content}`;
                if (post.redPacket) {
                    postInfo += `\n[重要信息：此帖附带一个“${post.redPacket.blessing}”的红包，总额${post.redPacket.amount}元，共${post.redPacket.count}个。]`;
                }
                return postInfo;
            }).join('\n\n');

            const commentsPrompt = `[SYSTEM] 你的任务是扮演一个“吃瓜群众”评论生成引擎，为下面的帖子生成有互动感的评论区。\n---\n${postsForCommentPrompt}\n---\n任务: 为以上帖子生成 2 到 4 条随机的、真实的、简短的评论。\n重要：为了让评论区更真实，请让评论之间有互动，即一些评论是回复另一条评论的。\n\n[红包互动指南]\n如果一个帖子带有[重要信息：此帖附带...红包]，你生成的评论中，应该有一部分人对此作出反应。为了模拟抢红包的动作，请在他们的评论内容中加入特殊指令 "[抢红包]"。例如：“谢谢老板！[抢红包]”、“来了来了[抢红包]”或“手慢了，不知道还有没有[抢红包]”。程序会自动处理这个指令。\n\n对于每一条评论，必须严格、完整地使用以下格式：\nCOMMENT_START\nINDEX: [评论指向的帖子编号]\nCOMMENTER: [随机想一个真实的中文网名]\nREPLY_TO: [被回复的评论者名字，如果没有则为null]\nCOMMENT: [评论内容，可能包含[抢红包]]\nCOMMENT_END`;

            const rawCommentsResponse = await generateAiResponse(null, [], commentsPrompt, false, 'square');
            const commentRegex = /COMMENT_START\s*INDEX:\s*(?<post_index>\d+)\s*COMMENTER:\s*(?<commenter_name>.*?)\s*REPLY_TO:\s*(?<reply_to>.*?)\s*COMMENT:\s*(?<comment_content>[\s\S]*?)\s*COMMENT_END/g;
            
            const processedComments = await processAiGeneratedComments(rawCommentsResponse, posts, commentRegex);

            processedComments.forEach(({ postIndex, comment }) => {
                posts[postIndex].comments.push(comment);
            });
            
            posts.forEach(p => p.comments.sort((a,b) => a.timestamp - b.timestamp));
        }
        
        async function generateMoreCommentsForPost(post) {
            const userComments = post.comments.filter(c => c.author.id === 'myProfile');
            const lastUserComment = userComments.length > 0 ? userComments[userComments.length - 1] : null;

            let prompt;
            if (lastUserComment) {
                prompt = `[SYSTEM] 你的任务是扮演一个“吃瓜群众”，为一个帖子生成有互动感的评论。\n用户“${lastUserComment.author.name}”刚刚在评论区发表了看法，请你生成2-3条新的、围绕TA的评论展开的讨论。\n\n[帖子信息]\n作者: "${post.author.name}"\n内容: "${post.content}"\n\n[用户评论参考]\n“${lastUserComment.author.name}”说: "${lastUserComment.content}"\n\n[任务]\n生成2-3条新的评论，可以是对用户观点的赞同、反驳或者提出新问题。让讨论看起来更真实。\n请严格使用以下格式，每条评论一行：\nCOMMENTER: [评论者名字] | REPLY_TO: [被回复者名字, 可以是${lastUserComment.author.name}或其他评论者] | COMMENT: [评论内容]`;
            } else {
                const existingComments = post.comments.map(c => `${c.author.name}: ${c.content}`).join('\n');
                prompt = `[SYSTEM] 你的任务是扮演一个“吃瓜群众”，为一个帖子添加2-3条新的、有互动感的评论，让评论区更热闹。\n\n[帖子信息]\n作者: "${post.author.name}"\n内容: "${post.content}"\n\n[现有评论区]\n${existingComments || "(还没有评论)"}\n\n[任务]\n生成2-3条新的评论，可以是回复某个人，也可以是发表新看法。\n请严格使用以下格式，每条评论一行：\nCOMMENTER: [评论者名字] | REPLY_TO: [被回复者名字, 如果没有则为null] | COMMENT: [评论内容]`;
            }

            const rawResponse = await generateAiResponse(null, [], prompt, false, 'square');
            const commentRegex = /COMMENTER:\s*(?<commenter_name>.*?)\s*\|\s*REPLY_TO:\s*(?<reply_to>.*?)\s*\|\s*COMMENT:\s*(?<comment_content>[\s\S]*?)(?:\n|$)/g;
            const matches = Array.from(rawResponse.matchAll(commentRegex)); 

            if (matches.length > 0) {
                 for (const match of matches) {
                    if (!match.groups) continue;
                    const { commenter_name, reply_to, comment_content } = match.groups;
                    let commenter = state.contacts.find(c => c.name === commenter_name.trim());
                    if (!commenter) {
                         commenter = {
                            id: `stranger_commenter_${Date.now()}_${Math.random()}`, name: commenter_name.trim(),
                            avatar: STRANGER_AVATARS[Math.floor(Math.random() * STRANGER_AVATARS.length)]
                        };
                    }
                     post.comments.push({
                        id: `comment_${Date.now()}_${Math.random()}`,
                        author: commenter,
                        content: comment_content.trim(),
                        timestamp: Date.now(),
                        replyTo: (reply_to.trim().toLowerCase() === 'null' || reply_to.trim() === '') ? null : reply_to.trim(),
                    });
                }
                await kokoMemory.put('posts', post);
            }
        }
        
        async function triggerAiCommentDiscussion(post, userComment) {
            showFeedStatus('正在生成AI回复...');
            try {
                let mentionedContact = null;
                const mentionRegex = /@([\w\u4e00-\u9fa5]+)/g;
                const mentionMatch = mentionRegex.exec(userComment.content);
                if (mentionMatch) {
                    const mentionedName = mentionMatch[1];
                    mentionedContact = state.contacts.find(c => c.name === mentionedName);
                }

                let mandatoryResponder = mentionedContact;
                if (!mandatoryResponder && userComment.replyTo) {
                    const repliedToContact = state.contacts.find(c => c.name === userComment.replyTo);
                    if (repliedToContact && repliedToContact.id !== 'myProfile') {
                        mandatoryResponder = repliedToContact;
                    }
                }
                
                let possibleResponders = state.contacts.filter(c => c.id !== userComment.author.id);
                if (mandatoryResponder) {
                    possibleResponders = possibleResponders.filter(c => c.id !== mandatoryResponder.id);
                }

                let guestResponder = null;
                if (possibleResponders.length > 0 && Math.random() < 0.3) {
                    guestResponder = possibleResponders[Math.floor(Math.random() * possibleResponders.length)];
                }

                let notableFiguresForPrompt = `\n[本楼出场人物信息]\n- 主帖作者: "${post.author.name}" (人设: "${post.author.persona || '普通人'}")`;

                const formatContactInfo = (contact, role) => {
                    const userPersona = contact.userPersona ? `你（${contact.name}）和用户“${userComment.author.name}”的私人关系是：“${contact.userPersona}”。` : `你（${contact.name}）和用户“${userComment.author.name}”是普通网友。`;
                    let recentChatHistory = '(暂无私聊记录)';
                    if (contact && contact.history && contact.history.length > 0) {
                        recentChatHistory = contact.history
                            .filter(msg => msg.type === 'text' && msg.sender !== 'system_instruction')
                            .slice(-10) 
                            .map(msg => `${msg.sender === 'user' ? userComment.author.name : contact.name}: ${msg.content}`)
                            .join('\n');
                    }
                    notableFiguresForPrompt += `\n- ${role}: "${contact.name}" (人设: "${contact.persona || '普通人'}")`;
                    
                    return `\n[${role} “${contact.name}” 的详细资料]\n- ${userPersona}\n- [近期私聊参考]:\n\`\`\`\n${recentChatHistory}\n\`\`\``;
                };

                let relationshipInfoForPrompt = '';
                if (mandatoryResponder) {
                    relationshipInfoForPrompt += formatContactInfo(mandatoryResponder, '必出场角色 (被@或被回复)');
                }
                if (guestResponder) {
                    relationshipInfoForPrompt += formatContactInfo(guestResponder, '可能客串的熟人');
                }
                if (!relationshipInfoForPrompt) {
                    relationshipInfoForPrompt = "[可参与讨论的角色信息]\n---（本次没有特定的熟人需要出场）---\n";
                } else {
                    relationshipInfoForPrompt = "[可参与讨论的角色信息]\n---" + relationshipInfoForPrompt + "\n---";
                }

                const conversationHistory = post.comments.filter(c => c.author.id === userComment.author.id || (mandatoryResponder && c.author.id === mandatoryResponder.id) || (guestResponder && c.author.id === guestResponder.id)).sort((a, b) => a.timestamp - b.timestamp).slice(-10);
                const conversationHistoryForPrompt = conversationHistory.map(c => `- ${c.author.name}: ${c.content}`).join('\n');
                
                let thirdPartyCommentPrompt = '';
                if (userComment.replyTo) {
                    const originalComment = post.comments.find(c => c.author.name === userComment.replyTo);
                    if (originalComment && (!mandatoryResponder || originalComment.author.id !== mandatoryResponder.id) && (!guestResponder || originalComment.author.id !== guestResponder.id) ) {
                        thirdPartyCommentPrompt = `\n[重要第三方评论]\n注意：用户是在回复“${originalComment.author.name}”的这条评论时与你互动的：“${originalComment.content}”`;
                    }
                }

                let postInfoForPrompt = `- 帖子作者: "${post.author.name}"\n- 帖子内容: "${post.content}"`;
                if (post.redPacket) {
                    const remainingPackets = post.redPacket.count - (post.redPacket.claimers ? post.redPacket.claimers.length : 0);
                    postInfoForPrompt += `\n- [红包信息]：此帖附带红包，祝福语“${post.redPacket.blessing}”，目前剩余 ${remainingPackets} 个。`;
                }

                const prompt = `[SYSTEM] 你是社交媒体讨论模拟器。用户“${userComment.author.name}”刚刚发表了一条评论，请你围绕这条评论，生成一段2-3人的真实讨论。\n\n[主帖子信息]\n${postInfoForPrompt}\n${thirdPartyCommentPrompt}\n[最近的评论对话历史]\n${conversationHistoryForPrompt}\n\n${relationshipInfoForPrompt}\n\n[重要规则：红包互动]\n如果帖子有[红包信息]，你的角色在回复时可以尝试抢红包。若要模拟抢红包，请在评论内容中加入特殊指令 "[抢红包]"。如果红包剩余为0，你可以发表“手慢了”之类的评论，但不要加[抢红包]指令。\n\n[重要规则：路人甲的反应逻辑]\n${notableFiguresForPrompt}\n当你要扮演一个原创的“路人甲”进行评论时，你必须优先检查上方“本楼出场人物信息”列表里所有角色的人设。\n1.  如果他们中【任何一人】的人设中包含“明星”、“名人”、“总裁”、“老师”、“画家”、“校园风云人物”等具有公众辨识度的身份，那么你扮演的“路人甲”在评论时，【有较高概率】应该体现出已经认识或认出了TA。\n2.  你的“路人甲”评论可以非常多样，例如：\n    - 直接认出：“天呐，这不是那个大明星XXX吗！居然在这里看见活的了！”\n    - 不敢相信：“楼上上是本人？我关注你好久了！”\n    - 对名人出现在普通帖子里感到惊讶：“笑死，总裁也来吃瓜吗？”\n    - 对其他路人进行科普：“姐妹，给你科普一下，楼主是XX大学那个超有名的XX教授。”\n3.  请你自行把握“认出来”和“没认出来”的路人甲比例，让评论区看起来更真实。\n\n[你的任务 - 重要！]\n1.  **优先回复**: 如果存在“[必出场角色]”，你的第一条或第二条回复**必须**由他/她发出。\n2.  **选择性客串**: 如果存在“[可能客串的熟人]”，**仅当**你觉得他/她的人设符合其人设且能让讨论更有趣时，才让他/她加入。这是**可选的**。\n3.  **营造真实感**: 剩下的回复名额，请**务必优先使用你原创的、符合当下场景的“路人甲”**来填充。\n4.  **严格遵守格式**: 所有回复都必须严格遵守 \`COMMENTER: [名字] | REPLY_TO: [回复对象] | COMMENT: [内容]\` 格式。\n\n[绝对禁止]\n在你的任何回复中，【绝对不能】使用“${userComment.author.name}”作为COMMENTER的名字。`;

                const rawResponse = await generateAiResponse(null, [], prompt, false, 'square');
                const commentRegex = /COMMENTER:\s*(?<commenter_name>.*?)\s*\|\s*REPLY_TO:\s*(?<reply_to>.*?)\s*\|\s*COMMENT:\s*(?<comment_content>[\s\S]*?)(?:\n|$)/g;
                const matches = Array.from(rawResponse.matchAll(commentRegex));

                if (matches.length > 0) {
                     for (const match of matches) {
                        if (!match.groups) continue;
                        const {
                            commenter_name,
                            reply_to,
                            comment_content
                        } = match.groups;

                        let commenterProfile = state.contacts.find(c => c.name === commenter_name.trim());
                        if (!commenterProfile) {
                            commenterProfile = {
                                id: `stranger_commenter_${Date.now()}_${Math.random()}`,
                                name: commenter_name.trim(),
                                avatar: STRANGER_AVATARS[Math.floor(Math.random() * STRANGER_AVATARS.length)]
                            };
                        }
                        
                        let finalCommentContent = comment_content.trim();
                        if (finalCommentContent.includes('[抢红包]')) {
                            if (post.redPacket) {
                                 if (!post.redPacket.claimers) post.redPacket.claimers = [];
                                 const hasClaimed = post.redPacket.claimers.some(c => c.userId === commenterProfile.id);
                                 const isDepleted = post.redPacket.claimers.length >= post.redPacket.count;

                                 if (!isDepleted && !hasClaimed) {
                                    const remainingCount = post.redPacket.count - post.redPacket.claimers.length;
                                    const remainingAmount = post.redPacket.amount - post.redPacket.claimers.reduce((sum, c) => sum + c.amount, 0);
                                    
                                    let amount = 0;
                                    if (remainingCount > 1) {
                                        const avg = remainingAmount / remainingCount;
                                        amount = Math.random() * avg * 1.8;
                                        amount = Math.min(remainingAmount - (remainingCount-1)*0.01, amount);
                                    } else {
                                        amount = remainingAmount;
                                    }
                                    amount = Math.max(0.01, parseFloat(amount.toFixed(2)));

                                    post.redPacket.claimers.push({ userId: commenterProfile.id, amount: amount });
                                    finalCommentContent = finalCommentContent.replace('[抢红包]', `🧧 领取了红包 (¥${amount.toFixed(2)})`);
                                 } else {
                                    finalCommentContent = finalCommentContent.replace('[抢红包]', '手慢了，红包派完了！');
                                 }
                            } else {
                                finalCommentContent = finalCommentContent.replace('[抢红包]', ''); 
                            }
                        }
                        
                         post.comments.push({
                            id: `comment_${Date.now()}_${Math.random()}`,
                            author: commenterProfile,
                            content: finalCommentContent,
                            timestamp: Date.now() + matches.indexOf(match) * 100,
                            replyTo: reply_to.trim(),
                        });
                    }
                    await kokoMemory.put('posts', post);
                    if (state.activePostId === post.id) {
                        await renderPostDetail();
                    }
                }
            } catch (e) {
                console.error("生成AI评论讨论失败:", e);
            } finally {
                hideFeedStatus();
            }
        }
        
        // --- MODIFIED V7.0: 增加分享音乐选项 ---
        // ▼▼▼ 新版本：renderAttachmentMenu ▼▼▼
function renderAttachmentMenu() {
    const menu = document.getElementById('attachment-menu');
    menu.innerHTML = `
        <div class="attachment-menu-item" data-action="send-picture">
            <div class="icon-wrapper"><i class="fas fa-image"></i></div>
            <div class="label">图片</div>
        </div>
        <div class="attachment-menu-item" data-action="send-voice">
            <div class="icon-wrapper"><i class="fas fa-microphone"></i></div>
            <div class="label">语音</div>
        </div>
        <div class="attachment-menu-item" data-action="send-red-packet">
            <div class="icon-wrapper"><i class="fas fa-wallet"></i></div>
            <div class="label">红包</div>
        </div>
        <div class="attachment-menu-item" data-action="send-transfer">
            <div class="icon-wrapper"><i class="fas fa-exchange-alt"></i></div>
            <div class="label">转账</div>
        </div>
        <div class="attachment-menu-item" data-action="share-music">
            <div class="icon-wrapper"><i class="fas fa-music"></i></div>
            <div class="label">音乐</div>
        </div>
        <div class="attachment-menu-item" data-action="game-wheel"> <div class="icon-wrapper"><i class="fas fa-bullseye"></i></div> <div class="label">转盘游戏</div> 
        </div>
        <div class="attachment-menu-item" data-action="start-video-call">
            <div class="icon-wrapper"><i class="fas fa-video"></i></div>
            <div class="label">视频通话</div>
        </div>
    `;
}
        // ↓↓↓ 把这个全新的函数整个粘贴进去 ↓↓↓
function addWheelOptionInput(text = '', weight = 1) {
    const container = document.getElementById('wheel-options-container');
    const newItem = document.createElement('div');
    newItem.className = 'wheel-option-item';
    newItem.innerHTML = `
        <input type="text" class="contact-form-input wheel-option-text" value="${text}" placeholder="选项内容">
        <input type="number" class="contact-form-input wheel-option-weight" value="${weight}" min="1" title="权重(份数)">
        <button class="delete-option-btn">&times;</button>
    `;
    container.appendChild(newItem);
    newItem.querySelector('.delete-option-btn').addEventListener('click', () => {
        // 至少保留2个选项
        if (container.children.length > 2) {
            newItem.remove();
        } else {
            alert('转盘至少需要2个选项哦！');
        }
    });
}
// ↑↑↑ 新增代码结束 ↑↑↑

        // --- MODIFIED V7.0: 增加处理分享音乐的逻辑 ---
        function handleAttachmentAction(action) {
            const menu = document.getElementById('attachment-menu');
            menu.classList.remove('active');

            const addOneTimeListener = (buttonId, callback) => {
                const oldBtn = document.getElementById(buttonId);
                const newBtn = oldBtn.cloneNode(true);
                oldBtn.parentNode.replaceChild(newBtn, oldBtn);
                newBtn.addEventListener('click', callback);
            };

            switch(action) {
                case 'send-picture': {
                    const modal = document.getElementById('send-picture-modal');
                    const descriptionInput = document.getElementById('send-picture-description-input');
                    descriptionInput.value = '';
                    modal.style.display = 'flex';
                    addOneTimeListener('confirm-send-picture-btn', async () => {
                        const description = descriptionInput.value.trim();
                        if (description) {
                            await createAndAddMessage({ type: 'picture_description', content: { description } });
                            modal.style.display = 'none';
                        }
                    });
                    break;
                }
                case 'send-voice': {
                    const modal = document.getElementById('send-voice-modal');
                    const voiceTextInput = document.getElementById('send-voice-text-input');
                    voiceTextInput.value = '';
                    modal.style.display = 'flex';
                    addOneTimeListener('confirm-send-voice-btn', async () => {
                        const voiceText = voiceTextInput.value.trim();
                        if (voiceText) {
                            const duration = Math.max(1, Math.round(voiceText.length / 4));
                            await createAndAddMessage({ type: 'voice', content: { duration, text: voiceText } });
                            modal.style.display = 'none';
                        }
                    });
                    break;
                }
                case 'send-red-packet': {
                    const modal = document.getElementById('send-red-packet-modal');
                    const amountInput = document.getElementById('send-red-packet-amount-input');
                    const blessingInput = document.getElementById('send-red-packet-blessing-input');
                    amountInput.value = '';
                    blessingInput.value = '';
                    modal.style.display = 'flex';
                    addOneTimeListener('confirm-send-red-packet-btn', async () => {
                        const amount = parseFloat(amountInput.value);
                        if (!isNaN(amount) && amount > 0) {
                             if(state.myProfile.balance < amount) {
                                alert('钱包余额不足！');
                                return;
                            }
                            state.myProfile.balance -= amount;
                            await addTransaction('expense', amount, `发红包给 ${state.contacts.find(c=>c.id === state.activeChatId).name}`, state.activeChatId);
                            renderMyProfile();
                            await kokoMemory.put('myProfile', state.myProfile);

                            await createAndAddMessage({
                                type: 'red_packet',
                                content: { amount: amount.toFixed(2), blessing: blessingInput.value.trim() || "恭喜发财，大吉大利！", opened: false }
                            });
                            modal.style.display = 'none';
                        } else {
                            alert("请输入有效的金额！");
                        }
                    });
                    break;
                }
                case 'send-transfer': {
                    const modal = document.getElementById('send-transfer-modal');
                    const amountInput = document.getElementById('send-transfer-amount-input');
                    amountInput.value = '';
                    modal.style.display = 'flex';
                    addOneTimeListener('confirm-send-transfer-btn', async () => {
                        const transferAmount = parseFloat(amountInput.value);
                        if (!isNaN(transferAmount) && transferAmount > 0) {
                            if(state.myProfile.balance < transferAmount) {
                                alert('钱包余额不足！');
                                return;
                            }
                            state.myProfile.balance -= transferAmount;
                            await addTransaction('expense', transferAmount, `转账给 ${state.contacts.find(c=>c.id === state.activeChatId).name}`, state.activeChatId);
                            renderMyProfile();
                            await kokoMemory.put('myProfile', state.myProfile);

                            await createAndAddMessage({
                                type: 'transfer',
                                content: { amount: transferAmount.toFixed(2), completed: false }
                            });
                            modal.style.display = 'none';
                        } else {
                            alert("请输入有效的金额！");
                        }
                    });
                    break;
                }
                 // --- NEW: V7.0 ---
                case 'share-music': {
                    const modal = document.getElementById('send-music-modal');
                    const urlInput = document.getElementById('send-music-url-input');
                    const titleInput = document.getElementById('send-music-title-input');
                    const artistInput = document.getElementById('send-music-artist-input');
                    const notifyCheckbox = document.getElementById('notify-ai-checkbox');
                    urlInput.value = '';
                    titleInput.value = '';
                    artistInput.value = '';
                    notifyCheckbox.checked = true;
                    modal.style.display = 'flex';
                    
                    renderMusicPickerInModal();

                    addOneTimeListener('confirm-send-music-btn', async () => {
                        const url = urlInput.value.trim();
                        const title = titleInput.value.trim();
                        const artist = artistInput.value.trim();
                        // ▼▼▼ 新增读取歌词输入框的代码 ▼▼▼
                        const lrc = document.getElementById('add-music-lrc-input').value.trim();

                        if (!url || !title) {
                            alert('请输入歌曲URL和歌曲名！');
                            return;
                        }
                        
                        const contact = state.contacts.find(c => c.id === state.activeChatId);
                        // ▼▼▼ 将lrc添加到song对象中 ▼▼▼
                        const song = { url, title, artist, lrc };
                        
                        // 添加到播放列表
                        contact.sharedPlaylist.tracks.push(song);
                        
                        await createAndAddMessage({ type: 'music_share', content: song });
                        
                        if (notifyCheckbox.checked) {
                            const systemPrompt = `[SYSTEM: 用户分享了一首歌曲《${title}》，来自${artist || '未知艺术家'}。请你发表一下你的感想，可以说说你是否听过，或者这首歌让你想起了什么。]`;
                            await requestAiReply(systemPrompt);
                        }

                        modal.style.display = 'none';
                    });
                    break;
                }
                
                    case 'game-wheel': {
    const modal = document.getElementById('create-wheel-modal');
    const optionsContainer = document.getElementById('wheel-options-container');
    document.getElementById('wheel-name-input').value = '';
    optionsContainer.innerHTML = ''; // 清空旧选项

    // 默认创建2个选项
    addWheelOptionInput('真心话', 1);
    addWheelOptionInput('大冒险', 1);

    modal.style.display = 'flex';
    break;
}
                    case 'start-video-call': if (state.activeChatId) { startVideoCall(state.activeChatId, 'user'); } else { alert("请先选择一个聊天对象！"); } break;
            }
        }
        
        function showDiaryScreen() {
            const contact = state.contacts.find(c => c.id === state.activeChatId);
            if (!contact) return;
            hideAllScreens();
            document.getElementById('diary-screen').style.display = 'flex';
            document.getElementById('diary-title').textContent = `${contact.name}的日记`;
            renderDiary();
        }

        function renderDiary() {
            const contact = state.contacts.find(c => c.id === state.activeChatId);
            const diaryContentList = document.getElementById('diary-content-list');
            diaryContentList.innerHTML = '';

            if (!contact || !contact.diary || contact.diary.length === 0) {
                diaryContentList.innerHTML = `<div style="text-align: center; padding: 50px 20px; color: #888;"><i class="fas fa-book" style="font-size: 48px; margin-bottom: 15px;"></i><p>他的日记本是空的。</p></div>`;
                return;
            }

            const sortedDiary = [...contact.diary].sort((a, b) => b.timestamp - a.timestamp);

            sortedDiary.forEach(entry => {
                const entryEl = document.createElement('div');
                entryEl.className = 'diary-entry';
                entryEl.innerHTML = `
                    <div class="diary-entry-meta">${formatTimeAgo(entry.timestamp)}</div>
                    <div class="diary-entry-content">${entry.content.replace(/\n/g, '<br>')}</div>
                    <div class="diary-delete-btn" data-diary-id="${entry.id}"><i class="fas fa-trash-alt"></i></div>
                `;
                diaryContentList.appendChild(entryEl);
            });
        }

        async function createSystemNotification(content) {
            const contact = state.contacts.find(c => c.id === state.activeChatId);
            if (!contact) return;

             await createAndAddMessage({
                type: 'system_notification',
                sender: 'system',
                content: content
            });
        }
        
        async function showTransferModal(message, contact) {
            const modal = document.getElementById('transfer-modal');
            
            // 获取新HTML结构中的所有元素
            const confirmView = document.getElementById('transfer-confirm-view');
            const statusView = document.getElementById('transfer-status-view');
            
            const senderAvatarEl = document.getElementById('transfer-sender-avatar');
            const senderNameEl = document.getElementById('transfer-sender-name');
            const recipientTextEl = document.getElementById('transfer-recipient-text');
            const amountValueEl = document.getElementById('transfer-amount-value');

            const statusAmountValueEl = document.getElementById('transfer-status-amount-value');
            const statusIconEl = document.getElementById('transfer-status-icon');
            const statusTextEl = document.getElementById('transfer-status-text');
            const statusSenderInfoEl = document.getElementById('transfer-status-sender-info');
            
            const sender = (message.sender === 'user') ? state.myProfile : contact;
            const recipient = (message.sender === 'user') ? contact : state.myProfile;
            
            amountValueEl.textContent = message.content.amount;
            statusAmountValueEl.textContent = message.content.amount;

            // --- 移除并重新绑定事件监听，防止重复绑定 ---
            const confirmBtn = document.getElementById('confirm-transfer-btn');
            const returnBtn = document.getElementById('return-transfer-btn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            const newReturnBtn = returnBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            returnBtn.parentNode.replaceChild(newReturnBtn, returnBtn);

            // 确认收款按钮的逻辑 (已修改)
            newConfirmBtn.addEventListener('click', async () => {
                const transferAmount = parseFloat(message.content.amount);
                if (!isNaN(transferAmount)) {
                    state.myProfile.balance += transferAmount;
                    await addTransaction('income', transferAmount, `收到 ${contact.name} 的转账`, contact.id);
                    await createSystemNotification(`你已收款 ¥${transferAmount.toFixed(2)}`);
                    renderMyProfile();
                    await kokoMemory.put('myProfile', state.myProfile);
                }
                message.content.completed = true;
                message.content.returned = false;
                await kokoMemory.put('contacts', contact); 
                
                modal.style.display = 'none';
                await openChat(contact.id);

                // **关键修复：** 添加系统指令，通知AI转账已被接收
                await createAndAddMessage({
                    type: 'text',
                    content: `[SYSTEM: 我刚刚点击并接受了你的转账。]`
                }, 'system_instruction');
            });
            
            // 退还按钮的逻辑
            newReturnBtn.addEventListener('click', async () => {
                message.content.completed = true;
                message.content.returned = true;
                
                await kokoMemory.put('contacts', contact);
                await createSystemNotification(`你已退还该笔转账`);
                
                modal.style.display = 'none';
                await openChat(contact.id);
                
                // 添加系统指令到记忆中，不立即触发回复
                await createAndAddMessage({
                    type: 'text',
                    content: `[SYSTEM: 我刚刚退回了你的转账。]`
                }, 'system_instruction');
            });

            // 根据消息状态更新UI
            senderAvatarEl.src = sender.avatar;
            senderNameEl.textContent = sender.name;
            
            if (message.content.completed || message.content.returned) {
                // 如果是已完成或已退还的交易
                confirmView.style.display = 'none';
                statusView.style.display = 'block';
                
                statusIconEl.className = message.content.returned ? 'fas fa-undo-alt' : 'fas fa-check-circle';
                statusTextEl.textContent = message.content.returned ? '已退还' : (message.sender === 'user' ? '对方已收款' : '已收款');
                statusSenderInfoEl.textContent = `转账来自: ${sender.name}`;

            } else if (message.sender !== 'user') { // 我是收款方，未处理
                confirmView.style.display = 'block';
                statusView.style.display = 'none';
                recipientTextEl.textContent = "转账给你";
                newConfirmBtn.style.display = 'block';
                newReturnBtn.style.display = 'block';
            } else { // 我是付款方，对方未处理
                confirmView.style.display = 'block';
                statusView.style.display = 'none';
                recipientTextEl.textContent = `转账给 ${recipient.name}`;
                newConfirmBtn.style.display = 'none';
                newReturnBtn.style.display = 'none';
            }
            
            modal.style.display = 'flex';
            document.getElementById('close-transfer-modal').onclick = () => modal.style.display = 'none';
        }

        async function processAndDisplayAiResponse(rawResponse, contact) { 
            if (!contact) return;
            
            // ========================= 【核心修复】 =========================
            // 1. 将日记提取逻辑移动到函数最顶部，确保它最先执行。
            let conversation = rawResponse;
            let diaryContent = null;

            // 增强版日记识别：优先尝试匹配完整的 [diary]...[/diary] 标签
            const strictDiaryRegex = /\[diary\]([\s\S]*?)\[\/diary\]/g;
            const strictMatch = strictDiaryRegex.exec(conversation);

            if (strictMatch && strictMatch[1]) {
                // 如果找到完整匹配，就用这个结果
                diaryContent = strictMatch[1].trim();
                conversation = conversation.replace(strictDiaryRegex, '').trim();
            } else {
                // 如果找不到完整匹配，再尝试只根据开始标签 [diary] 来提取
                const lenientDiaryStartIndex = conversation.indexOf('[diary]');
                if (lenientDiaryStartIndex !== -1) {
                    // 提取从 '[diary]' 之后到字符串末尾的所有内容
                    diaryContent = conversation.substring(lenientDiaryStartIndex + '[diary]'.length).trim();
                    // 将原始对话内容截断到日记开始之前
                    conversation = conversation.substring(0, lenientDiaryStartIndex).trim();
                }
            }

            // 如果通过任何一种方式找到了日记内容，就保存它
            if (diaryContent) {
                if (!contact.diary) contact.diary = [];
                contact.diary.push({
                    id: `diary_${Date.now()}`,
                    content: diaryContent,
                    timestamp: Date.now()
                });
                await kokoMemory.put('contacts', contact);
            }
            // ======================= 【修复结束】 =======================

            if (state.activeCall && state.activeCall.contactId === contact.id) {
                await createAndAddMessage({
                    type: 'video_call_text',
                    content: conversation // <--- 注意：这里使用 conversation
                }, 'contact');

                const narrativeFeed = document.getElementById('narrative-feed');
                const actionRegex = /\[action:(.*?)\]/g;
                let narrativeText = conversation; // <--- 注意：这里使用 conversation
                
                const match = actionRegex.exec(conversation); // <--- 注意：这里使用 conversation
                if (match) {
                    const action = match[1].trim();
                    switch(action) {
                        case 'hang_up':
                            narrativeText = conversation.replace(actionRegex, '').trim(); // <--- 注意：这里使用 conversation
                            if(narrativeText) {
                                const bubble = document.createElement('div');
                                bubble.className = 'char-bubble';
                                bubble.innerHTML = `<p class="narrative-speech">“${narrativeText}”</p>`;
                                narrativeFeed.appendChild(bubble);
                                narrativeFeed.scrollTop = narrativeFeed.scrollHeight;
                                await sleep(1000);
                            }
                            await endVideoCall('contact', `${contact.name} 挂断了电话`);
                            return;
                    }
                }

                if (narrativeText) {
                    const bubble = document.createElement('div');
                    bubble.className = 'char-bubble';
                    const regex = /(\*[^*]+\*)|(\{[^{}]+\})|(“[^”]+”)/g;
                    const parts = narrativeText.split(regex).filter(Boolean);
                    
                    parts.forEach(part => {
                        part = part.trim();
                        if (!part) return;
                        const p = document.createElement('p');
                        if (part.startsWith('*')) { p.className = 'narrative-action'; p.textContent = part; } 
                        else if (part.startsWith('{')) { p.className = 'narrative-psychology'; p.textContent = part; } 
                        else if (part.startsWith('“')) { p.className = 'narrative-speech'; p.textContent = part; } 
                        else { p.className = 'narrative-speech'; p.textContent = `“${part}”`; }
                        bubble.appendChild(p);
                    });
                    narrativeFeed.appendChild(bubble);
                    narrativeFeed.scrollTop = narrativeFeed.scrollHeight;
                }
                return; 
            }

            const lastUnopenedMessage = contact.history.slice().reverse().find(m =>
                m.sender === 'user' && (
                    (m.type === 'red_packet' && !m.content.opened) ||
                    (m.type === 'transfer' && !m.content.completed)
                )
            );

            if (lastUnopenedMessage) {
                const rejectionKeywords = ['不收', '不要', '退回', '还给你', '我不能要', '心意领了'];
                const acceptanceKeywords = ['收下', '收了', '领了', '打开', '谢谢', '我收', '我领'];
                const rejected = rejectionKeywords.some(keyword => conversation.includes(keyword)); // <--- 注意：这里使用 conversation
                
                if (rejected) {
                    if (lastUnopenedMessage.type === 'transfer') {
                        lastUnopenedMessage.content.completed = true;
                        lastUnopenedMessage.content.returned = true;
                        
                        const transferAmount = parseFloat(lastUnopenedMessage.content.amount);
                        if (!isNaN(transferAmount)) {
                            state.myProfile.balance += transferAmount;
                            await addTransaction('income', transferAmount, `来自 ${contact.name} 的转账退款`, contact.id);
                            renderMyProfile();
                            await kokoMemory.put('myProfile', state.myProfile);
                        }
                        await createSystemNotification(`${contact.name} 退还了你的转账`);
                    }
                } else {
                    const accepted = acceptanceKeywords.some(keyword => conversation.includes(keyword)); // <--- 注意：这里使用 conversation
                    if (accepted) {
                        let classToAdd = '';
                        if (lastUnopenedMessage.type === 'red_packet') {
                            lastUnopenedMessage.content.opened = true;
                            classToAdd = 'opened';
                        } else if (lastUnopenedMessage.type === 'transfer') {
                            lastUnopenedMessage.content.completed = true;
                            lastUnopenedMessage.content.returned = false;
                            classToAdd = 'completed';
                        }
                        
                        const messageWrapperEl = document.querySelector(`.message-wrapper[data-message-id='${lastUnopenedMessage.id}']`);
                        if (messageWrapperEl) {
                            const innerMessageEl = messageWrapperEl.querySelector('.message.red-packet, .message.transfer');
                            if (innerMessageEl) {
                                innerMessageEl.classList.add(classToAdd);
                                if (lastUnopenedMessage.type === 'red_packet') {
                                    const headerEl = innerMessageEl.querySelector('.red-packet-header');
                                    if (headerEl) {
                                        headerEl.innerHTML = `<div class="red-packet-icon">🧧</div><div class="red-packet-status">红包已被领取</div>`;
                                    }
                                }
                            }
                        }
                    }
                }
                await kokoMemory.put('contacts', contact);
                await sleep(100);
                await openChat(contact.id);
            }

            if (contact.isNarrativeMode) {
                if (conversation) {
                    await sleep(400 + Math.random() * 400); 
                    await createAndAddMessage({ type: 'text', content: conversation }, 'contact');
                }
            } else {
                const messages = conversation.split('\n').filter(line => line.trim() !== '');
                for (const line of messages) {
                // ========================= 【新增】HTML优先处理逻辑 =========================
                // 首先检查这条消息是不是HTML，如果是，就直接作为HTML消息处理，并跳过后面的所有检查。
                const trimmedLineForHtmlCheck = line.trim();
                if (trimmedLineForHtmlCheck.startsWith('<') && trimmedLineForHtmlCheck.endsWith('>')) {
                    await createAndAddMessage({ type: 'html', content: line }, 'contact');
                    continue; // 跳过本次循环的剩余部分，直接进入下一行消息的处理
                }
                // ========================= 【新增逻辑结束】 =========================


                // ========================= 【智能纠错机制】 =========================
                const jumpTheGunRegex = /^(喂|嘿|hello|哈[喽囉])(？|，|,|\.|...)?.*(听得见|听见|在吗)/i;
                if (!state.activeCall && jumpTheGunRegex.test(line)) {
                    console.warn("AI attempted to jump into a call. Intercepting and correcting flow.");
                    handleIncomingCall(contact);
                    break; 
                }
                
                const finalCallTriggerRegex = /(?=.*(电话|電話|视频|視頻|手机|手機|通话|通話|来电|來電))(?=.*(打|拨|撥|呼叫|接|来|來|到|马上|馬上|這就|准备|準備))|\[action:start_video_call\]|\[incoming_call:.*?\]/i;
                if (finalCallTriggerRegex.test(line)) {
                    handleIncomingCall(contact);
                    break; 
                }
                
                if (/^\[SYSTEM[:：]/.test(line.trim())) {
                    continue; 
                }
                let processed = false;
                const commandRegex = /\[(sticker|voice|picture|red_packet|transfer|music|spin_wheel):([\s\S]*)\]/;
                const commandMatch = line.match(commandRegex);
                const lastWheelMsg = [...contact.history].reverse().find(m => m.type === 'game_wheel' && !m.content.results.contact);
                if (lastWheelMsg) {
                    const contactName = contact.name;
                    const validOptions = lastWheelMsg.content.options.map(opt => opt.text);
                    const ultimatePositionalRegex = new RegExp(`(?:${contactName}|我).*?(?:[“"'])?(${validOptions.join('|')})(?:[“"'])?`);
                    const fallbackMatch = line.match(ultimatePositionalRegex);

                    if (fallbackMatch) {
                        const result = fallbackMatch[1];
                        const wheel = lastWheelMsg.content;
                        wheel.results.contact = result.trim();
                        await kokoMemory.put('contacts', contact);

                        const msgIdToUpdate = lastWheelMsg.id;
                        const wrapperToUpdate = document.querySelector(`.message-wrapper[data-message-id='${msgIdToUpdate}']`);
                        if(wrapperToUpdate) {
                            const contactResultRow = wrapperToUpdate.querySelectorAll('.wheel-result-row')[1];
                            if(contactResultRow) {
                                contactResultRow.innerHTML = `<span class="wheel-player-name">${contact.name}</span> <div class="wheel-player-result">${result.trim()}</div>`;
                            }
                        }
                        continue; 
                    }
                }

                if (commandMatch) {
                    processed = true;
                    const command = commandMatch[1];
                    const value = commandMatch[2];
                    switch (command) {
                        case 'spin_wheel': {
                            const currentWheelMsg = [...contact.history].reverse().find(m => m.type === 'game_wheel' && !m.content.results.contact);
                            if (currentWheelMsg) {
                                const wheel = currentWheelMsg.content;
                                const weightedOptions = wheel.options.flatMap(opt => Array(opt.weight).fill(opt.text));
                                const result = weightedOptions[Math.floor(Math.random() * weightedOptions.length)];
                                wheel.results.contact = result;
                                await kokoMemory.put('contacts', contact);
                                const msgIdToUpdate = currentWheelMsg.id;
                                const wrapperToUpdate = document.querySelector(`.message-wrapper[data-message-id='${msgIdToUpdate}']`);
                                if(wrapperToUpdate) {
                                    const contactResultRow = wrapperToUpdate.querySelectorAll('.wheel-result-row')[1];
                                    if(contactResultRow) {
                                        contactResultRow.innerHTML = `<span class="wheel-player-name">${contact.name}</span> <div class="wheel-player-result">${result}</div>`;
                                    }
                                }
                            }
                            break;
                        }
                        case 'sticker':
                            const emoticon = state.emoticons.find(e => e.name === value.trim());
                            if (emoticon) {
                                await createAndAddMessage({ type: 'image', url: emoticon.url, isEmoticon: true, emoticonName: emoticon.name }, 'contact');
                            } else {
                                await createAndAddMessage({ type: 'text', content: `[发送表情失败: ${value}]` }, 'contact');
                            }
                            break;
                        case 'voice':
                            const duration = Math.max(1, Math.round(value.length / 4));
                            await createAndAddMessage({ type: 'voice', content: { text: value, duration: duration } }, 'contact');
                            break;
                        case 'picture':
                            await createAndAddMessage({ type: 'picture_description', content: { description: value } }, 'contact');
                            break;
                        case 'red_packet': {
                            const parts = value.split(/[，,]/);
                            const blessing = parts[0] ? parts[0].trim() : "恭喜发财！";
                            const amount = parseFloat(parts[1]) || 0;
                            if (amount > 0) {
                                await createAndAddMessage({ type: 'red_packet', content: { amount: amount.toFixed(2), blessing: blessing, opened: false } }, 'contact');
                            }
                            break;
                        }
                        case 'transfer': {
                            const transferAmount = parseFloat(value);
                            if (transferAmount > 0) {
                                 await createAndAddMessage({ type: 'transfer', content: { amount: transferAmount.toFixed(2), completed: false, returned: false } }, 'contact');
                            }
                            break;
                        }
                        case 'music': {
                            const lastComma = value.lastIndexOf('，') > -1 ? '，' : ',';
                            const lastCommaIndex = value.lastIndexOf(lastComma);
                            if (lastCommaIndex === -1) break; 
                            const url = value.substring(lastCommaIndex + 1).trim();

                            const secondToLastCommaIndex = value.lastIndexOf(lastComma, lastCommaIndex - 1);
                            if (secondToLastCommaIndex === -1) break;
                            
                            const artist = value.substring(secondToLastCommaIndex + 1, lastCommaIndex).trim();
                            const title = value.substring(0, secondToLastCommaIndex).trim();

                            if (url.startsWith('http') && title) {
                                await createAndAddMessage({ 
                                    type: 'music_share', 
                                    content: { title, artist, url }
                                }, 'contact');
                            }
                            break;
                        }
                    }
                }

                // 因为HTML已被处理，这里的逻辑简化了
                if (!processed) {
                    await createAndAddMessage({ type: 'text', content: line }, 'contact');
                }
                await sleep(400 + Math.random() * 400);
            }
            }
        }

        async function renderPostDetail() {
            const post = state.posts.find(p => p.id === state.activePostId);
            if (!post) {
                showFeedScreen();
                return;
            }
            const container = document.getElementById('post-detail-container');
            const commentsList = document.getElementById('comments-list');
            container.innerHTML = '';
            commentsList.innerHTML = '';

            const postItemEl = createPostItem(post, true); 
            if (postItemEl) {
                container.appendChild(postItemEl);
                container.querySelector('.like-btn')?.addEventListener('click', toggleLike);
                container.querySelector('.post-delete-btn')?.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const postId = e.currentTarget.dataset.postId;
                    if(confirm('确定要删除这条动态吗？')) {
                        state.posts = state.posts.filter(p => p.id !== postId);
                        await kokoMemory.delete('posts', postId);
                        await showFeedScreen();
                    }
                });
                postItemEl.addEventListener('click', (e) => {
                    if (!e.target.closest('.post-action-btn, .mention, .post-delete-btn')) {
                         document.getElementById('comment-input').focus();
                    }
                });
            }
            
            if (post.comments.length > 0) {
                const sortedComments = [...post.comments].sort((a,b) => a.timestamp - b.timestamp);
                sortedComments.forEach(comment => {
                    const author = comment.author;
                    if (!author) return;

                    const commentEl = document.createElement('div');
                    commentEl.className = 'post-comment-item';
                    commentEl.dataset.authorName = author.name; 
                    commentEl.dataset.authorId = author.id;
                    
                    commentEl.innerHTML = `
                        <div style="display: flex; gap: 10px;">
                            <img src="${author.avatar}" style="width: 35px; height: 35px; border-radius: 50%;">
                            <div style="flex-grow: 1;">
                                <div>
                                    <span class="comment-author">${author.name}</span>
                                    ${comment.replyTo ? `<span class="comment-reply-to">回复 @${comment.replyTo}</span>` : ''}
                                </div>
                                <div class="comment-content">${parseMentions(comment.content)}</div>
                                <div class="comment-meta">
                                    <span>${formatTimeAgo(comment.timestamp)}</span>
                                    <span class="comment-delete-btn" data-comment-id="${comment.id}"><i class="fas fa-trash-alt"></i> 删除</span>
                                </div>
                            </div>
                        </div>
                    `;

                    commentsList.appendChild(commentEl);
                });
            } else {
                commentsList.innerHTML = `<div style="text-align: center; color: #999; padding: 20px;">还没有评论，快来抢沙发吧！</div>`;
            }
        }
        function triggerPetAnimation(animationType) {
            const petElements = document.querySelectorAll('.slime');
            petElements.forEach(slimeEl => {
                if (animationType === 'jiggle') {
                    slimeEl.classList.add('happy-jiggle');
                    setTimeout(() => slimeEl.classList.remove('happy-jiggle'), 500);
                }
                if (animationType === 'blush') {
                    slimeEl.classList.add('is-blushing');
                    setTimeout(() => slimeEl.classList.remove('is-blushing'), 2000);
                }
            });
        }
        // --- 新增：显示和取消回复预览的函数 ---
function showReplyPreview(message) {
    const previewBar = document.getElementById('reply-preview-bar');
    const senderName = message.sender === 'user' ? state.myProfile.name : state.contacts.find(c => c.id === state.activeChatId).name;
    
    previewBar.innerHTML = `
        <div id="reply-preview-content">
            回复 <span class="sender">${senderName}</span>: ${message.content}
        </div>
        <div id="cancel-reply-btn">&times;</div>
    `;
    previewBar.style.display = 'flex';

    document.getElementById('cancel-reply-btn').addEventListener('click', cancelReply, { once: true });
}

function cancelReply() {
    activeReplyTarget = null;
    const previewBar = document.getElementById('reply-preview-bar');
    previewBar.style.display = 'none';
    previewBar.innerHTML = '';
}
// ==========================================================
// V17.0 新增：视频通话核心管理函数 (已整合我们的优化方案)
// ==========================================================
async function startVideoCall(contactId, initiatedBy = 'user') {
    if (state.activeCall) return; 
    const contact = state.contacts.find(c => c.id === contactId);
    if (!contact) return;

    if (initiatedBy === 'user') {
        const decisionPrompt = `[SYSTEM: 用户正在向你发起视频通话请求。根据你们最近的对话和你当前的心情，请用一个词决定是否接听：“接听”或“拒绝”。\n\n- 如果你现在很忙、生气或不想说话，就回复“拒绝”。\n- 否则，回复“接听”。\n\n不要添加任何其他文字，只回复这两个词中的一个。]`;
        const decision = await generateAiResponse(contact, contact.history, decisionPrompt);
        if (decision.includes('拒绝')) {
            await createAndAddMessage({ type: 'system_notification', sender: 'system', content: `${contact.name} 现在不想接电话` });
            await requestAiReply(`[SYSTEM: 你刚刚拒绝了用户的视频通话请求，请发送一条简短的文字消息向用户解释原因（例如：在忙、心情不好等）。]`);
            return;
        }
    }
    
    state.activeCall = {
        contactId: contact.id,
        startTime: Date.now(),
        isCharCameraOff: false,
        initiatedBy: initiatedBy // 记录发起者
    };

    const videoScreen = document.getElementById('video-call-screen');
    document.getElementById('call-contact-name').textContent = contact.name;
    document.getElementById('narrative-feed').innerHTML = '<p class="narrative-action">*正在接通...*</p>';
    videoScreen.style.display = 'flex';
    
    // 永久记录通话开始事件
    const startMessage = initiatedBy === 'user' ? `你向 ${contact.name} 发起了视频通话` : `${contact.name} 向你发起了视频通话`;
    await createAndAddMessage({ type: 'system_notification', sender: 'system', content: startMessage });

    if (callTimerInterval) clearInterval(callTimerInterval);
    callTimerInterval = setInterval(updateCallUI, 1000);
    updateCallUI();

    // 如果是用户发起的，让AI先开口
    if (initiatedBy === 'user') {
        await requestAiReply(`[SYSTEM: 视频通话已接通。你必须主动说第一句话来打破沉默，可以是一句问候，或者描述你看到的场景。例如：“喂？听得到吗？我看到你啦！”]`);
    }
}

async function endVideoCall(endedBy = 'user', reason = '通话已挂断') {
    if (!state.activeCall) return;

    const duration = Math.floor((Date.now() - state.activeCall.startTime) / 1000);
    const contactId = state.activeCall.contactId;
    
    // 关键：立刻清除通话状态，中断后续的通话模式API请求
    state.activeCall = null;
    
    clearInterval(callTimerInterval);
    callTimerInterval = null;
    
    document.getElementById('video-call-screen').style.display = 'none';
    state.activeChatId = contactId;

    // 永久记录通话结束事件
    const durationMinutes = Math.floor(duration / 60);
    const durationSeconds = duration % 60;
    const durationText = `通话时长 ${durationMinutes}分${durationSeconds}秒`;
    await createAndAddMessage({ type: 'system_notification', sender: 'system', content: `${reason}，${durationText}` });
    
    // 伪造一条只有AI能看到的“状态重置”消息，强力清除它的模式惯性
    await createAndAddMessage({ type: 'text', content: '[SYSTEM: 通话已正式结束，立刻恢复标准聊天模式。]' }, 'system_instruction');

    // 如果是用户挂断，再请求AI的最后道别
    if (endedBy === 'user') {
        //await requestAiReply(`[SYSTEM: 用户刚刚挂断了视频通话。请你对此发表一句简短的感想或道别。]`);
    }
}

function updateCallUI() {
    if (!state.activeCall) return;
    const duration = Math.floor((Date.now() - state.activeCall.startTime) / 1000);
    const min = Math.floor(duration / 60).toString().padStart(2, '0');
    const sec = (duration % 60).toString().padStart(2, '0');
    const timeString = `${min}:${sec}`;
    document.getElementById('call-status').textContent = `通话中 ${timeString}`;
}

function handleIncomingCall(contact) {
    if (state.activeCall) return;
    const screen = document.getElementById('incoming-call-screen');
    document.getElementById('incoming-caller-avatar').src = contact.avatar;
    document.getElementById('incoming-caller-name').textContent = contact.name;
    screen.style.display = 'flex';

    // 使用克隆节点的方式，防止重复绑定事件
    const oldAcceptBtn = document.getElementById('accept-call-btn');
    const newAcceptBtn = oldAcceptBtn.cloneNode(true);
    oldAcceptBtn.parentNode.replaceChild(newAcceptBtn, oldAcceptBtn);
    newAcceptBtn.addEventListener('click', () => {
        screen.style.display = 'none';
        startVideoCall(contact.id, 'contact');
    });

    const oldDeclineBtn = document.getElementById('decline-call-btn');
    const newDeclineBtn = oldDeclineBtn.cloneNode(true);
    oldDeclineBtn.parentNode.replaceChild(newDeclineBtn, oldDeclineBtn);
    newDeclineBtn.addEventListener('click', async () => {
        screen.style.display = 'none';
        await createAndAddMessage({ type: 'system_notification', sender: 'system', content: `你拒接了 ${contact.name} 的视频通话` });
        await requestAiReply(`[SYSTEM: 用户刚刚拒接了你的视频通话请求。你可能会感到失落或好奇，请发送一条文字消息询问原因。]`);
    });
}

async function sendVideoCallMessage() {
    if (!state.activeCall) return;
    const input = document.getElementById('video-call-input');
    const content = input.value.trim();
    if (!content) return;

    await createAndAddMessage({ type: 'video_call_text', content: content }, 'user');

    const narrativeFeed = document.getElementById('narrative-feed');
    narrativeFeed.innerHTML += `<div class="user-message"><p>${content}</p></div>`;
    narrativeFeed.scrollTop = narrativeFeed.scrollHeight;
    input.value = '';
    
    await requestAiReply(); 
}
        
        // --- 新增：处理消息编辑的核心函数（无痕版） ---
async function handleEditMessage(messageId) {
    const contact = state.contacts.find(c => c.id === state.activeChatId);
    if (!contact) return;

    const message = contact.history.find(m => m.id === messageId);
    if (!message) return;

    // 使用您已有的自定义弹窗来获取新内容
    const newContent = await showCustomPrompt('编辑消息', message.content);

    // 如果用户点击了 "确定" 并且内容有变化
    if (newContent !== null && newContent.trim() !== message.content) {
        // 直接更新消息内容
        message.content = newContent.trim();
        // 这里我们不添加任何 'edited' 标记，实现无痕修改

        // 将修改保存到数据库
        await kokoMemory.put('contacts', contact);
        
        // 重新渲染聊天界面以显示更新
        await openChat(state.activeChatId);
    }
}

        async function initApp() {
            await kokoMemory.init();
            await loadDataFromDB();
            await loadAppearanceSettings();
            await renderMyProfile(); 
            await renderContacts(); 
            await renderWorldBooks(); 
            await updateWorldBookSelectors(); 
            await renderUserPersonaPresets();
            await renderThoughtPresets();
            updateNotificationDots();
            renderAttachmentMenu();
            if (state.posts.length === 0 && isInitialPostLoad) {
                await showFeedScreen();
            }
            await showMainScreen();
        }

        function renderPet(contact) {
            const container = document.getElementById('pet-container-wrapper');
            if (!contact) {
                container.innerHTML = '';
                return;
            }

            if (!contact.pet) {
                container.innerHTML = `
                    <div id="pet-container">
                        <div class="pet-header" style="justify-content:center;">我们的小窝</div>
                        <button class="form-button" id="adopt-pet-btn">领养一只史莱姆</button>
                    </div>`;
                return;
            }
            
            const now = Date.now();
            const elapsedHours = (now - contact.pet.lastUpdated) / (1000 * 60 * 60);
            const decayAmount = Math.floor(elapsedHours * 5); 
            
            if (decayAmount > 0) {
                contact.pet.hunger = Math.max(0, contact.pet.hunger - decayAmount);
                contact.pet.happiness = Math.max(0, contact.pet.happiness - decayAmount);
                contact.pet.cleanliness = Math.max(0, contact.pet.cleanliness - decayAmount);
                contact.pet.lastUpdated = now;
                kokoMemory.put('contacts', contact);
            }

            let isWorking = false;
            let workCooldownText = '';
            if (contact.pet.workFinishTimestamp && now < contact.pet.workFinishTimestamp) {
                isWorking = true;
                const remainingMinutes = Math.ceil((contact.pet.workFinishTimestamp - now) / (1000 * 60));
                workCooldownText = `工作中... (剩余${remainingMinutes}分钟)`;
            }

            container.innerHTML = `
                <div id="pet-container">
                    <div class="pet-header">
                        <span id="pet-name">${contact.pet.name} (LV.${contact.pet.level})</span>
                        <span id="pet-gold-display">💰 ${contact.gold_coins}</span>
                    </div>
                    <div class="pet-visual-area">
                        <div>
                            <div class="slime">
                                <div class="blush left"></div>
                                <div class="blush right"></div>
                            </div>
                            <div class="slime-shadow"></div>
                        </div>
                    </div>
                    <div class="pet-stats">
                        <div class="stat-bar-container" title="经验值: ${contact.pet.xp} / 100">
                            <span class="stat-bar-label">成长</span>
                            <div class="stat-bar"><div id="xp-bar" class="stat-bar-inner" style="background-color: #ffcc80;"></div></div>
                        </div>
                        <div class="stat-bar-container">
                            <span class="stat-bar-label">饱食度</span>
                            <div class="stat-bar"><div id="hunger-bar" class="stat-bar-inner"></div></div>
                        </div>
                        <div class="stat-bar-container">
                            <span class="stat-bar-label">开心值</span>
                            <div class="stat-bar"><div id="happiness-bar" class="stat-bar-inner"></div></div>
                        </div>
                         <div class="stat-bar-container">
                            <span class="stat-bar-label">清洁度</span>
                            <div class="stat-bar"><div id="cleanliness-bar" class="stat-bar-inner"></div></div>
                        </div>
                    </div>
                    <div class="pet-actions">
                        <button id="feed-pet-btn" class="pet-action-btn" ${isWorking ? 'disabled' : ''}>喂食 (-5💰)</button>
                        <button id="play-pet-btn" class="pet-action-btn" ${isWorking ? 'disabled' : ''}>玩耍</button>
                        <button id="clean-pet-btn" class="pet-action-btn" ${isWorking ? 'disabled' : ''}>清洁</button>
                        <button id="work-pet-btn" class="pet-action-btn" ${isWorking ? 'disabled' : ''}>${isWorking ? workCooldownText : '打工 (1小时)'}</button>
                    </div>
                </div>`;
            
            document.getElementById('xp-bar').style.width = `${contact.pet.xp}%`;
            document.getElementById('hunger-bar').style.width = `${contact.pet.hunger}%`;
            document.getElementById('happiness-bar').style.width = `${contact.pet.happiness}%`;
            document.getElementById('cleanliness-bar').style.width = `${contact.pet.cleanliness}%`;

            const slimeEl = container.querySelector('.slime');
            slimeEl.className = 'slime'; 
            if (contact.pet.form) {
                slimeEl.classList.add(`${contact.pet.form}-form`);
            }
            if (contact.pet.hunger < 40) slimeEl.classList.add('hungry');
            if (contact.pet.cleanliness < 40) slimeEl.classList.add('dirty');
        }

        function updateChatPetVisuals(contact) {
            const chatPetEl = document.querySelector('#chat-pet-container .slime');
            if (!chatPetEl || !contact || !contact.pet) return;
            
            chatPetEl.className = 'slime'; 
            if (contact.pet.form) {
                chatPetEl.classList.add(`${contact.pet.form}-form`);
            }
            if (contact.pet.hunger < 40) chatPetEl.classList.add('hungry');
            if (contact.pet.cleanliness < 40) chatPetEl.classList.add('dirty');
        }


        async function updatePetStats(stat, value, contact, isCharAction = false) {
            if (!contact || !contact.pet) return;
            contact.pet[stat] = Math.min(100, Math.max(0, contact.pet[stat] + value));
            if (!isCharAction) {
                contact.pet.lastUpdated = Date.now();
            }
            await kokoMemory.put('contacts', contact);
        }

        function findMentionsInComment(comment) {
            const mentionedContacts = new Set();
            if (!comment || !comment.content) return [];
            
            const mentionRegex = /@([\w\u4e00-\u9fa5]+)/g;
            let match;

            while ((match = mentionRegex.exec(comment.content)) !== null) {
                const username = match[1];
                const contact = state.contacts.find(c => c.name === username);
                if (contact) {
                    mentionedContacts.add(contact);
                }
            }
            return Array.from(mentionedContacts);
        }
        
        function handleAvatarUpload(callback) {
            const uploader = document.getElementById('avatar-uploader');
            uploader.click();

            uploader.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                if (file.size > 2 * 1024 * 1024) {
                    alert('图片太大了！请选择一张小于 2MB 的图片。');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(event) {
                    const base64String = event.target.result;
                    callback(base64String);
                };
                
                reader.readAsDataURL(file);
                e.target.value = ''; 
            };
        }
        
        // --- NEW: V7.0 开始/停止听歌计时器 ---
        function startListenTimeTracker() {
            if (listenTimeInterval) clearInterval(listenTimeInterval); // 清除旧的计时器
            
            listenTimeInterval = setInterval(async () => {
                const contact = state.contacts.find(c => c.id === state.activeChatId);
                if (contact && !globalAudioPlayer.paused) {
                    contact.totalListenTime += 1; // 每秒加1
                    // 为避免频繁写数据库，可以设计成每10秒或30秒保存一次
                    if (contact.totalListenTime % 10 === 0) {
                        await kokoMemory.put('contacts', contact);
                    }
                }
            }, 1000);
        }

        async function stopListenTimeTracker() {
            clearInterval(listenTimeInterval);
            listenTimeInterval = null;
            // 停止时，确保最后的数据被保存
            const contact = state.contacts.find(c => c.id === state.activeChatId);
            if(contact) {
                await kokoMemory.put('contacts', contact);
            }
        }

// ==========================================================
// =========== ▼▼▼ 全新：自由外观设置功能逻辑 ▼▼▼ ==========
// ==========================================================

let userSettings = {
    id: 'main',
    chatBackground: null, // 存储背景图的Base64数据
    customBubbleCss: '',  // 存储用户输入的气泡CSS
    customFontUrl: '',    // 存储用户输入的字体URL
    customFontName: ''    // 存储用户为字体起的名字
};

// 函数：动态更新自定义字体
function updateCustomFont(fontUrl, fontName) {
    let styleTag = document.getElementById('custom-font-style');
    if (!styleTag) {
        styleTag = document.createElement('style');
        styleTag.id = 'custom-font-style';
        document.head.appendChild(styleTag);
    }

    if (fontUrl && fontName) {
        // 创建 @font-face 规则来加载外部字体，并应用它
        const fontFaceRule = `
            @font-face {
                font-family: '${fontName}';
                src: url('${fontUrl}');
            }
        `;
        // 更新 --main-font 变量
        document.documentElement.style.setProperty('--main-font', `'${fontName}', 'Nunito', sans-serif`);
        styleTag.textContent = fontFaceRule;
    } else {
        // 如果URL或名称为空，则恢复默认字体并清空style标签
        document.documentElement.style.setProperty('--main-font', `'Nunito', sans-serif`);
        styleTag.textContent = '';
    }
}

// 函数：动态更新自定义气泡CSS
function updateCustomBubbles(cssString) {
    let styleTag = document.getElementById('custom-bubble-style');
    if (!styleTag) {
        styleTag = document.createElement('style');
        styleTag.id = 'custom-bubble-style';
        document.head.appendChild(styleTag);
    }
    styleTag.textContent = cssString || ''; // 如果CSS字符串为空，则清空样式
}


// 函数：应用所有保存的设置
function applyAppearanceSettings() {
    // 1. 应用背景
    const chatScreen = document.getElementById('chat-screen');
    if (userSettings.chatBackground) {
        chatScreen.style.backgroundImage = `url(${userSettings.chatBackground})`;
    } else {
        // 恢复到CSS文件中的默认样式
        chatScreen.style.backgroundImage = ''; 
    }

    // 2. 应用自定义气泡样式
    updateCustomBubbles(userSettings.customBubbleCss);
    
    // 3. 应用自定义字体
    updateCustomFont(userSettings.customFontUrl, userSettings.customFontName);
}

// 函数：从数据库加载设置
async function loadAppearanceSettings() {
    const savedSettings = await kokoMemory.get('userSettings', 'main');
    if (savedSettings) {
        userSettings = { ...userSettings, ...savedSettings }; // 合并，以防未来增加新字段
    }
    applyAppearanceSettings();
}

// 函数：保存当前设置到数据库
async function saveAppearanceSettings() {
    // 从UI控件读取当前用户的输入
    userSettings.customBubbleCss = document.getElementById('bubble-css-input').value.trim();
    userSettings.customFontUrl = document.getElementById('font-url-input').value.trim();
    userSettings.customFontName = document.getElementById('font-name-input').value.trim().replace(/[^a-zA-Z0-9]/g, ''); // 只保留字母和数字作为字体名
    
    // 背景图在上传时已实时保存到 userSettings.chatBackground
    
    if (userSettings.customFontUrl && !userSettings.customFontName) {
        alert("请输入一个CSS字体名称！");
        return;
    }
    
    await kokoMemory.put('userSettings', userSettings);
    alert('外观设置已应用并保存！');
    applyAppearanceSettings(); // 再次应用以确保所有更改都生效
}
// 请将下面这个完整的函数，粘贴到刚才删除代码的位置
function attachEventListeners() {
    // ==========================================================
    // V9.0 新增：悬浮播放器拖动逻辑 (支持鼠标和触摸)
    // ==========================================================
    const card = document.getElementById('music-player-card');
    const header = document.getElementById('player-header');
    let isDragging = false,
        cardX = 50,
        cardY = 50,
        dragStartX = 0,
        dragStartY = 0;
    card.style.left = `${cardX}px`;
    card.style.top = `${cardY}px`;

    function dragStart(e) {
        isDragging = true;
        const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
        const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
        dragStartX = clientX;
        dragStartY = clientY;
        card.style.transition = 'none';
    }

    function dragMove(e) {
        if (isDragging) {
            if (e.type === 'touchmove') e.preventDefault();
            const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
            const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
            const deltaX = clientX - dragStartX;
            const deltaY = clientY - dragStartY;
            card.style.left = `${cardX + deltaX}px`;
            card.style.top = `${cardY + deltaY}px`;
        }
    }

    function dragEnd(e) {
        if (isDragging) {
            isDragging = false;
            const clientX = e.type === 'touchend' ? e.changedTouches[0].clientX : e.clientX;
            const clientY = e.type === 'touchend' ? e.changedTouches[0].clientY : e.clientY;
            cardX += (clientX - dragStartX);
            cardY += (clientY - dragStartY);
            card.style.transition = 'all 0.4s ease-in-out';
        }
    }
    header.addEventListener('mousedown', dragStart);
    document.addEventListener('mousemove', dragMove);
    document.addEventListener('mouseup', dragEnd);
    header.addEventListener('touchstart', dragStart);
    document.addEventListener('touchmove', dragMove, {
        passive: false
    });
    document.addEventListener('touchend', dragEnd);

    let currentlyPlayingMsgId = null;

    // --- 原有功能：数据导入导出 ---
    document.getElementById('export-data-btn').addEventListener('click', exportData);
    document.getElementById('import-data-btn').addEventListener('click', () => {
        document.getElementById('import-file-input').click();
    });
    document.getElementById('import-file-input').addEventListener('change', importData);

    // --- 原有功能：头像更换 ---
    document.getElementById('change-avatar-btn').addEventListener('click', function() {
        handleAvatarUpload(async (base64String) => {
            state.myProfile.avatar = base64String;
            await kokoMemory.put('myProfile', state.myProfile);
            renderMyProfile();
        });
    });
    document.getElementById('change-char-avatar-btn').addEventListener('click', () => {
        const contact = state.contacts.find(c => c.id === state.activeChatId);
        if (!contact) return;
        handleAvatarUpload(async (base64String) => {
            contact.avatar = base64String;
            await kokoMemory.put('contacts', contact);
            showCharProfileScreen();
            renderContacts();
        });
    });

    // --- 原有功能：底部导航栏 ---
    document.querySelectorAll('#nav-chat, #nav-chat-2, #nav-chat-discover').forEach(el => el.addEventListener('click', showMainScreen));
    document.querySelectorAll('#nav-discover, #nav-discover-2, #nav-discover-discover').forEach(el => el.addEventListener('click', showDiscoverScreen));
    document.querySelectorAll('#nav-profile, #nav-profile-2, #nav-profile-discover').forEach(el => el.addEventListener('click', showProfileScreen));

    // --- 原有功能：发现页跳转 ---
    document.getElementById('user-persona-presets-btn').addEventListener('click', showUserPersonaManagementScreen);
    document.getElementById('emoticon-library-btn').addEventListener('click', showEmoticonLibraryScreen);
    document.getElementById('music-library-btn').addEventListener('click', showMusicLibraryScreen);
    document.getElementById('thought-presets-btn').addEventListener('click', showThoughtPresetManagementScreen);
    document.getElementById('world-book-btn').addEventListener('click', () => {
        hideAllScreens();
        document.getElementById('world-book-screen').style.display = 'flex';
        renderWorldBooks();
    });
    document.getElementById('api-settings-btn').addEventListener('click', () => {
        hideAllScreens();
        document.getElementById('api-settings-screen').style.display = 'flex';
        document.getElementById('api-key-input').value = state.apiSettings.apiKey;
        document.getElementById('api-endpoint-input').value = state.apiSettings.endpoint;
        document.getElementById('context-length-input').value = state.apiSettings.contextLength;
        document.getElementById('long-term-memory-length-input').value = state.apiSettings.longTermMemoryLength;
        updateModelDropdown([state.apiSettings.model], document.getElementById('model-select'), state.apiSettings.model);
    });
    document.getElementById('square-api-settings-btn').addEventListener('click', () => {
        hideAllScreens();
        document.getElementById('square-api-settings-screen').style.display = 'flex';
        document.getElementById('square-api-key-input').value = state.squareApiSettings.apiKey;
        document.getElementById('square-api-endpoint-input').value = state.squareApiSettings.endpoint;
        updateModelDropdown([state.squareApiSettings.model], document.getElementById('square-model-select'), state.squareApiSettings.model);
    });
    document.getElementById('moments-btn').addEventListener('click', showFeedScreen);

    // --- 原有功能：各页面返回按钮 ---
    document.getElementById('back-from-user-persona-management').addEventListener('click', showDiscoverScreen);
    document.getElementById('back-from-emoticon-library').addEventListener('click', showDiscoverScreen);
    document.getElementById('back-from-music-library').addEventListener('click', showDiscoverScreen);
    document.getElementById('back-from-thought-presets').addEventListener('click', showDiscoverScreen);
    document.getElementById('back-from-world-book').addEventListener('click', showDiscoverScreen);
    document.getElementById('back-from-api').addEventListener('click', showDiscoverScreen);
    document.getElementById('back-from-square-api').addEventListener('click', showDiscoverScreen);
    document.getElementById('back-from-chat').addEventListener('click', async () => {
        if (editModeState.active) await exitEditMode();
        document.getElementById('chat-pet-container').style.display = 'none';
        //closeMusicPlayer();//
        currentlyPlayingMsgId = null;
        await showMainScreen();
    });
    document.getElementById('back-from-contact-settings').addEventListener('click', () => {
        document.getElementById('contact-settings-screen').style.display = 'none';
        showCharProfileScreen();
    });
    document.getElementById('back-from-moments').addEventListener('click', showDiscoverScreen);
    document.getElementById('back-from-char-profile').addEventListener('click', async () => {
        const contact = state.contacts.find(c => c.id === state.activeChatId);
        if (contact && contact.isChatPetVisible && batchedPetActions.length > 0) {
            const summary = batchedPetActions.join('，');
            const systemPrompt = `[角色后台指令：用户刚刚在宠物界面进行了一系列操作：“${summary}”。你的任务是，不要逐条复述这些操作日志，而是对此事发表一句连贯、自然的口语化评论来衔接对话。例如，你可以问：“刚刚去照顾咱们的史莱姆啦？”或者说：“看你把它喂得饱饱的，真好。”]`;
            await requestAiReply(systemPrompt);
        }
        batchedPetActions = [];
        document.getElementById('char-profile-screen').style.display = 'none';
        document.getElementById('chat-screen').style.display = 'flex';
    });
    document.getElementById('back-from-diary').addEventListener('click', showCharProfileScreen);
    document.getElementById('back-from-post-detail').addEventListener('click', showFeedScreen);
    document.getElementById('back-from-trending-topic').addEventListener('click', showFeedScreen);
    // ▼▼▼ 这整段代码在新版本中都缺失了 ▼▼▼
document.getElementById('refresh-post-comments-btn').addEventListener('click', async () => {
    const post = state.posts.find(p => p.id === state.activePostId);
    if (!post) return;

    showFeedStatus('正在加载新评论...');
    try {
        await generateMoreCommentsForPost(post);
        await kokoMemory.put('posts', post);
        await renderPostDetail();

    } catch(e) {
        console.error("刷新评论失败:", e);
        alert("刷新评论失败: " + e.message);
    } finally {
        hideFeedStatus();
    }
});
    const backFromMemoryAlbumBtn = document.getElementById('back-from-memory-album');
    if (backFromMemoryAlbumBtn) {
        backFromMemoryAlbumBtn.addEventListener('click', showCharProfileScreen);
    }

    // --- 原有功能：宠物及其他聊天界面按钮 ---
    const toggleChatPetBtn = document.getElementById('toggle-chat-pet-btn');
    if (toggleChatPetBtn) {
        toggleChatPetBtn.addEventListener('click', async () => {
            const contact = state.contacts.find(c => c.id === state.activeChatId);
            if (!contact || !contact.pet) return;
            contact.isChatPetVisible = !contact.isChatPetVisible;
            const chatPetContainer = document.getElementById('chat-pet-container');
            if (contact.isChatPetVisible) {
                chatPetContainer.style.display = 'block';
                updateChatPetVisuals(contact);
            } else {
                chatPetContainer.style.display = 'none';
            }
            await kokoMemory.put('contacts', contact);
        });
    }
    document.getElementById('send-btn').addEventListener('click', sendMessage);
    document.getElementById('request-reply-btn').addEventListener('click', () => requestAiReply());
    document.getElementById('message-input').addEventListener('keypress', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    document.getElementById('contact-settings-btn').addEventListener('click', showCharProfileScreen);
    document.getElementById('delete-history-btn').addEventListener('click', () => {
        if (editModeState.active) {
            exitEditMode();
        } else {
            enterEditMode();
        }
    });
    document.getElementById('cancel-edit-btn').addEventListener('click', exitEditMode);
    document.getElementById('delete-selected-btn').addEventListener('click', async () => {
    if (editModeState.selectedMessageIds.size === 0) {
        return alert('请先选择要删除的消息。');
    }
    const confirmed = await showCustomConfirm('删除消息', `确定要删除选中的 ${editModeState.selectedMessageIds.size} 条消息吗？`, true);
    if (confirmed) {
        const contact = state.contacts.find(c => c.id === state.activeChatId);
        if (contact) {
            const createKey = (song) => `${(song.title || '').trim()}|${(song.artist || '').trim()}`;
            const librarySongKeys = new Set(state.musicLibrary.map(createKey));

            const deletedTempMusicMessages = contact.history.filter(msg =>
                editModeState.selectedMessageIds.has(msg.id) &&
                msg.type === 'music_share' &&
                !librarySongKeys.has(createKey(msg.content))
            );

            if (deletedTempMusicMessages.length > 0) {
                const deletedTempSongKeys = new Set(deletedTempMusicMessages.map(msg => createKey(msg.content)));
                const currentTrack = contact.sharedPlaylist.tracks[contact.sharedPlaylist.currentIndex];
                
                if (currentTrack && deletedTempSongKeys.has(createKey(currentTrack))) {
                    globalAudioPlayer.pause();
                    globalAudioPlayer.src = '';
                    contact.sharedPlaylist.currentIndex = 0;
                    closeMusicPlayer();
                }
            }
            
            contact.history = contact.history.filter(msg => !editModeState.selectedMessageIds.has(msg.id));
            
            await kokoMemory.put('contacts', contact);
            await renderContacts();

            const musicPlayerCard = document.getElementById('music-player-card');
            if (musicPlayerCard.style.display === 'flex' && state.musicSessionContactId === contact.id) {
                renderPlaylist();
            }
        }
        await exitEditMode();
    }
});

    // --- 原有功能：角色资料页的各种按钮 ---
    document.getElementById('char-more-info-btn').addEventListener('click', () => {
        const contact = state.contacts.find(c => c.id === state.activeChatId);
        if (!contact) return;
        document.getElementById('char-mask-textarea').value = contact.persona;
        document.getElementById('user-mask-textarea').value = contact.userPersona || '';
        const currentPersonaPreset = state.userPersonaPresets.find(p => p.description === contact.userPersona);
        document.getElementById('select-user-persona-preset').value = currentPersonaPreset ? currentPersonaPreset.id : '';
        document.getElementById('thought-preset-select').value = contact.thoughtPreset || 'deep_roleplay_regex';
        document.querySelectorAll('.world-book-checkbox').forEach(cb => {
            cb.checked = contact.worldBooks.includes(cb.value);
        });
        document.getElementById('narrative-mode-toggle').checked = contact.isNarrativeMode;
        document.getElementById('time-awareness-toggle').checked = contact.isTimeAware ?? false;
        document.getElementById('hide-avatar-toggle').checked = contact.isAvatarHidden;
        document.getElementById('char-profile-screen').style.display = 'none';
        document.getElementById('contact-settings-screen').style.display = 'flex';
    });
    document.getElementById('view-char-diary-btn').addEventListener('click', showDiaryScreen);
    // ▼▼▼ 将这段完整的代码粘贴到 attachEventListeners 函数中 ▼▼▼
document.getElementById('diary-content-list').addEventListener('click', async (e) => {
    // 检查点击的是不是删除按钮
    if (e.target.closest('.diary-delete-btn')) {
        const diaryId = e.target.closest('.diary-delete-btn').dataset.diaryId;
        const confirmed = await showCustomConfirm('删除日记', '确定要删除这条日记吗？', true);
        if (confirmed) {
            const contact = state.contacts.find(c => c.id === state.activeChatId);
            if(contact && contact.diary) {
                // 从联系人的日记数组中过滤掉要删除的条目
                contact.diary = contact.diary.filter(entry => entry.id !== diaryId);
                // 保存更改到数据库
                await kokoMemory.put('contacts', contact);
                // 重新渲染日记列表，让界面刷新
                renderDiary();
            }
        }
    }
});
    document.getElementById('delete-contact-btn').addEventListener('click', async () => {
        const contact = state.contacts.find(c => c.id === state.activeChatId);
        if (!contact) return;
        const confirmed = await showCustomConfirm('删除联系人', `⚠️ 警告：确定要永久删除联系人 "${contact.name}" 吗？\n\n此操作将删除其所有聊天记录和日记，且无法恢复！`, true);
        if (confirmed) {
            state.contacts = state.contacts.filter(c => c.id !== state.activeChatId);
            await kokoMemory.delete('contacts', state.activeChatId);
            state.activeChatId = null;
            alert(`联系人 "${contact.name}" 已被删除。`);
            await showMainScreen();
        }
    });
    document.getElementById('clear-chat-history-btn').addEventListener('click', async () => {
        const contact = state.contacts.find(c => c.id === state.activeChatId);
        if (!contact) return;
        const confirmed = await showCustomConfirm('清空记录', `确定要清空与 "${contact.name}" 的所有聊天记录吗？\n此操作不可恢复。`, true);
        if (confirmed) {
            contact.history = [];
            await kokoMemory.put('contacts', contact);
            alert('聊天记录已清空。');
            document.getElementById('contact-settings-screen').style.display = 'none';
            showCharProfileScreen();
        }
    });
    document.getElementById('char-profile-screen').addEventListener('click', async (e) => {
        const contact = state.contacts.find(c => c.id === state.activeChatId);
        if (!contact) return;
        if (e.target.id === 'adopt-pet-btn') {
            contact.pet = {
                name: '史莱姆',
                stage: 1,
                happiness: 80,
                hunger: 80,
                cleanliness: 100,
                lastUpdated: Date.now(),
                workFinishTimestamp: null,
                xp: 0,
                level: 1,
                form: 'baby'
            };
            await kokoMemory.put('contacts', contact);
            renderPet(contact);
            await requestAiReply(`[SYSTEM: 我们刚刚领养了一只宠物史莱姆！请开心地和我说这件事。]`);
        } else if (e.target.id === 'feed-pet-btn') {
            if (contact.gold_coins >= 5) {
                contact.gold_coins -= 5;
                await updatePetStats('hunger', 20, contact);
                renderPet(contact);
                batchedPetActions.push(`你喂食了它`);
                triggerPetAnimation('blush');
            } else {
                alert('金币不足！快去打工吧！');
            }
        } else if (e.target.id === 'play-pet-btn') {
            await updatePetStats('happiness', 20, contact);
            renderPet(contact);
            batchedPetActions.push(`你陪它玩耍了`);
            triggerPetAnimation('jiggle');
        } else if (e.target.id === 'clean-pet-btn') {
            await updatePetStats('cleanliness', 40, contact);
            renderPet(contact);
            batchedPetActions.push(`你帮它打扫干净了`);
        } else if (e.target.id === 'work-pet-btn') {
            contact.pet.workFinishTimestamp = Date.now() + (1000 * 60 * 60); // 1 hour
            await kokoMemory.put('contacts', contact);
            renderPet(contact);
            setTimeout(async () => {
                const currentContact = await kokoMemory.get('contacts', contact.id);
                if (currentContact && currentContact.pet) {
                    currentContact.gold_coins += 50;
                    currentContact.pet.workFinishTimestamp = null;
                    await kokoMemory.put('contacts', currentContact);
                    state.contacts = await kokoMemory.getAll('contacts');
                    await createAndAddMessage({
                        type: 'system_notification',
                        sender: 'system',
                        content: `你们的史莱姆'${currentContact.pet.name}'打工回来啦！赚了50金币！`
                    });
                    if (state.activeChatId === currentContact.id && document.getElementById('char-profile-screen').style.display === 'flex') {
                        renderPet(currentContact);
                    }
                }
            }, 1000 * 60 * 60);
        } else if (e.target.id === 'view-memory-album-btn' || e.target.closest('#view-memory-album-btn')) {
            showMemoryAlbum(contact);
        } else if (e.target.id === 'pet-name') {
            const newName = await showCustomPrompt('给你的史莱姆起一个新名字吧：', contact.pet.name);
            if (newName && newName.trim()) {
                contact.pet.name = newName.trim();
                await kokoMemory.put('contacts', contact);
                renderPet(contact);
            }
        }
    });
    document.getElementById('edit-char-name-btn').addEventListener('click', async () => {
        const contact = state.contacts.find(c => c.id === state.activeChatId);
        if (!contact) return;
        const newName = await showCustomPrompt('设置备注名', contact.name);
        if (newName !== null && newName.trim() !== '') {
            contact.name = newName.trim();
            await kokoMemory.put('contacts', contact);
            showCharProfileScreen();
            document.getElementById('chat-contact-name').textContent = contact.name;
            await renderContacts();
        }
    });
    document.getElementById('edit-char-signature-btn').addEventListener('click', async () => {
        const contact = state.contacts.find(c => c.id === state.activeChatId);
        if (!contact) return;
        const newSignature = await showCustomPrompt('设置签名', contact.signature || '');
        if (newSignature !== null) {
            contact.signature = newSignature.trim();
            await kokoMemory.put('contacts', contact);
            showCharProfileScreen();
        }
    });

    // --- 原有功能：我的资料页编辑按钮 ---
    document.querySelectorAll('.profile-details .edit-btn[data-field]').forEach(button => {
        button.addEventListener('click', async function() {
            const field = this.dataset.field;
            const currentValue = state.myProfile[field];
            const title = `修改 ${fieldNameToChinese(field)}`;
            const newValue = await showCustomPrompt(title, currentValue);
            if (newValue !== null) {
                state.myProfile[field] = newValue.trim();
                renderMyProfile();
                await kokoMemory.put('myProfile', state.myProfile);
            }
        });
    });
    document.getElementById('edit-status-btn').addEventListener('click', async () => {
        const currentStatus = state.myProfile.status;
        const newStatus = await showCustomPrompt('修改我的状态', currentStatus);
        if (newStatus !== null) {
            state.myProfile.status = newStatus.trim();
            await kokoMemory.put('myProfile', state.myProfile);
            renderMyProfile();
        }
    });
    document.getElementById('initialize-app-btn').addEventListener('click', async function() {
        const confirmed = await showCustomConfirm('初始化应用', '警告：这会清空所有保存的数据（联系人、世界书、论坛帖子、API设置等）并恢复到初始状态。确定要继续吗？', true);
        if (confirmed) {
            await kokoMemory.deleteDatabase();
            window.location.reload();
        }
    });

    // --- 原有功能：各类弹窗的逻辑 ---
    document.getElementById('add-contact-btn').addEventListener('click', () => {
        document.getElementById('add-contact-modal').style.display = 'flex';
    });
    document.getElementById('close-contact-modal').addEventListener('click', () => {
        document.getElementById('add-contact-modal').style.display = 'none';
    });
    document.getElementById('save-contact-btn').addEventListener('click', async () => {
        const name = document.getElementById('contact-name-input').value.trim();
        const persona = document.getElementById('contact-persona-input').value.trim();
        if (!name || !persona) return alert('请填写姓名和人设');
        const avatar = document.getElementById('contact-avatar-input').value.trim();
        const selectedBooks = Array.from(document.getElementById('world-book-select').selectedOptions).map(opt => opt.value);
        const newContact = {
            id: 'contact_' + Date.now(),
            name: name,
            persona: persona,
            avatar: avatar || `https://via.placeholder.com/50/${Math.floor(Math.random() * 16777215).toString(16)}/FFFFFF?text=${name.substring(0, 1).toUpperCase()}`,
            worldBooks: JSON.parse(JSON.stringify(selectedBooks)),
            history: [],
            diary: [],
            userPersona: '',
            thoughtPreset: 'deep_roleplay_regex',
            signature: '',
            isNarrativeMode: false,
            apiCallCounter: 0,
            pet: null,
            gold_coins: 50,
            memories: [],
            isChatPetVisible: false,
            sharedPlaylist: {
                tracks: [],
                currentIndex: 0,
                playbackMode: 'list',
                isPlaying: false
            },
            totalListenTime: 0,
            firstChatDate: Date.now()
        };
        state.contacts.push(newContact);
        await kokoMemory.put('contacts', newContact);
        await renderContacts();
        document.getElementById('add-contact-modal').style.display = 'none';
    });
    document.getElementById('save-contact-settings-btn').addEventListener('click', async () => {
        const contact = state.contacts.find(c => c.id === state.activeChatId);
        if (!contact) return;
        const oldNarrativeModeState = contact.isNarrativeMode;
        contact.persona = document.getElementById('char-mask-textarea').value;
        contact.userPersona = document.getElementById('user-mask-textarea').value;
        contact.thoughtPreset = document.getElementById('thought-preset-select').value;
        contact.worldBooks = Array.from(document.querySelectorAll('.world-book-checkbox:checked')).map(cb => cb.value);
        const newNarrativeModeState = document.getElementById('narrative-mode-toggle').checked;
        contact.isNarrativeMode = newNarrativeModeState;
        contact.isTimeAware = document.getElementById('time-awareness-toggle').checked;
        contact.isAvatarHidden = document.getElementById('hide-avatar-toggle').checked;
        if (oldNarrativeModeState === true && newNarrativeModeState === false) {
            contact.needsNarrativeModeExitPrompt = true;
        }
        await kokoMemory.put('contacts', contact);
        document.getElementById('contact-settings-screen').style.display = 'none';
        showCharProfileScreen();
        alert('联系人设置已保存！');
    });
    document.getElementById('select-user-persona-preset').addEventListener('change', function() {
        const selectedPresetId = this.value;
        const preset = state.userPersonaPresets.find(p => p.id === selectedPresetId);
        document.getElementById('user-mask-textarea').value = preset ? preset.description : '';
    });
    document.getElementById('fetch-models-btn').addEventListener('click', (e) => {
        const apiKey = document.getElementById('api-key-input').value;
        const endpoint = document.getElementById('api-endpoint-input').value.trim();
        fetchModels(endpoint, apiKey, document.getElementById('model-select'), e.currentTarget);
    });
    document.getElementById('fetch-square-models-btn').addEventListener('click', (e) => {
        const apiKey = document.getElementById('square-api-key-input').value;
        const endpoint = document.getElementById('square-api-endpoint-input').value.trim();
        fetchModels(endpoint, apiKey, document.getElementById('square-model-select'), e.currentTarget);
    });
    document.getElementById('save-api-settings-btn').addEventListener('click', async () => {
        state.apiSettings.apiKey = document.getElementById('api-key-input').value;
        state.apiSettings.model = document.getElementById('model-select').value;
        state.apiSettings.endpoint = document.getElementById('api-endpoint-input').value.trim();
        state.apiSettings.contextLength = parseInt(document.getElementById('context-length-input').value, 10) || 20;
        state.apiSettings.longTermMemoryLength = parseInt(document.getElementById('long-term-memory-length-input').value, 10) || 30;
        await kokoMemory.put('apiSettings', {
            id: 'main',
            ...state.apiSettings
        });
        alert('聊天API设置已保存！');
        showDiscoverScreen();
    });
    document.getElementById('save-square-api-settings-btn').addEventListener('click', async () => {
        state.squareApiSettings.apiKey = document.getElementById('square-api-key-input').value;
        state.squareApiSettings.model = document.getElementById('square-model-select').value;
        state.squareApiSettings.endpoint = document.getElementById('square-api-endpoint-input').value.trim();
        await kokoMemory.put('squareApiSettings', {
            id: 'main',
            ...state.squareApiSettings
        });
        alert('论坛API设置已保存！');
        showDiscoverScreen();
    });
    document.getElementById('add-world-book-btn').addEventListener('click', () => {
        editingBookId = null;
        document.getElementById('world-book-modal-title').textContent = '添加世界书';
        document.getElementById('book-name-input').value = '';
        document.getElementById('book-content-input').value = '';
        document.getElementById('add-world-book-modal').style.display = 'flex';
    });
    document.getElementById('close-world-book-modal').addEventListener('click', () => {
        document.getElementById('add-world-book-modal').style.display = 'none';
    });
    document.getElementById('save-world-book-btn').addEventListener('click', async () => {
        const name = document.getElementById('book-name-input').value.trim();
        const content = document.getElementById('book-content-input').value.trim();
        if (!name || !content) return alert('请填写书名和内容');
        if (editingBookId) {
            const book = state.worldBooks.find(b => b.id === editingBookId);
            if (book) {
                book.name = name;
                book.content = content;
                await kokoMemory.put('worldBooks', book);
            }
        } else {
            const newBook = {
                id: 'book_' + Date.now(),
                name,
                content
            };
            state.worldBooks.push(newBook);
            await kokoMemory.put('worldBooks', newBook);
        }
        await renderWorldBooks();
        await updateWorldBookSelectors();
        document.getElementById('add-world-book-modal').style.display = 'none';
    });
    document.getElementById('add-user-persona-preset-btn').addEventListener('click', () => {
        editingUserPersonaId = null;
        document.getElementById('user-persona-modal-title').textContent = '添加用户面具预设';
        document.getElementById('user-persona-name-input').value = '';
        document.getElementById('user-persona-description-input').value = '';
        document.getElementById('user-persona-preset-modal').style.display = 'flex';
    });
    document.getElementById('close-user-persona-preset-modal').addEventListener('click', () => {
        document.getElementById('user-persona-preset-modal').style.display = 'none';
    });
    document.getElementById('save-user-persona-preset-btn').addEventListener('click', async () => {
        const name = document.getElementById('user-persona-name-input').value.trim();
        const description = document.getElementById('user-persona-description-input').value.trim();
        if (!name || !description) return alert('请填写面具名称和描述！');
        if (editingUserPersonaId) {
            const preset = state.userPersonaPresets.find(p => p.id === editingUserPersonaId);
            if (preset) {
                preset.name = name;
                preset.description = description;
                await kokoMemory.put('userPersonaPresets', preset);
            }
        } else {
            const newPreset = {
                id: 'user_persona_' + Date.now(),
                name,
                description
            };
            state.userPersonaPresets.push(newPreset);
            await kokoMemory.put('userPersonaPresets', newPreset);
        }
        await renderUserPersonaPresets();
        document.getElementById('user-persona-preset-modal').style.display = 'none';
    });
    document.getElementById('add-thought-preset-btn').addEventListener('click', () => {
        editingThoughtPresetId = null;
        document.getElementById('thought-preset-modal-title').textContent = '添加思维预设';
        document.getElementById('thought-preset-name-input').value = '';
        document.getElementById('thought-preset-prompt-input').value = '';
        document.getElementById('thought-preset-modal').style.display = 'flex';
    });
    document.getElementById('close-thought-preset-modal').addEventListener('click', () => {
        document.getElementById('thought-preset-modal').style.display = 'none';
    });
    document.getElementById('save-thought-preset-btn').addEventListener('click', async () => {
        const name = document.getElementById('thought-preset-name-input').value.trim();
        const prompt = document.getElementById('thought-preset-prompt-input').value.trim();
        if (!name || !prompt) return alert('请填写预设名称和指令！');
        if (editingThoughtPresetId) {
            const preset = state.thoughtPresets.find(p => p.id === editingThoughtPresetId);
            if (preset) {
                preset.name = name;
                preset.prompt = prompt;
                await kokoMemory.put('thoughtPresets', preset);
            }
        } else {
            const newPreset = {
                id: `tp_${Date.now()}`,
                name,
                prompt
            };
            state.thoughtPresets.push(newPreset);
            await kokoMemory.put('thoughtPresets', newPreset);
        }
        await renderThoughtPresets();
        document.getElementById('thought-preset-modal').style.display = 'none';
    });
    document.getElementById('add-emoticon-btn').addEventListener('click', () => {
        const modal = document.getElementById('add-emoticon-modal');
        const modalBody = modal.querySelector('.modal-body');
        modal.querySelector('#close-emoticon-modal').addEventListener('click', () => modal.style.display = 'none');
        modal.querySelector('.modal-title').textContent = '批量添加表情包';
        modalBody.innerHTML = `<div class="form-group"><label class="form-label">表情包列表 (每行一个)</label><textarea class="form-textarea" id="emoticon-batch-input" placeholder="支持格式:\n1. URL\n2. 名字 URL\n3. URL 名字" style="height: 180px;"></textarea></div><button class="form-button" id="save-emoticon-batch-btn">导入表情</button>`;
        modal.style.display = 'flex';
        const saveBtn = document.getElementById('save-emoticon-batch-btn');
        const newSaveBtn = saveBtn.cloneNode(true);
        saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
        newSaveBtn.addEventListener('click', async () => {
            const text = document.getElementById('emoticon-batch-input').value.trim();
            if (!text) return;
            const lines = text.split('\n');
            const newEmoticons = [];
            let importedCount = 0;
            lines.forEach((line, index) => {
                line = line.trim();
                if (!line) return;
                const parts = line.split(/\s+/);
                let url = '',
                    name = '';
                const urlIndex = parts.findIndex(p => p.startsWith('http'));
                if (urlIndex !== -1) {
                    url = parts[urlIndex];
                    parts.splice(urlIndex, 1);
                    name = parts.join(' ').trim();
                } else {
                    return;
                }
                if (!name) {
                    name = `表情${state.emoticons.length + newEmoticons.length + 1}`;
                }
                newEmoticons.push({
                    id: `emo_${Date.now()}_${index}`,
                    name,
                    url
                });
                importedCount++;
            });
            if (newEmoticons.length > 0) {
                state.emoticons = [...state.emoticons, ...newEmoticons];
                await kokoMemory.bulkPut('emoticons', newEmoticons);
                await renderEmoticonLibrary();
            }
            modal.style.display = 'none';
            alert(`成功导入 ${importedCount} 个表情包！`);
        });
    });
    // ▼▼▼ 这是全新的“添加/编辑歌曲”逻辑 (修正版) ▼▼▼
            document.getElementById('add-music-btn').addEventListener('click', () => {
                const modal = document.getElementById('add-music-modal');
                // 重置表单
                document.getElementById('add-music-modal-title').textContent = '添加歌曲';
                document.getElementById('add-music-title-input').value = '';
                document.getElementById('add-music-artist-input').value = '';
                document.getElementById('add-music-url-input').value = '';
                document.getElementById('add-music-lrc-input').value = '';
                modal.style.display = 'flex';

                // 移除旧的事件监听器，防止重复绑定
                const oldSaveBtn = document.getElementById('save-music-btn');
                const newSaveBtn = oldSaveBtn.cloneNode(true); // <-- 已修正
                oldSaveBtn.parentNode.replaceChild(newSaveBtn, oldSaveBtn); // <-- 已修正

                // 为新的保存按钮添加事件
            newSaveBtn.addEventListener('click', async () => {
                const title = document.getElementById('add-music-title-input').value.trim();
                const artist = document.getElementById('add-music-artist-input').value.trim();
                const url = document.getElementById('add-music-url-input').value.trim();
                let lrcInput = document.getElementById('add-music-lrc-input').value.trim();
                
                let finalLrc = lrcInput;
                // 智能解析逻辑
                if (lrcInput.startsWith('{') && lrcInput.endsWith('}')) {
                    try {
                        const parsedData = JSON.parse(lrcInput);
                        if (parsedData && parsedData.lrc && parsedData.lrc.lyric) {
                            finalLrc = parsedData.lrc.lyric;
                            console.log("成功从JSON中提取LRC歌词！");
                        }
                    } catch (e) {
                        console.log("尝试解析歌词JSON失败，将按原文处理。");
                    }
                }

                // ▼▼▼ 在这里添加关键的修复代码 ▼▼▼
                // 将文本 "\\n" 替换为真正的换行符 "\n"
                finalLrc = finalLrc.replace(/\\n/g, '\n');
                // ▲▲▲ 修复代码结束 ▲▲▲

                if (!title || !artist || !url) {
                    alert('歌曲名、歌手和URL是必填项！');
                    return;
                }

                const newSong = {
                    id: `music_${Date.now()}`,
                    title,
                    artist,
                    url,
                    lrc: finalLrc // 使用处理后的歌词
                };

                state.musicLibrary.push(newSong);
                await kokoMemory.put('musicLibrary', newSong);
                await renderMusicLibrary();
                
                modal.style.display = 'none';
                alert(`歌曲“${title}”已成功添加到音乐库！`);
            });
            });

            document.getElementById('close-add-music-modal').addEventListener('click', () => {
                document.getElementById('add-music-modal').style.display = 'none';
            });
    document.getElementById('emoji-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        const emoticonPicker = document.getElementById('emoticon-picker');
        document.getElementById('attachment-menu').classList.remove('active');
        emoticonPicker.classList.toggle('active');
        if (emoticonPicker.classList.contains('active')) {
            renderEmoticonPicker();
        }
    });
    document.getElementById('attachment-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('emoticon-picker').classList.remove('active');
        document.getElementById('attachment-menu').classList.toggle('active');
    });
    document.getElementById('attachment-menu').addEventListener('click', (e) => {
        const menuItem = e.target.closest('.attachment-menu-item');
        if (menuItem) {
            const action = menuItem.dataset.action;
            if (action) {
                handleAttachmentAction(action);
            }
        }
    });
    document.body.addEventListener('click', () => {
        document.getElementById('emoticon-picker').classList.remove('active');
        document.getElementById('attachment-menu').classList.remove('active');
    });
    document.getElementById('chat-screen').addEventListener('click', (e) => {
        if (!e.target.closest('#emoji-btn') && !e.target.closest('#emoticon-picker')) {
            document.getElementById('emoticon-picker').classList.remove('active');
        }
        if (!e.target.closest('#attachment-btn') && !e.target.closest('#attachment-menu')) {
            document.getElementById('attachment-menu').classList.remove('active');
        }
    });

    // --- 核心修改：聊天消息区的总事件代理 ---
    // --- 请将下面这个【完整代码块】粘贴到 attachEventListeners 函数中 ---

    // --- 【最终正确且完整的】chat-messages 点击事件监听器 ---
    document.getElementById('chat-messages').addEventListener('click', async (e) => {
        const contact = state.contacts.find(c => c.id === state.activeChatId);
        if (!contact) return;

        const replyBtn = e.target.closest('.reply-btn');
        const quoteBox = e.target.closest('.message-quote');
        const clickedWrapper = e.target.closest('.message-wrapper');
        
        // 逻辑1：如果点击的是“回复”按钮
        if (replyBtn) {
            e.stopPropagation();
            const msgId = replyBtn.closest('.message-wrapper').dataset.messageId;
            const msgToReply = contact.history.find(m => m.id === msgId);
            
            if (msgToReply) {
                let contentToQuote = msgToReply.content;
                 if (msgToReply.type === 'voice') contentToQuote = '[语音] ' + msgToReply.content.text;
                else if (msgToReply.type === 'picture_description') contentToQuote = '[图片]';
                else if (msgToReply.type === 'red_packet') contentToQuote = '[红包] ' + msgToReply.content.blessing;
                else if (msgToReply.type !== 'text') contentToQuote = `[${msgToReply.type}]`;

                activeReplyTarget = { ...msgToReply, content: contentToQuote.substring(0, 100) };
                showReplyPreview(activeReplyTarget);
                document.getElementById('message-input').focus();
            }
            return;
        }

        // 逻辑2：如果点击的是“引用消息框”以跳转
        if (quoteBox) {
            e.stopPropagation();
            const quotedId = quoteBox.dataset.quotedId;
            const targetMessage = document.querySelector(`.message-wrapper[data-message-id="${quotedId}"]`);
            if (targetMessage) {
                targetMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                targetMessage.classList.add('highlighted');
                setTimeout(() => targetMessage.classList.remove('highlighted'), 1500);
            } else {
                alert('原始消息已不在当前加载的聊天记录中。');
            }
            return;
        }

        // 逻辑3：如果点击的是消息气泡本身 (不是任何按钮)，则显示/隐藏回复按钮
        if (clickedWrapper) {
            document.querySelectorAll('.message-wrapper.show-reply-btn').forEach(wrapper => {
                if (wrapper !== clickedWrapper) {
                    wrapper.classList.remove('show-reply-btn');
                }
            });
            clickedWrapper.classList.toggle('show-reply-btn');
        }

        // 逻辑4：处理您文件中所有【原有】的点击交互（红包、音乐等）
        if (editModeState.active) return;
        
        const postShareCard = e.target.closest('.post-share-card');
        if (postShareCard) {
            const postId = postShareCard.dataset.postId;
            showPostDetailScreen(postId);
            return;
        }

        const wrapper = e.target.closest('.message-wrapper');
        if (!wrapper) return;
        const msgId = wrapper.dataset.messageId;
        const msg = contact.history.find(m => m.id === msgId);
        if (!msg) return;
        
        const spinButton = e.target.closest('.spin-btn');
        if (spinButton) {
            e.stopPropagation();
            if (msg && msg.type === 'game_wheel') {
                const player = spinButton.dataset.player;
                if (player === 'user' && !msg.content.results.user) {
                    const wheel = msg.content;
                    const weightedOptions = wheel.options.flatMap(opt => Array(opt.weight).fill(opt.text));
                    const result = weightedOptions[Math.floor(Math.random() * weightedOptions.length)];
                    msg.content.results.user = result;
                    await kokoMemory.put('contacts', contact);
                    await openChat(contact.id);
                    const systemInstruction = `[SYSTEM: 在“${wheel.name}”游戏中，我转出的结果是“${result}”。现在轮到你了，请使用 [spin_wheel:1] 指令来转动你的转盘。]`;
                    await createAndAddMessage({ type: 'text', content: systemInstruction }, 'system_instruction');
                }
            }
            return; 
        }

        if (msg.type === 'music_share') {
            const card = wrapper.querySelector('.music-share-card');
            if (!card) return;
            state.musicSessionContactId = state.activeChatId;
            if (e.target.closest('.music-card-play-btn')) {
                e.stopPropagation();
                if (currentlyPlayingMsgId !== msg.id || globalAudioPlayer.paused) {
                    if (currentlyPlayingMsgId !== msg.id) {
                        globalAudioPlayer.src = msg.content.url;
                        currentlyPlayingMsgId = msg.id;
                        const songIndex = contact.sharedPlaylist.tracks.findIndex(t => t.url === msg.content.url && t.title === msg.content.title);
                        if (songIndex !== -1) {
                           contact.sharedPlaylist.currentIndex = songIndex;
                           switchSong(songIndex, false); 
                        }
                    }
                    globalAudioPlayer.play().catch(err => {
                        console.error("音频播放失败:", err);
                        alert("无法播放此音频链接。");
                    });
                } 
                else {
                    globalAudioPlayer.pause();
                }
            } 
            else {
                openMusicPlayer();
                const songIndex = contact.sharedPlaylist.tracks.findIndex(t => t.url === msg.content.url && t.title === msg.content.title);
                if (songIndex !== -1) {
                    switchSong(songIndex);
                } else {
                    contact.sharedPlaylist.tracks.unshift(msg.content);
                    kokoMemory.put('contacts', contact);
                    switchSong(0);
                }
            }
            return; 
        }
        
        const transcribedTextEl = wrapper.querySelector('.transcribed-text');
        if (msg.type === 'voice' || msg.type === 'picture_description') {
            const textToShow = msg.type === 'voice' ? msg.content.text : msg.content.description;
            document.querySelectorAll('.transcribed-text.visible').forEach(el => {
                if (el !== transcribedTextEl) {
                    el.classList.remove('visible');
                    el.textContent = '';
                }
            });
            if (transcribedTextEl.classList.contains('visible')) {
                transcribedTextEl.classList.remove('visible');
                transcribedTextEl.textContent = '';
            } else {
                transcribedTextEl.textContent = textToShow;
                transcribedTextEl.classList.add('visible');
            }
        } else if (msg.type === 'red_packet') {
            showRedPacketModal(msg, contact);
        } else if (msg.type === 'transfer') {
            showTransferModal(msg, contact);
        }
    });

    // 新增：点击聊天屏幕的其他地方，隐藏所有回复按钮
    document.getElementById('chat-screen').addEventListener('click', (e) => {
        if (!e.target.closest('.message-wrapper')) {
            document.querySelectorAll('.message-wrapper.show-reply-btn').forEach(wrapper => {
                wrapper.classList.remove('show-reply-btn');
            });
        }
    });

    // --- V9.0 新增: 播放器内部按钮事件 ---
    document.getElementById('player-play-btn').addEventListener('click', () => {
        if (globalAudioPlayer.paused) globalAudioPlayer.play();
        else globalAudioPlayer.pause();
    });
    document.getElementById('player-collapse-btn').addEventListener('click', () => {
        card.classList.toggle('collapsed');
        document.getElementById('player-collapse-btn').classList.toggle('fa-chevron-down');
        document.getElementById('player-collapse-btn').classList.toggle('fa-chevron-up');
    });
    // ▼▼▼ 在这里添加新的事件监听 ▼▼▼
    document.getElementById('player-close-btn').addEventListener('click', closeMusicPlayer);
    document.getElementById('player-playlist-btn').addEventListener('click', () => {
        document.getElementById('player-playlist-view').classList.toggle('active');
    });
    document.getElementById('player-mode-btn').addEventListener('click', () => {
        const contact = state.contacts.find(c => c.id === state.activeChatId);
        if (!contact) return;
        const modes = ['repeat-all', 'repeat-one', 'off'];
        const icons = ['fa-repeat', 'fa-1', 'fa-power-off'];
        const titles = ['列表循环', '单曲循环', '播放完暂停'];
        let currentIndex = modes.indexOf(contact.sharedPlaylist.playbackMode || 'repeat-all');
        currentIndex = (currentIndex + 1) % modes.length;
        contact.sharedPlaylist.playbackMode = modes[currentIndex];
        const modeBtn = document.getElementById('player-mode-btn');
        modeBtn.className = `fas ${icons[currentIndex]} player-control-btn`;
        modeBtn.title = titles[currentIndex];
        kokoMemory.put('contacts', contact);
    });
    document.getElementById('player-next-btn').addEventListener('click', () => switchSong(currentSongIndex + 1, true, true));
document.getElementById('player-prev-btn').addEventListener('click', () => switchSong(currentSongIndex - 1, true, true));
    document.getElementById('player-progress-bar').addEventListener('click', function(e) {
        if (globalAudioPlayer.duration) {
            const rect = this.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            globalAudioPlayer.currentTime = (clickX / rect.width) * globalAudioPlayer.duration;
        }
    });

    document.getElementById('close-send-picture-modal').addEventListener('click', () => {
        document.getElementById('send-picture-modal').style.display = 'none';
    });
    document.getElementById('close-send-voice-modal').addEventListener('click', () => {
        document.getElementById('send-voice-modal').style.display = 'none';
    });
    document.getElementById('close-send-red-packet-modal').addEventListener('click', () => {
        document.getElementById('send-red-packet-modal').style.display = 'none';
    });
    document.getElementById('close-send-transfer-modal').addEventListener('click', () => {
        document.getElementById('send-transfer-modal').style.display = 'none';
    });
    document.getElementById('close-send-music-modal').addEventListener('click', () => {
        document.getElementById('send-music-modal').style.display = 'none';
    });

   // --- 新增：为红包详情弹窗的关闭按钮绑定事件 --- 
   document.getElementById('close-red-packet-details-modal').addEventListener('click', () => { document.getElementById('red-packet-details-modal').style.display = 'none'; });
    
      // --- 原有功能：论坛事件 ---
    document.getElementById('feed-tabs-container').addEventListener('click', (e) => {
        if (e.target.classList.contains('feed-tab-btn')) {
            state.activeFeedTab = e.target.dataset.tab;
            renderFeed();
        }
    });
    document.getElementById('feed-sub-tabs-container').addEventListener('click', (e) => {
        if (e.target.classList.contains('feed-sub-tab-btn')) {
            state.activeFeedSubTab = e.target.dataset.subtab;
            renderFeed();
        }
    });
    document.getElementById('moments-content').addEventListener('click', async (e) => {
        const repostBtn = e.target.closest('.repost-btn');
        if (repostBtn) {
            e.stopPropagation();
            openRepostModal(repostBtn.dataset.postId);
            return;
        }
        const redPacketCard = e.target.closest('.forum-red-packet-card');
        if (redPacketCard) {
            e.stopPropagation();
            openForumRedPacketModal(redPacketCard.dataset.postId);
            return;
        }
        const postItem = e.target.closest('.post-item');
        const trendingItem = e.target.closest('.trending-item');
        const deleteBtn = e.target.closest('.post-delete-btn');
        if (deleteBtn) {
            e.stopPropagation();
            const confirmed = await showCustomConfirm('删除帖子', '确定要删除这条帖子吗？', true);
            if (confirmed) {
                const postId = deleteBtn.dataset.postId;
                state.posts = state.posts.filter(p => p.id !== postId);
                await kokoMemory.delete('posts', postId);
                await renderFeed();
            }
            return;
        }
        if (postItem) {
            showPostDetailScreen(postItem.dataset.postId);
        } else if (trendingItem) {
            showTrendingTopicScreen(trendingItem.dataset.topicTitle);
        }
    });
    document.getElementById('trending-topic-screen').addEventListener('click', (e) => {
        const postItem = e.target.closest('.post-item');
        if (postItem) {
            showPostDetailScreen(postItem.dataset.postId);
        }
    });
    document.getElementById('refresh-feed-btn').addEventListener('click', async () => {
        const apiConfig = getApiFor('square');
        if (!apiConfig.apiKey || !apiConfig.endpoint) {
            alert('请先在“发现 -> 论坛API设置”中配置API。');
            return;
        }
        try {
            if (state.activeFeedTab === 'trending') {
                showFeedStatus('正在刷新热搜榜...');
                await generateRandomTrendingTopicsAI();
            } else if (state.activeFeedTab === 'recommended') {
                showFeedStatus('正在刷新推荐内容...');
                await generatePostsForRecommendedTab(5);
            } else {
                showFeedStatus('正在刷新关注内容...');
                await generatePostsForRecommendedTab(2);
            }
            await renderFeed();
        } catch (e) {
            console.error("刷新失败:", e);
            alert("刷新失败: " + e.message);
        } finally {
            hideFeedStatus();
        }
    });
    const commentInput = document.getElementById('comment-input');
    commentInput.addEventListener('blur', () => {
        if (commentInput.value.trim() === '' && activeReplyTarget) {
            activeReplyTarget = null;
            commentInput.placeholder = '留下你的精彩评论吧...';
        }
    });
    document.getElementById('submit-comment-btn').addEventListener('click', async () => {
        const input = document.getElementById('comment-input');
        const content = input.value.trim();
        if (!content) return;
        const post = state.posts.find(p => p.id === state.activePostId);
        if (post) {
            const newComment = {
                id: `comment_${Date.now()}`,
                author: {
                    id: 'myProfile',
                    name: state.myProfile.name,
                    avatar: state.myProfile.avatar
                },
                content,
                timestamp: Date.now(),
                replyTo: activeReplyTarget ? activeReplyTarget.name : null
            };
            post.comments.push(newComment);
            input.value = '';
            activeReplyTarget = null;
            input.placeholder = '留下你的精彩评论吧...';
            await kokoMemory.put('posts', post);
            await renderPostDetail();
            await triggerAiCommentDiscussion(post, newComment);
        }
    });
    document.getElementById('comments-list').addEventListener('click', async (e) => {
        const commentItem = e.target.closest('.post-comment-item');
        if (!commentItem) return;
        const deleteBtn = e.target.closest('.comment-delete-btn');
        if (deleteBtn) {
            e.stopPropagation();
            const commentId = deleteBtn.dataset.commentId;
            const confirmed = await showCustomConfirm('删除评论', '确定要删除这条评论吗？', true);
            if (confirmed) {
                const post = state.posts.find(p => p.id === state.activePostId);
                if (post) {
                    post.comments = post.comments.filter(c => c.id !== commentId);
                    await kokoMemory.put('posts', post);
                    await renderPostDetail();
                }
            }
            return;
        }
        if (!e.target.closest('a, .mention, .comment-delete-btn')) {
            const authorName = commentItem.dataset.authorName;
            const authorId = commentItem.dataset.authorId;
            if (authorId === 'myProfile') return;
            activeReplyTarget = {
                name: authorName,
                id: authorId
            };
            const commentInput = document.getElementById('comment-input');
            commentInput.placeholder = `回复 @${authorName}`;
            commentInput.focus();
        }
    });
    document.getElementById('post-moment-btn').addEventListener('click', () => {
        pendingForumRedPacket = null;
        const modal = document.getElementById('post-moment-modal');
        modal.style.display = 'flex';
        document.getElementById('moment-content-input').value = '';
        const redPacketBtn = document.getElementById('add-post-red-packet-btn');
        redPacketBtn.classList.remove('active');
        const newRedPacketBtn = redPacketBtn.cloneNode(true);
        redPacketBtn.parentNode.replaceChild(newRedPacketBtn, redPacketBtn);
        newRedPacketBtn.addEventListener('click', () => {
            const rpModal = document.getElementById('create-forum-red-packet-modal');
            rpModal.style.display = 'flex';
            document.getElementById('close-forum-red-packet-modal').onclick = () => rpModal.style.display = 'none';
            const confirmRpBtn = document.getElementById('confirm-forum-red-packet-btn');
            const newConfirmRpBtn = confirmRpBtn.cloneNode(true);
            confirmRpBtn.parentNode.replaceChild(newConfirmRpBtn, confirmRpBtn);
            newConfirmRpBtn.addEventListener('click', () => {
                const amount = parseFloat(document.getElementById('forum-red-packet-amount-input').value);
                const count = parseInt(document.getElementById('forum-red-packet-count-input').value, 10);
                if (isNaN(amount) || amount <= 0 || isNaN(count) || count <= 0) {
                    return alert('请输入有效的金额和个数');
                }
                if (amount > state.myProfile.balance) {
                    return alert('钱包余额不足！');
                }
                pendingForumRedPacket = {
                    amount,
                    count,
                    blessing: document.getElementById('forum-red-packet-blessing-input').value.trim() || '恭喜发财，大吉大利！',
                };
                newRedPacketBtn.classList.add('active');
                rpModal.style.display = 'none';
            });
        });
    });
    document.getElementById('close-post-moment-modal').addEventListener('click', () => {
        document.getElementById('post-moment-modal').style.display = 'none';
    });
    document.getElementById('publish-moment-btn').addEventListener('click', async () => {
        const content = document.getElementById('moment-content-input').value.trim();
        if (!content && !pendingForumRedPacket) return alert('请输入帖子内容或添加红包！');
        const category = document.getElementById('post-category-select').value;
        const newPost = {
            id: 'post_' + Date.now(),
            author: {
                id: 'myProfile',
                name: state.myProfile.name,
                avatar: state.myProfile.avatar,
                signature: state.myProfile.signature
            },
            content: content || (pendingForumRedPacket ? pendingForumRedPacket.blessing : ''),
            timestamp: Date.now(),
            likes: [],
            comments: [],
            reposts: 0,
            category: category
        };
        if (pendingForumRedPacket) {
            newPost.redPacket = { ...pendingForumRedPacket,
                claimers: []
            };
            state.myProfile.balance -= pendingForumRedPacket.amount;
            await addTransaction('expense', pendingForumRedPacket.amount, `在论坛中发红包`, null);
            await kokoMemory.put('myProfile', state.myProfile);
            await renderMyProfile();
        }
        state.posts.unshift(newPost);
        await kokoMemory.put('posts', newPost);
        state.activeFeedTab = 'recommended';
        state.activeFeedSubTab = category;
        await showFeedScreen();
        document.getElementById('post-moment-modal').style.display = 'none';
    });
    document.getElementById('screen').addEventListener('click', e => {
        const mentionSpan = e.target.closest('.mention');
        if (mentionSpan) {
            e.stopPropagation();
            const userName = mentionSpan.textContent.substring(1);
            alert(`Tapped on user: @${userName}`);
        }
    });
    document.getElementById('my-wallet-btn').addEventListener('click', () => {
        hideAllScreens();
        document.getElementById('wallet-screen').style.display = 'flex';
        renderWalletScreen();
    });
    document.getElementById('back-from-wallet').addEventListener('click', showProfileScreen);

    // --- ↓↓↓ 用这个新的代码块，替换掉你原来的所有 globalAudioPlayer.addEventListener(...) 代码 ↓↓↓ ---
globalAudioPlayer.addEventListener('play', () => {
    startListenTimeTracker();
    updateUI(); 
    document.getElementById('player-avatar-stack').classList.add('is-playing');

    document.querySelectorAll('.music-share-card').forEach(card => {
        const msgId = card.closest('.message-wrapper').dataset.messageId;
        if (msgId === currentlyPlayingMsgId) {
            card.querySelector('.music-card-cover').classList.add('playing');
            card.querySelector('.music-card-play-btn i').className = 'fas fa-pause';
        } else {
            card.querySelector('.music-card-cover').classList.remove('playing');
            card.querySelector('.music-card-play-btn i').className = 'fas fa-play';
        }
    });
});

globalAudioPlayer.addEventListener('pause', () => {
    stopListenTimeTracker();
    updateUI(); 
    document.getElementById('player-avatar-stack').classList.remove('is-playing');

    document.querySelectorAll('.music-share-card').forEach(card => {
        card.querySelector('.music-card-cover').classList.remove('playing');
        card.querySelector('.music-card-play-btn i').className = 'fas fa-play';
    });
});

globalAudioPlayer.addEventListener('timeupdate', () => {
    updateUI(); 
    if (currentlyPlayingMsgId) {
        const cardWrapper = document.querySelector(`.message-wrapper[data-message-id='${currentlyPlayingMsgId}']`);
        if (cardWrapper) {
            const card = cardWrapper.querySelector('.music-share-card');
            if (card && globalAudioPlayer.duration) {
                const progress = (globalAudioPlayer.currentTime / globalAudioPlayer.duration) * 100;
                card.querySelector('.music-card-progress').style.width = `${progress}%`;
                const formatTime = (s) => new Date(s * 1000).toISOString().substr(14, 5);
                card.querySelector('.music-card-time').textContent = formatTime(globalAudioPlayer.currentTime);
            }
        }
    }
});

globalAudioPlayer.addEventListener('loadedmetadata', updateUI);

globalAudioPlayer.addEventListener('ended', async () => {
    document.getElementById('player-avatar-stack').classList.remove('is-playing');
    const contact = state.contacts.find(c => c.id === state.activeChatId);
    if (!contact) return;
    const playlist = contact.sharedPlaylist;
    const mode = playlist.playbackMode || 'repeat-all';
    switch (mode) {
        case 'repeat-one':
            globalAudioPlayer.currentTime = 0;
            globalAudioPlayer.play();
            break;
        case 'repeat-all':
            switchSong(currentSongIndex + 1, true, true);
            break;
        case 'off':
            break;
    }
    await kokoMemory.put('contacts', contact);
});

// --- 新增：聊天消息长按编辑逻辑（允许编辑双方） ---
    let longPressTimer = null;
    const LONG_PRESS_DURATION = 700; // 700毫秒算作长按
    const chatMessagesContainer = document.getElementById('chat-messages');

    const startLongPress = (e) => {
        // 如果正在进行多选编辑，则禁用长按编辑
        if (editModeState.active) return;

        const wrapper = e.target.closest('.message-wrapper');
        if (!wrapper) return;

        const msgId = wrapper.dataset.messageId;
        const contact = state.contacts.find(c => c.id === state.activeChatId);
        if (!contact) return;
        
        const msg = contact.history.find(m => m.id === msgId);
        
        // 关键判断：只允许编辑纯文本类型的消息，不关心发送者是谁
        if (!msg || msg.type !== 'text') {
            return; // 如果不是文本消息（如图片、红包等），则直接返回
        }

        // 启动计时器，时间到了就执行编辑函数
        longPressTimer = setTimeout(() => {
            handleEditMessage(msgId);
        }, LONG_PRESS_DURATION);
    };

    const cancelLongPress = () => {
        // 如果在计时器触发前松开手指，则取消计时
        clearTimeout(longPressTimer);
    };

    // 为各种鼠标和触摸事件绑定监听器
    chatMessagesContainer.addEventListener('mousedown', startLongPress);
    chatMessagesContainer.addEventListener('mouseup', cancelLongPress);
    chatMessagesContainer.addEventListener('mouseleave', cancelLongPress);
    chatMessagesContainer.addEventListener('touchstart', startLongPress);
    chatMessagesContainer.addEventListener('touchend', cancelLongPress);
    chatMessagesContainer.addEventListener('touchcancel', cancelLongPress);

// ↓↓↓ 把这段新代码粘贴到 attachEventListeners 函数的末尾 ↓↓↓

// --- 游戏转盘弹窗逻辑 ---
document.getElementById('close-create-wheel-modal').addEventListener('click', () => {
    document.getElementById('create-wheel-modal').style.display = 'none';
});

document.getElementById('add-wheel-option-btn').addEventListener('click', () => addWheelOptionInput());

document.getElementById('confirm-send-wheel-btn').addEventListener('click', async () => {
    const wheelName = document.getElementById('wheel-name-input').value.trim();
    if (!wheelName) {
        return alert('请给你的转盘起个名字！');
    }

    const options = [];
    const optionElements = document.querySelectorAll('.wheel-option-item');
    for (const el of optionElements) {
        const text = el.querySelector('.wheel-option-text').value.trim();
        const weight = parseInt(el.querySelector('.wheel-option-weight').value, 10) || 1;
        if (text) {
            options.push({ text, weight });
        }
    }

    if (options.length < 2) {
        return alert('转盘至少需要2个有效的选项！');
    }

    await createAndAddMessage({
        type: 'game_wheel',
        content: {
            id: `wheel_${Date.now()}`,
            name: wheelName,
            options: options,
            results: { // 存储用户和AI的结果
                user: null, // 'user' 代表玩家自己
                contact: null // 'contact' 代表对方
            }
        }
    });

});
// ↑↑↑ 新增代码结束 ↑↑↑
// --- ▼▼▼ 新增：视频通话界面的事件绑定 ▼▼▼ ---
document.getElementById('hang-up-btn').addEventListener('click', () => {
    endVideoCall('user');
});

document.getElementById('video-call-send-btn').addEventListener('click', sendVideoCallMessage);

document.getElementById('video-call-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendVideoCallMessage();
    }
});
// ... 在 attachEventListeners() 函数内部 ...

// --- 外观设置页面的事件绑定 (自由定制版) ---
document.getElementById('appearance-settings-btn').addEventListener('click', () => {
    // 打开设置页面前，先用已保存的设置填充输入框
    document.getElementById('bubble-css-input').value = userSettings.customBubbleCss || '';
    document.getElementById('font-url-input').value = userSettings.customFontUrl || '';
    document.getElementById('font-name-input').value = userSettings.customFontName || '';
    
    hideAllScreens();
    document.getElementById('appearance-settings-screen').style.display = 'flex';
});

document.getElementById('back-from-appearance-settings').addEventListener('click', showProfileScreen);

// 背景上传按钮
document.getElementById('upload-background-btn').addEventListener('click', () => {
    document.getElementById('background-file-input').click();
});

// 背景文件选择后的处理
document.getElementById('background-file-input').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (file.size > 5 * 1024 * 1024) { // 限制5MB大小
        alert('图片文件不能超过 5MB');
        return;
    }

    const reader = new FileReader();
    reader.onload = (event) => {
        const base64String = event.target.result;
        userSettings.chatBackground = base64String; // 实时保存到变量
        document.getElementById('chat-screen').style.backgroundImage = `url(${base64String})`;
        alert('背景已更新，点击“应用并保存”来永久保存。');
    };
    reader.readAsDataURL(file);
    e.target.value = ''; // 清空input，以便可以再次选择同一个文件
});

// 恢复默认背景按钮
document.getElementById('reset-background-btn').addEventListener('click', () => {
    userSettings.chatBackground = null;
    applyAppearanceSettings(); // 立即应用默认样式
    alert('背景已恢复默认，点击“应用并保存”来永久保存。');
});

// 保存外观设置按钮
document.getElementById('save-appearance-btn').addEventListener('click', saveAppearanceSettings);
}
attachEventListeners();
await initApp();
}); 
</script>
</body>
</html>